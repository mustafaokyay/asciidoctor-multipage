<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Java</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
</head>
<body id="security" class="article">
<div id="header">
<h1>Java</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="security">3. Security</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Often you need to have passwords (for databases, third-party services, etc.) as part of your configuration. These are typically environment specific (see above). However, with DevOps and continuous-deployment you might be tempted to commit such configurations into your version-control (e.g. <code>git</code>). Doing that with plain text passwords is a severe problem especially for production systems. Never do that! Instead we offer some suggestions how to deal with sensible configurations:</p>
</div>
<div class="sect2">
<h3 id="password-encryption">3.1. Password Encryption</h3>
<div class="paragraph">
<p>A simple but reasonable approach is to configure the passwords encrypted with a master-password. The master-password should be a strong secret that is specific for each environment. It must never be committed to version-control.</p>
</div>
<div class="paragraph">
<p>For <a href="spring.asciidoc">Spring</a>, we use <a href="https://github.com/ulisesbocchio/jasypt-spring-boot#jasypt-spring-boot">jasypt-spring-boot</a>. For more details, see <a href="spring/guide-spring-configuration.asciidoc#password-encryption">here</a></p>
</div>
<div class="paragraph">
<p>For <a href="quarkus.asciidoc">Quarkus</a>, see <a href="quarkus/guide-quarkus-configuration.asciidoc#password-encryption">here</a></p>
</div>
<div class="sect3">
<h4 id="is-this-security-by-obscurity">3.1.1. Is this Security by Obscurity?</h4>
<div class="ulist">
<ul>
<li>
<p>Yes, from the point of view to protect the passwords on the target environment this is nothing but security by obscurity. If an attacker somehow got full access to the machine this will only cause him to spend some more time.</p>
</li>
<li>
<p>No, if someone only gets the configuration file. So all your developers might have access to the version-control where the config is stored. Others might have access to the software releases that include this configs. But without the master-password that should only be known to specific operators none else can decrypt the password (except with brute-force what will take a very long time, see jasypt for details).</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="coding-conventions">3.2. Coding Conventions</h3>
<div class="paragraph">
<p>The code should follow general conventions for Java (see <a href="http://www.oracle.com/technetwork/java/namingconventions-139351.html">Oracle Naming Conventions</a>, <a href="https://google.github.io/styleguide/javaguide.html">Google Java Style</a>, etc.).We consider this as common sense and provide configurations for <a href="http://www.sonarqube.org/">SonarQube</a> and related tools such as <a href="http://checkstyle.sourceforge.net/">Checkstyle</a> instead of repeating this here.</p>
</div>
<div class="sect3">
<h4 id="naming">3.2.1. Naming</h4>
<div class="paragraph">
<p>Besides general Java naming conventions, we follow the additional rules listed here explicitly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Always use short but speaking names (for types, methods, fields, parameters, variables, constants, etc.).</p>
</li>
<li>
<p>Strictly avoid special characters in technical names (for files, types, fields, methods, properties, variables, database tables, columns, constraints, etc.). In other words only use Latin alpahnumeric ASCII characters with the common allowed technical separators for the accordign context (e.g. underscore) for technical names (even excluding whitespaces).</p>
</li>
<li>
<p>For package segments and type names prefer singular forms (<code>CustomerEntity</code> instead of <code class="line-through">CustomersEntity</code>). Only use plural forms when there is no singular or it is really semantically required (e.g. for a container that contains multiple of such objects).</p>
</li>
<li>
<p>Avoid having duplicate type names. The name of a class, interface, enum or annotation should be unique within your project unless this is intentionally desired in a special and reasonable situation.</p>
</li>
<li>
<p>Avoid artificial naming constructs such as prefixes (<code>I*</code>) or suffixes (<code>*IF</code>) for interfaces.</p>
</li>
<li>
<p>Use CamelCase even for abbreviations (<code>XmlUtil</code> instead of <code class="line-through">XMLUtil</code>)</p>
</li>
<li>
<p>Avoid property/field names where the second character is upper-case at all (e.g. 'aBc'). See <a href="https://github.com/devonfw/cobigen/issues/1095">#1095</a> for details.</p>
</li>
<li>
<p>Names of Generics should be easy to understand. Where suitable follow the common rule <code>E=Element</code>, <code>T=Type</code>, <code>K=Key</code>, <code>V=Value</code> but feel free to use longer names for more specific cases such as <code>ID</code>, <code>DTO</code> or <code>ENTITY</code>. The capitalized naming helps to distinguish a generic type from a regular class.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="packages">3.2.2. Packages</h4>
<div class="paragraph">
<p>Java Packages are the most important element to structure your code. We use a strict packaging convention to map technical layers and business components (slices) to the code (See <a href="architecture.asciidoc#technical-architecture">technical architecture</a> for further details). By using the same names in documentation and code we create a strong link that gives orientation and makes it easy to find from business requirements, specifications or story tickets into the code and back.</p>
</div>
<div class="paragraph">
<p>For an devon4j based application we use the following Java-Package schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>«root».«component».«layer»[.«detail»]</code></pre>
</div>
</div>
<div class="paragraph">
<p>E.g. in our example application we find the Spring Data repositories for the <code>ordermanagement</code> component in the package <code>com.devonfw.application.mtsj.ordermanagement.dataaccess.api.repo</code></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Segments of package schema</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Segment</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">«root»</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Is the basic Java Package name-space of your app. Typically we suggest to use <code>«group».«artifact»</code> where <code>«group»</code> is your maven/gradle <code>groupId</code> corresponding to your organization or IT project owning the code following common Java Package conventions. The segment <code>«artifact»</code> is your maven/gradle <code>artifactId</code> and is typically the technical name of your app.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.devonfw.application.mtsj</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">«component»</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The (business) component the code belongs to. It is defined by the business architecture and uses terms from the business domain. Use the implicit component <code>general</code> for code not belonging to a specific component (foundation code).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>salesmanagement</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">«layer»</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the technical layer (See <a href="architecture.asciidoc">technical architecture</a>). Details are described for the <a href="guide-structure-modern.asciidoc#layers">modern project structure</a> and for the <a href="guide-structure-classic.asciidoc#layers">classic project structure</a>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>logic</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">«detail»</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Here you are free to further divide your code into sub-components and other concerns according to the size of your component part. If you want to strictly separate API from implementation you should start <code>«detail»</code> with <code>«scope»</code> that is explained below.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dao</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">«scope»</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The scope which is one of <code>api</code> (official API to be used by other layers or components), <code>base</code> (basic code to be reused by other implementations) and <code>impl</code> (implementation that should never be imported from outside). This segment was initially mandatory but due to trends such as microservices, lean, and agile we decided to make it optional and do not force anybody to use it.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>api</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Please note that <code>devon4j</code> library modules for spring use <code>com.devonfw.module</code> as <code>«root»</code> and the name of the module as <code>«component»</code>. E.g. the API of our <code>beanmapping</code> module can be found in the package <code>com.devonfw.module.beanmapping.common.api</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="code-tasks">3.2.3. Code Tasks</h4>
<div class="paragraph">
<p>Code spots that need some rework can be marked with the following tasks tags. These are already properly pre-configured in your development environment for auto completion and to view tasks you are responsible for. It is important to keep the number of code tasks low. Therefore, every member of the team should be responsible for the overall code quality. So if you change a piece of code and hit a code task that you can resolve in a reliable way, please do this as part of your change and remove the according tag.</p>
</div>
<div class="sect4">
<h5 id="todo">TODO</h5>
<div class="paragraph">
<p>Used to mark a piece of code that is not yet complete (typically because it can not be completed due to a dependency on something that is not ready).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"> // TODO «author» «description»</code></pre>
</div>
</div>
<div class="paragraph">
<p>A TODO tag is added by the author of the code who is also responsible for completing this task.</p>
</div>
</div>
<div class="sect4">
<h5 id="fixme">FIXME</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"> // FIXME «author» «description»</code></pre>
</div>
</div>
<div class="paragraph">
<p>A FIXME tag is added by the author of the code or someone who found a bug he can not fix right now. The «author» who added the FIXME is also responsible for completing this task. This is very similar to a TODO but with a higher priority. FIXME tags indicate problems that should be resolved before a release is completed while TODO tags might have to stay for a longer time.</p>
</div>
</div>
<div class="sect4">
<h5 id="review">REVIEW</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"> // REVIEW «responsible» («reviewer») «description»</code></pre>
</div>
</div>
<div class="paragraph">
<p>A REVIEW tag is added by a reviewer during a code review. Here the original author of the code is responsible to resolve the REVIEW tag and the reviewer is assigning this task to him. This is important for feedback and learning and has to be aligned with a review "process" where people talk to each other and get into discussion. In smaller or local teams a peer-review is preferable but this does not scale for large or even distributed teams.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="code-documentation">3.2.4. Code-Documentation</h4>
<div class="paragraph">
<p>As a general goal, the code should be easy to read and understand. Besides, clear naming the documentation is important. We follow these rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>APIs (especially component interfaces) are properly documented with JavaDoc.</p>
</li>
<li>
<p>JavaDoc shall provide actual value - we do not write JavaDoc to satisfy tools such as checkstyle but to express information not already available in the signature.</p>
</li>
<li>
<p>We make use of <code>{@link}</code> tags in JavaDoc to make it more expressive.</p>
</li>
<li>
<p>JavaDoc of APIs describes how to use the type or method and not how the implementation internally works.</p>
</li>
<li>
<p>To document implementation details, we use code comments (e.g. <code>// we have to flush explicitly to ensure version is up-to-date</code>). This is only needed for complex logic.</p>
</li>
<li>
<p>Avoid the pointless <code>{@inheritDoc}</code> as since Java 1.5 there is the <code>@Override</code> annotation for overridden methods and your JavaDoc is inherited automatically even without any JavaDoc comment at all.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="code-style">3.2.5. Code-Style</h4>
<div class="paragraph">
<p>This section gives you best practices to write better code and avoid pitfalls and mistakes.</p>
</div>
<div class="sect4">
<h5 id="blobs">BLOBs</h5>
<div class="paragraph">
<p>Avoid using <code>byte[]</code> for BLOBs as this will load them entirely into your memory. This will cause performance issues or out of memory errors. Instead, use streams when dealing with BLOBs. For further details see <a href="guide-blob-support.asciidoc">BLOB support</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="stateless-programming">Stateless Programming</h5>
<div class="paragraph">
<p>When implementing logic as components or <em>beans</em> of your container using <a href="guide-dependency-injection.asciidoc">dependency injection</a>, we strongly encourage stateless programming.
This is not about data objects like an <a href="guide-jpa.asciidoc#entity">entity</a> or <a href="guide-transferobject.asciidoc">transfer-object</a> that are stateful by design.
Instead this applies to all classes annotated with <code>@Named</code>, <code>@ApplicationScoped</code>, <code>@Stateless</code>, etc. and all their super-classes.
These classes especially include your <a href="guide-repository.asciidoc">repositories</a>, <a href="guide-usecase.asciidoc">use-cases</a>, and <a href="guide-rest.asciidoc#jax-rs">REST services</a>.
Such classes shall never be modified after initialization.
Methods called at runtime (after initialization via the container) do not assign fields (member variables of your class) or mutate the object stored in a field.
This allows your component or bean to be stateless and thread-safe.
Therefore it can be initialized as a singleton so only one instance is created and shared accross all threads of the application.
Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
@Named
public class UcApproveContractImpl implements UcApproveContract {

  // bad
  private String contractOwner;

  private MyState state;

  @Overide
  public void approve(Contract contract) {
    this.contractOwner = contract.getOwner();
    this.contractOwner = this.contractOwner.toLowerCase(Locale.US);
    this.state.setAdmin(this.contractOwner.endsWith("admin"));
    if (this.state.isAdmin()) {
      ...
    } else {
      ...
    }
  }

  // fine
  @Overide
  public void approveContract(Contract contract) {
    String contractOwner = contract.getOwner().toLowerCase(Locale.US);
    if (contractOwner.endsWith("admin")) {
      ...
    } else {
      ...
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in the <code>bad</code> code fields of the class are assigned when the method <code>approve</code> is called.
So mutliple users and therefore threads calling this method concurrently can interfere and override this state causing side-effects on parallel threads.
This will lead to nasty bugs and errors that are hard to trace down.
They will not occur in simple tests but for sure in production with real users.
Therefore <strong>never</strong> do this and implement your functionality stateless.
That is keeping all state in local variables and strictly avoid modifying fields or their value as illustrated in the <code>fine</code> code.
If you find yourself passing many parameters between methods that all represent state, you can easily create a separate class that encapsulates this state.
However, then you need to create this state object in your method as local variable and pass it between methods as parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
@Named
public class UcApproveContractImpl implements UcApproveContract {

  // fine
  @Overide
  public void approveContract(Contract contract) {
    String contractOwner = contract.getOwner().toLowerCase(Locale.US);
    MyState state = new MyState();
    state.setAdmin(this.contractOwner.endsWith("admin"));
    doApproveContract(contract, state);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="closing-resources">Closing Resources</h5>
<div class="paragraph">
<p>Resources such as streams (<code>InputStream</code>, <code>OutputStream</code>, <code>Reader</code>, <code>Writer</code>) or transactions need to be handled properly. Therefore, it is important to follow these rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each resource has to be closed properly, otherwise you will get out of file handles, TX sessions, memory leaks or the like</p>
</li>
<li>
<p>Where possible avoid to deal with such resources manually. That is why we are recommending <code>@Transactional</code> for transactions in devonfw (see <a href="guide-transactions.asciidoc">Transaction Handling</a>).</p>
</li>
<li>
<p>In case you have to deal with resources manually (e.g. binary streams) ensure to close them properly. See the example below for details.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Closing streams and other such resources is error prone. Have a look at the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// bad
try {
  InputStream in = new FileInputStream(file);
  readData(in);
  in.close();
} catch (IOException e) {
  throw new IllegalStateException("Failed to read data.", e);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code above is wrong as in case of an <code>IOException</code> the <code>InputStream</code> is not properly closed. In a server application such mistakes can cause severe errors that typically will only occur in production. As such resources implement the <code>AutoCloseable</code> interface you can use the <code>try-with-resource</code> syntax to write correct code. The following code shows a correct version of the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// fine
try (InputStream in = new FileInputStream(file)) {
  readData(in);
} catch (IOException e) {
  throw new IllegalStateException("Failed to read data.", e);
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="catching-and-handling-exceptions">Catching and handling Exceptions</h5>
<div class="paragraph">
<p>When catching exceptions always ensure the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Never call <code>printStackTrace()</code> method on an exception</p>
</li>
<li>
<p>Either log or wrap and re-throw the entire catched exception. Be aware that the cause(s) of an exception is very valuable information. If you loose such information by improper exception-handling you may be unable to properly analyse production problems what can cause severe issues.</p>
<div class="ulist">
<ul>
<li>
<p>If you wrap and re-throw an exception ensure that the catched exception is passed as cause to the newly created and thrown exception.</p>
</li>
<li>
<p>If you log an exception ensure that the entire exception is passed as argument to the logger (and not only the result of <code>getMessage()</code> or <code>toString()</code> on the exception).</p>
</li>
</ul>
</div>
</li>
<li>
<p>See <a href="guide-exceptions.asciidoc#handling-exceptions">exception handling</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="lambdas-and-streams">Lambdas and Streams</h5>
<div class="paragraph">
<p>With Java8 you have cool new features like lambdas and monads like (<code>Stream</code>, <code>CompletableFuture</code>, <code>Optional</code>, etc.).
However, these new features can also be misused or led to code that is hard to read or debug. To avoid pain, we give you the following best practices:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Learn how to use the new features properly before using. Developers are often keen on using cool new features. When you do your first experiments in your project code you will cause deep pain and might be ashamed afterwards. Please study the features properly. Even Java8 experts still write for loops to iterate over collections, so only use these features where it really makes sense.</p>
</li>
<li>
<p>Streams shall only be used in fluent API calls as a Stream can not be forked or reused.</p>
</li>
<li>
<p>Each stream has to have exactly one terminal operation.</p>
</li>
<li>
<p>Do not write multiple statements into lambda code:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// bad
collection.stream().map(x -&gt; {
Foo foo = doSomething(x);
...
return foo;
}).collect(Collectors.toList());</code></pre>
</div>
</div>
<div class="paragraph">
<p>This style makes the code hard to read and debug. Never do that! Instead, extract the lambda body to a private method with a meaningful name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// fine
collection.stream().map(this::convertToFoo).collect(Collectors.toList());</code></pre>
</div>
</div>
</li>
<li>
<p>Do not use <code>parallelStream()</code> in general code (that will run on server side) unless you know exactly what you are doing and what is going on under the hood. Some developers might think that using parallel streams is a good idea as it will make the code faster. However, if you want to do performance optimizations talk to your technical lead (architect). Many features such as security and transactions will rely on contextual information that is associated with the current thread. Hence, using parallel streams will most probably cause serious bugs. Only use them for standalone (CLI) applications or for code that is just processing large amounts of data.</p>
</li>
<li>
<p>Do not perform operations on a sub-stream inside a lambda:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">set.stream().flatMap(x -&gt; x.getChildren().stream().filter(this::isSpecial)).collect(Collectors.toList()); // bad
set.stream().flatMap(x -&gt; x.getChildren().stream()).filter(this::isSpecial).collect(Collectors.toList()); // fine</code></pre>
</div>
</div>
</li>
<li>
<p>Only use <code>collect</code> at the end of the stream:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">set.stream().collect(Collectors.toList()).forEach(...) // bad
set.stream().peek(...).collect(Collectors.toList()) // fine</code></pre>
</div>
</div>
</li>
<li>
<p>Lambda parameters with Types inference</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">(String a, Float b, Byte[] c) -&gt; a.toString() + Float.toString(b) + Arrays.toString(c)  // bad
(a,b,c)  -&gt; a.toString() + Float.toString(b) + Arrays.toString(c)  // fine

Collections.sort(personList, (Person p1, Person p2) -&gt; p1.getSurName().compareTo(p2.getSurName()));  // bad
Collections.sort(personList, (p1, p2) -&gt; p1.getSurName().compareTo(p2.getSurName()));  // fine</code></pre>
</div>
</div>
</li>
<li>
<p>Avoid Return Braces and Statement</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"> a -&gt;  { return a.toString(); } // bad
 a -&gt;  a.toString();   // fine</code></pre>
</div>
</div>
</li>
<li>
<p>Avoid Parentheses with Single Parameter</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">(a) -&gt; a.toString(); // bad
 a -&gt; a.toString();  // fine</code></pre>
</div>
</div>
</li>
<li>
<p>Avoid if/else inside foreach method. Use Filter method &amp; comprehension</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// bad
static public Iterator&lt;String&gt; TwitterHandles(Iterator&lt;Author&gt; authors, string company) {
    final List result = new ArrayList&lt;String&gt; ();
    foreach (Author a : authors) {
      if (a.Company.equals(company)) {
        String handle = a.TwitterHandle;
        if (handle != null)
          result.Add(handle);
      }
    }
    return result;
  }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// fine
public List&lt;String&gt; twitterHandles(List&lt;Author&gt; authors, String company) {
    return authors.stream()
            .filter(a -&gt; null != a &amp;&amp; a.getCompany().equals(company))
            .map(a -&gt; a.getTwitterHandle())
            .collect(toList());
  }</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="optionals">Optionals</h5>
<div class="paragraph">
<p>With <code>Optional</code> you can wrap values to avoid a <code>NullPointerException</code> (NPE). However, it is not a good code-style to use <code>Optional</code> for every parameter or result to express that it may be null. For such case use <code>@Nullable</code> or even better instead annotate <code>@NotNull</code> where <code>null</code> is not acceptable.</p>
</div>
<div class="paragraph">
<p>However, <code>Optional</code> can be used to prevent NPEs in fluent calls (due to the lack of the elvis operator):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Long id;
id = fooCto.getBar().getBar().getId(); // may cause NPE
id = Optional.ofNullable(fooCto).map(FooCto::getBar).map(BarCto::getBar).map(BarEto::getId).orElse(null); // null-safe</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="encoding">Encoding</h5>
<div class="paragraph">
<p>Encoding (esp. Unicode with combining characters and surrogates) is a complex topic. Please study this topic if you have to deal with encodings and processing of special characters. For the basics follow these recommendations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Whenever possible prefer unicode (UTF-8 or better) as encoding. This especially impacts your databases and has to be defined upfront as it typically can not be changed (easily) afterwards.</p>
</li>
<li>
<p>Do not cast from <code>byte</code> to <code>char</code> (unicode characters can be composed of multiple bytes, such cast may only work for ASCII characters)</p>
</li>
<li>
<p>Never convert the case of a String using the default locale (esp. when writing generic code like in devonfw). E.g. if you do <code>"HI".toLowerCase()</code> and your system locale is Turkish, then the output will be "hı" instead of "hi", which can lead to wrong assumptions and serious problems. If you want to do a "universal" case conversion always explicitly use an according western locale (e.g. <code>toLowerCase(Locale.US)</code>). Consider using a helper class (see e.g. <a href="https://github.com/m-m-m/base/blob/master/core/src/main/java/io/github/mmm/base/text/CaseHelper.java">CaseHelper</a>) or create your own little static utility for that in your project.</p>
</li>
<li>
<p>Write your code independent from the default encoding (system property <code>file.encoding</code>) - this will most likely differ in JUnit from production environment</p>
<div class="ulist">
<ul>
<li>
<p>Always provide an encoding when you create a <code>String</code> from <code>byte[]</code>: <code>new String(bytes, encoding)</code></p>
</li>
<li>
<p>Always provide an encoding when you create a <code>Reader</code> or <code>Writer</code> : <code>new InputStreamReader(inStream, encoding)</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="prefer-general-api">Prefer general API</h5>
<div class="paragraph">
<p>Avoid unnecessary strong bindings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do not bind your code to implementations such as <code>Vector</code> or <code>ArrayList</code> instead of <code>List</code></p>
</li>
<li>
<p>In APIs for input (=parameters) always consider to make little assumptions:</p>
<div class="ulist">
<ul>
<li>
<p>prefer <code>Collection</code> over <code>List</code> or <code>Set</code> where the difference does not matter (e.g. only use <code>Set</code> when you require uniqueness or highly efficient <code>contains</code>)</p>
</li>
<li>
<p>consider preferring <code>Collection&lt;? extends Foo&gt;</code> over <code>Collection&lt;Foo&gt;</code> when <code>Foo</code> is an interface or super-class</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="prefer-primitive-boolean">Prefer primitive boolean</h5>
<div class="paragraph">
<p>Unless in rare cases where you need to allow a flag being <code>null</code> avoid using the object type <code>Boolean</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// bad
public Boolean isEmpty {
  return size() == 0;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead always use the primitive <code>boolean</code> type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">// fine
public boolean isEmpty {
  return size() == 0;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The only known excuse is for flags in <a href="guide-jpa.asciidoc#embeddable">embeddable types</a> due to limitations of hibernate.</p>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="project-structure">3.3. Project structure</h3>
<div class="paragraph">
<p>In devonfw we want to give clear structure and guidance for building applications.
This also allows tools such as <a href="https://github.com/devonfw/cobigen">CobiGen</a> or <a href="https://github.com/devonfw/sonar-devon4j-plugin/">sonar-devon4j-plugin</a> to "understand" the code.
Also this helps developers going from one devonfw project to the next one to quickly understand the code-base.
If every developer knows where to find what, the project gets more efficient.
A long time ago maven standardized the project structure with <code>src/main/java</code>, etc. and turned chaos into structure.
With devonfw we experienced the same for the codebase (what is inside <code>src/main/java</code>).</p>
</div>
<div class="paragraph">
<p>We initially started <code>devon4j</code> based on spring and spring-boot and proposed a <a href="guide-structure-classic.asciidoc">classic project structure</a>.
With modern cloud-native trends we added a <a href="guide-structure-modern.asciidoc">modern project structure</a>, that is more lean and up-to-date with the latest market trends.</p>
</div>
<!-- toc disabled -->
</div>
<div class="sect2">
<h3 id="dependency-injection">3.4. Dependency Injection</h3>
<div class="paragraph">
<p>Dependency injection is one of the most important design patterns and is a key principle to a modular and component based architecture.
The Java Standard for dependency injection is <a href="http://docs.oracle.com/javaee/6/api/javax/inject/package-summary.html">javax.inject (JSR330)</a> that we use in combination with <a href="http://docs.oracle.com/javaee/5/api/javax/annotation/package-summary.html">JSR250</a>.
Additionally, for scoping you can use CDI (Context and Dependency Injection) from <a href="https://jcp.org/en/jsr/detail?id=365">JSR365</a>.</p>
</div>
<div class="paragraph">
<p>There are many frameworks which support this standard including all recent Java EE application servers.
Therefore in devonfw we rely on these open standards and can propagate patterns and code examples that work independent from the underlying frameworks.</p>
</div>
<div class="sect3">
<h4 id="key-principles">3.4.1. Key Principles</h4>
<div class="paragraph">
<p>Within dependency injection a <em>bean</em> is typically a reusable unit of your application providing an encapsulated functionality.
This <em>bean</em> can be injected into other beans and it should in general be replaceable.
As an example we can think of a <a href="guide-usecase.asciidoc">use-case</a>, a <a href="guide-repository.asciidoc">repository</a>, etc.
As best practice we use the following principles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Stateless implementation</strong><br>
By default such beans shall be implemented <a href="coding-conventions.asciidoc#stateless-programming">stateless</a>. If you store state information in member variables you can easily run into concurrency problems and nasty bugs. This is easy to avoid by using local variables and separate state classes for complex state-information. Try to avoid stateful beans wherever possible. Only add state if you are fully aware of what you are doing and properly document this as a warning in your JavaDoc.</p>
</li>
<li>
<p><strong>Usage of Java standards</strong><br>
We use common standards (see above) that makes our code portable. Therefore we use standardized annotations like <code>@Inject</code> (<code>javax.inject.Inject</code>) instead of proprietary annotations such as <code>@Autowired</code>. Generally we avoid proprietary annotations in business code (<a href="guide-logic-layer.asciidoc">logic layer</a>).</p>
</li>
<li>
<p><strong>Simple injection-style</strong><br>
In general you can choose between constructor, setter or field injection. For simplicity we recommend to do private field injection as it is very compact and easy to maintain. We believe that constructor injection is bad for maintenance especially in case of inheritance (if you change the dependencies you need to refactor all sub-classes). Private field injection and public setter injection are very similar but setter injection is much more verbose (often you are even forced to have javadoc for all public methods). If you are writing re-usable library code setter injection will make sense as it is more flexible. In a business application you typically do not need that and can save a lot of boiler-plate code if you use private field injection instead. Nowadays you are using container infrastructure also for your tests (see <a href="guide-testing.asciidoc">testing</a>) so there is no need to inject manually (what would require a public setter).</p>
</li>
<li>
<p><strong>KISS</strong><br>
To follow the KISS (keep it small and simple) principle we avoid advanced features (e.g. custom <a href="guide-aop.asciidoc">AOP</a>, non-singleton beans) and only use them where necessary.</p>
</li>
<li>
<p><strong>Separation of API and implementation</strong><br>
For important components we should separate a self-contained API documented with JavaDoc from its implementation. Code from other components that wants to use the implementation shall only rely on the API. However, for things that will never be exchanged no API as interface is required you can skip such separation.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="example-bean">3.4.2. Example Bean</h4>
<div class="paragraph">
<p>Here you can see the implementation of an example bean using dependency injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
@Named("MyComponent")
public class MyComponentImpl implements MyComponent {
  @Inject
  private MyOtherComponent myOtherComponent;

  @PostConstruct
  public void init() {
    // initialization if required (otherwise omit this method)
  }

  @PreDestroy
  public void dispose() {
    // shutdown bean, free resources if required (otherwise omit this method)
  }

  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>MyComponentImpl</code> depends on <code>MyOtherComponent</code> that is injected into the field <code>myOtherComponent</code> because of the <code>@Inject</code> annotation.
To make this work there must be exactly one bean in the container (e.g. <a href="spring.asciidoc">spring</a> or <a href="quarkus.asciidoc">quarkus</a>) that is an instance of <code>MyOtherComponent</code>.
In order to put a bean into the container, we can use <code>@ApplicationScoped</code> in case of CDI (required for quarkus) for a stateless bean.
In spring we can ommit a CDI annotation and the <code>@Named</code> annotation is already sufficient as a bean is stateless by default in spring.
If we always use <code>@ApplicationScoped</code> we can make this more explicit and more portable accross different frameworks.
So in our example we put <code>MyComponentImpl</code> into the container.
That bean will be called <code>MyComponent</code> as we specified in the <code>@Named</code> annotation but we can also omit the name to use the classname as fallback.
Now our bean can be injected into other beans using <code>@Inject</code> annotation either via <code>MyComponent</code> interface (recommended when interface is present) or even directly via <code>MyComponentImpl</code>.
In case you omit the interface, you should also omit the <code>Impl</code> suffix or instead use <code>Bean</code> as suffix.</p>
</div>
</div>
<div class="sect3">
<h4 id="multiple-bean-implementations">3.4.3. Multiple bean implementations</h4>
<div class="paragraph">
<p>In some cases you might have multiple implementations as beans for the same interface.
The following sub-sections handle the different scenarios to give you guidance.</p>
</div>
<div class="sect4">
<h5 id="only-one-implementation-in-container">Only one implementation in container</h5>
<div class="paragraph">
<p>In some cases you still have only one implementation active as bean in the container at runtime.
A typical example is that you have different implemenations for test and main usage.
This case is easy, as <code>@Inject</code> will always be unique.
The only thing you need to care about is how to configure your framework (spring, quarkus, etc.) to know which implementation to put in the container depending on specific configuration.
In spring this can be archived via the proprietary <code>@Profile</code> annotaiton.</p>
</div>
</div>
<div class="sect4">
<h5 id="injecting-all-of-multiple-implementations">Injecting all of multiple implementations</h5>
<div class="paragraph">
<p>In some situations you may have an interface that defines a kind of "plugin".
You can have multiple implementations in your container and want to have all of them injected.
Then you can request a list with all the bean implementations via the interface as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @Inject
  private List&lt;MyConverter&gt; converters;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your code may iterate over all plugins (converters) and apply them sequentially.
Please note that the injection will fail (at least in spring), when there is no bean available to inject.
So you do not get an empty list injected but will get an exception on startup.</p>
</div>
</div>
<div class="sect4">
<h5 id="injecting-one-of-multiple-implementations">Injecting one of multiple implementations</h5>
<div class="paragraph">
<p>Another scenario is that you have multiple implementations in your container coexisting, but for injection you may want to choose a specific implementation.
Here you could use the <code>@Named</code> annotation to specify a unique identifier for each implementation what is called qualified injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
@Named("UserAuthenticator")
public class UserAuthenticator implements Authenticator {
  ...
}
@ApplicationScoped
@Named("ServiceAuthenticator")
public class ServiceAuthenticator implements Authenticator {
  ...
}
public class MyUserComponent {
  @Inject
  @Named("UserAuthenticator")
  private Authenticator authenticator;
  ...
}
public class MyServiceComponent {
  @Inject
  @Named("ServiceAuthenticator")
  private Authenticator authenticator;
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, we discovered that this pattern is not so great:
The identifiers in the <code>@Named</code> annotation are just strings that could easily break.
You could use constants instead but still this is not the best solution.</p>
</div>
<div class="paragraph">
<p>In the end you can very much simplify this by just directly injecting the implementation instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
public class UserAuthenticator implements Authenticator {
  ...
}
@ApplicationScoped
public class ServiceAuthenticator implements Authenticator {
  ...
}
public class MyUserComponent {
  @Inject
  private UserAuthenticator authenticator;
  ...
}
public class MyServiceComponent {
  @Inject
  private ServiceAuthenticator authenticator;
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you want to strictly decouple from implementations, you can still create dedicated interfaces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface UserAuthenticator extends Authenticator {}
@ApplicationScoped
public class UserAuthenticatorImpl implements UserAuthenticator {
  ...
}
public interface ServiceAuthenticator extends Authenticator {}
@ApplicationScoped
public class ServiceAuthenticatorImpl implements ServiceAuthenticator {
  ...
}
public class MyUserComponent {
  @Inject
  private UserAuthenticator authenticator;
  ...
}
public class MyServiceComponent {
  @Inject
  private ServiceAuthenticator authenticator;
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, as you can see this is again introducing additional boiler-plate code.
While the principle to separate API and implementation and strictly decouple from implementation is valuable in general,
you should always consider KISS, lean, and agile in contrast and balance pros and cons instead of blindly following dogmas.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="imports">3.4.4. Imports</h4>
<div class="paragraph">
<p>Here are the import statements for the most important annotations for dependency injection</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import javax.inject.Inject;
import javax.inject.Named;
import javax.enterprise.context.ApplicationScoped;
// import javax.enterprise.context.RequestScoped;
// import javax.enterprise.context.SessionScoped;
import javax.annotation.PostConstruct;
import javax.annotation.PreDestroy;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dependencies">3.4.5. Dependencies</h4>
<div class="paragraph">
<p>Please note that with <a href="https://jakarta.ee/">Jakarta EE</a> the dependencies have changed.
When you want to start with Jakarta EE you should use these dependencies to get the annoations for dependency injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- Basic injection annotations (JSR-330) --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;jakarta.inject&lt;/groupId&gt;
  &lt;artifactId&gt;jakarta.inject-api&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!-- Basic lifecycle and security annotations (JSR-250)--&gt;
&lt;dependency&gt;
  &lt;groupId&gt;jakarta.annotation&lt;/groupId&gt;
  &lt;artifactId&gt;jakarta.annotation-api&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!-- Context and dependency injection API (JSR-365) --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;jakarta.enterprise&lt;/groupId&gt;
  &lt;artifactId&gt;jakarta.enterprise.cdi-api&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that with <a href="quarkus.asciidoc">quarkus</a> you will get them as transitive dependencies out of the box.
The above Jakarate EE dependencies replace these JEE depdencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- Basic injection annotations (JSR-330) --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;javax.inject&lt;/groupId&gt;
  &lt;artifactId&gt;javax.inject&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!-- Basic lifecycle and security annotations (JSR-250)--&gt;
&lt;dependency&gt;
  &lt;groupId&gt;javax.annotation&lt;/groupId&gt;
  &lt;artifactId&gt;javax.annotation-api&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!-- Context and dependency injection API (JSR-365) --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;jakarta.enterprise&lt;/groupId&gt;
  &lt;artifactId&gt;jakarta.enterprise.cdi-api&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="blob-support">3.5. BLOB support</h3>
<div class="paragraph">
<p>BLOB stands for <strong>B</strong>inary <strong>L</strong>arge <strong>Ob</strong>ject. A BLOB may be an image, an office document, ZIP archive or any other multimedia object.
Often these BLOBs are large. if this is the case you need to take care, that you do not copy all the blob data into you application heap, e.g. when providing them via a REST service.
This could easily lead to performance problems or out of memory errors.
As solution for that problem is "streaming" those BLOBs directly from the database to the client. To demonstrate how this can be accomplished, devonfw provides a <a href="https://github.com/devonfw-sample/devon4j-blob-streaming">example</a>.</p>
</div>
<div class="sect3">
<h4 id="further-reading">3.5.1. Further Reading</h4>
<div class="ulist">
<ul>
<li>
<p><a href="guide-jpa.asciidoc#blob">BLOBs and the Data Access Layer</a></p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Unrestricted_File_Upload">Security Vulnerability Unrestricted File Upload</a></p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="common">3.6. Common</h3>
<div class="paragraph">
<p>In our <a href="coding-conventions.asciidoc">coding-conventions</a> we define a clear <a href="coding-conventions.asciidoc#packages">packaging</a> and <a href="coding-conventions.asciidoc#layers">layering</a>.
However, there is always cross-cutting code that does not belong to a specific layer such as generic helpers, general code for configuration or integration, etc.
Therefore, we define a package segment <code>common</code> that can be used as <code>«layer»</code> for such cross-cutting code.
Code from any other layer is allowed to access such <code>common</code> code (at least within the same component).</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
<div class="sect2">
<h3 id="java-persistence-api">3.7. Java Persistence API</h3>
<div class="paragraph">
<p>For mapping java objects to a relational database we use the <a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html">Java Persistence API (JPA)</a>.
As JPA implementation we recommend to use <a href="http://hibernate.org/orm/">Hibernate</a>. For general documentation about JPA and Hibernate follow the links above as we will not replicate the documentation. Here you will only find guidelines and examples how we recommend to use it properly. The following examples show how to map the data of a database to an entity. As we use JPA we abstract from <a href="guide-sql.asciidoc">SQL</a> here. However, you will still need a <a href="https://en.wikipedia.org/wiki/Data_definition_language">DDL</a> script for your schema and during maintenance also <a href="guide-database-migration.asciidoc">database migrations</a>. Please follow our <a href="guide-sql.asciidoc">SQL guide</a> for such artifacts.</p>
</div>
<div class="sect3">
<h4 id="entity">3.7.1. Entity</h4>
<div class="paragraph">
<p>Entities are part of the persistence layer and contain the actual data. They are POJOs (Plain Old Java Objects) on which the relational data of a database is mapped and vice versa. The mapping is configured via JPA annotations (<code>javax.persistence</code>). Usually an entity class corresponds to a table of a database and a property to a column of that table. A persistent entity instance then represents a row of the database table.</p>
</div>
<div class="sect4">
<h5 id="a-simple-entity">A Simple Entity</h5>
<div class="paragraph">
<p>The following listing shows a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Entity
@Table(name="TEXTMESSAGE")
public class MessageEntity extends ApplicationPersistenceEntity implements Message {

  private String text;

  public String getText() {
    return this.text;
  }

  public void setText(String text) {
    this.text = text;
  }
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Entity</code> annotation defines that instances of this class will be entities which can be stored in the database. The <code>@Table</code> annotation is optional and can be used to define the name of the corresponding table in the database. If it is not specified, the simple name of the entity class is used instead.</p>
</div>
<div class="paragraph">
<p>In order to specify how to map the attributes to columns we annotate the corresponding getter methods (technically also private field annotation is also possible but approaches can not be mixed).
The <code>@Id</code> annotation specifies that a property should be used as <a href="security.html#primary-keys">primary key</a>.
With the help of the <code>@Column</code> annotation it is possible to define the name of the column that an attribute is mapped to as well as other aspects such as <code>nullable</code> or <code>unique</code>. If no column name is specified, the name of the property is used as default.</p>
</div>
<div class="paragraph">
<p>Note that every entity class needs a constructor with public or protected visibility that does not have any arguments. Moreover, neither the class nor its getters and setters may be final.</p>
</div>
<div class="paragraph">
<p>Entities should be simple POJOs and not contain business logic.</p>
</div>
</div>
<div class="sect4">
<h5 id="entities-and-datatypes">Entities and Datatypes</h5>
<div class="paragraph">
<p>Standard datatypes like <code>Integer</code>, <code>BigDecimal</code>, <code>String</code>, etc. are mapped automatically by JPA. Custom <a href="guide-datatype.asciidoc">datatypes</a> are mapped as serialized <a href="security.html#blob">BLOB</a> by default what is typically undesired.
In order to map atomic custom datatypes (implementations of`+SimpleDatatype`) we implement an <code>AttributeConverter</code>. Here is a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Converter(autoApply = true)
public class MoneyAttributeConverter implements AttributeConverter&lt;Money, BigDecimal&gt; {

  public BigDecimal convertToDatabaseColumn(Money attribute) {
    return attribute.getValue();
  }

  public Money convertToEntityAttribute(BigDecimal dbData) {
    return new Money(dbData);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The annotation <code>@Converter</code> is detected by the JPA vendor if the annotated class is in the packages to scan. Further, <code>autoApply = true</code> implies that the converter is automatically used for all properties of the handled datatype. Therefore all entities with properties of that datatype will automatically be mapped properly (in our example <code>Money</code> is mapped as <code>BigDecimal</code>).</p>
</div>
<div class="paragraph">
<p>In case you have a composite datatype that you need to map to multiple columns the JPA does not offer a real solution. As a workaround you can use a bean instead of a real datatype and declare it as <a href="security.html#embeddable"><code>@Embeddable</code></a>. If you are using Hibernate you can implement <code>CompositeUserType</code>. Via the <code>@TypeDef</code> annotation it can be registered to Hibernate. If you want to annotate the <code>CompositeUserType</code> implementation itself you also need another annotation (e.g. <code>MappedSuperclass</code> tough not technically correct) so it is found by the scan.</p>
</div>
<div class="sect5">
<h6 id="enumerations">Enumerations</h6>
<div class="paragraph">
<p>By default JPA maps Enums via their ordinal. Therefore the database will only contain the ordinals (0, 1, 2, etc.) . So , inside the database you can not easily understand their meaning. Using <code>@Enumerated</code> with <code>EnumType.STRING</code> allows to map the enum values to their name (<code>Enum.name()</code>). Both approaches are fragile when it comes to code changes and refactoring (if you change the order of the enum values or rename them) after the application is deployed to production. If you want to avoid this and get a robust mapping you can define a dedicated string in each enum value for database representation that you keep untouched. Then you treat the enum just like any other <a href="security.html#entities-and-datatypes">custom datatype</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="blob">BLOB</h6>
<div class="paragraph">
<p>If binary or character large objects (BLOB/CLOB) should be used to store the value of an attribute, e.g. to store an icon, the <code>@Lob</code> annotation should be used as shown in the following listing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Lob
public byte[] getIcon() {
  return this.icon;
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Using a byte array will cause problems if BLOBs get large because the entire BLOB is loaded into the RAM of the server and has to be processed by the garbage collector. For larger BLOBs the type <a href="http://docs.oracle.com/javase/7/docs/api/java/sql/Blob.html">Blob</a> and <a href="guide-blob-support.asciidoc">streaming</a> should be used.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public Blob getAttachment() {
  return this.attachment;
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="date-and-time">Date and Time</h6>
<div class="paragraph">
<p>To store date and time related values, the temporal annotation can be used as shown in the listing below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Temporal(TemporalType.TIMESTAMP)
public java.util.Date getStart() {
  return start;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Until Java8 the java data type <code>java.util.Date</code> (or Jodatime) has to be used.
<code>TemporalType</code> defines the granularity. In this case, a precision of nanoseconds is used. If this granularity is not wanted, <code>TemporalType.DATE</code> can be used instead, which only has a granularity of milliseconds.
Mixing these two granularities can cause problems when comparing one value to another. This is why we <strong>only</strong>  use <code>TemporalType.TIMESTAMP</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="querydsl-and-custom-types">QueryDSL and Custom Types</h6>
<div class="paragraph">
<p>Using the Aliases API of QueryDSL might result in an <code>InvalidDataAccessApiUsageException</code> when using custom datatypes in entity properties. This can be circumvented in two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure you have the following maven dependencies in your project (<code>core</code> module) to support custom types via the Aliases API:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.ow2.asm&lt;/groupId&gt;
  &lt;artifactId&gt;asm&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;cglib&lt;/groupId&gt;
  &lt;artifactId&gt;cglib&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Make sure, that all your custom types used in entities provide a non-argument constructor with at least visibility level <code>protected</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect4">
<h5 id="primary-keys">Primary Keys</h5>
<div class="paragraph">
<p>We only use simple Long values as primary keys (IDs). By default it is auto generated (<code>@GeneratedValue(strategy=GenerationType.AUTO)</code>). This is already provided by the class <code>com.devonfw.&lt;projectName&gt;.general.dataaccess.api.AbstractPersistenceEntity</code> within the <a href="guide-structure-classic.asciidoc#architecture-mapping">classic project structure</a> respectively <code>com.devonfw.&lt;projectName&gt;.general.domain.model.AbstractPersistenceEntity</code> within the <a href="guide-structure-modern.asciidoc#architecture-mapping">modern project structure</a>, that you can extend.
In case you have business oriented keys (often as <code>String</code>), you can define an additional property for it and declare it as unique (<code>@Column(unique=true)</code>).
Be sure to include "AUTO_INCREMENT" in your sql table field ID to be able to persist data (or similar for other databases).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="relationships">3.7.2. Relationships</h4>
<div class="sect4">
<h5 id="n1-and-11-relationships">n:1 and 1:1 Relationships</h5>
<div class="paragraph">
<p>Entities often do not exist independently but are in some relation to each other. For example, for every period of time one of the StaffMember&#8217;s of the restaurant example has worked, which is represented by the class <code>WorkingTime</code>, there is a relationship to this StaffMember.</p>
</div>
<div class="paragraph">
<p>The following listing shows how this can be modeled using JPA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...

@Entity
public class WorkingTimeEntity {
   ...

   private StaffMemberEntity staffMember;

   @ManyToOne
   @JoinColumn(name="STAFFMEMBER")
   public StaffMemberEntity getStaffMember() {
      return this.staffMember;
   }

   public void setStaffMember(StaffMemberEntity staffMember) {
      this.staffMember = staffMember;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To represent the relationship, an attribute of the type of the corresponding entity class that is referenced has been introduced. The relationship is a n:1 relationship, because every <code>WorkingTime</code> belongs to exactly one <code>StaffMember</code>, but a <code>StaffMember</code> usually worked more often than once.<br>
This is why the <code>@ManyToOne</code> annotation is used here. For 1:1 relationships the <code>@OneToOne</code> annotation can be used which works basically the same way. To be able to save information about the relation in the database, an additional column in the corresponding table of WorkingTime is needed which contains the primary key of the referenced StaffMember. With the <code>name</code> element of the <code>@JoinColumn</code> annotation it is possible to specify the name of this column.</p>
</div>
</div>
<div class="sect4">
<h5 id="1n-and-nm-relationships">1:n and n:m Relationships</h5>
<div class="paragraph">
<p>The relationship of the example listed above is currently an unidirectional one, as there is a getter method for retrieving the <code>StaffMember</code> from the <code>WorkingTime</code> object, but not vice versa.</p>
</div>
<div class="paragraph">
<p>To make it a bidirectional one, the following code has to be added to <code>StaffMember</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  private Set&lt;WorkingTimeEntity&gt; workingTimes;

  @OneToMany(mappedBy="staffMember")
  public Set&lt;WorkingTimeEntity&gt; getWorkingTimes() {
    return this.workingTimes;
  }

  public void setWorkingTimes(Set&lt;WorkingTimeEntity&gt; workingTimes) {
    this.workingTimes = workingTimes;
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the relationship bidirectional, the tables in the database do not have to be changed. Instead the column that corresponds to the attribute <code>staffMember</code> in class <code>WorkingTime</code> is used, which is specified by the <code>mappedBy</code> element of the <code>@OneToMany</code> annotation. Hibernate will search for corresponding <code>WorkingTime</code> objects automatically when a <code>StaffMember</code> is loaded.</p>
</div>
<div class="paragraph">
<p>The problem with bidirectional relationships is that if a <code>WorkingTime</code> object is added to the set or list <code>workingTimes</code> in <code>StaffMember</code>, this does not have any effect in the database unless
the <code>staffMember</code> attribute of that <code>WorkingTime</code> object is set. That is why the devon4j advices not to use bidirectional relationships but to use queries instead. How to do this is shown <a href="security.html#queries">here</a>. If a bidirectional relationship should be used nevertheless, appropriate add and remove methods must be used.</p>
</div>
<div class="paragraph">
<p>For 1:n and n:m relations, the devon4j demands that (unordered) Sets and no other collection types are used, as shown in the listing above. The only exception is whenever an ordering is really needed, (sorted) lists can be used.<br>
For example, if <code>WorkingTime</code> objects should be sorted by their start time, this could be done like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  private List&lt;WorkingTimeEntity&gt; workingTimes;

  @OneToMany(mappedBy = "staffMember")
  @OrderBy("startTime asc")
  public List&lt;WorkingTimeEntity&gt; getWorkingTimes() {
    return this.workingTimes;
  }

  public void setWorkingTimes(List&lt;WorkingTimeEntity&gt; workingTimes) {
    this.workingTimes = workingTimes;
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The value of the <code>@OrderBy</code> annotation consists of an attribute name of the class followed by <code>asc</code> (ascending) or <code>desc</code> (descending).</p>
</div>
<div class="paragraph">
<p>To store information about a n:m relationship, a separate table has to be used, as one column cannot store several values (at least if the database schema is in first normal form).<br>
For example if one wanted to extend the example application so that all ingredients of one <code>FoodDrink</code> can be saved and to model the ingredients themselves as entities (e.g. to store additional information about them), this could be modeled as follows (extract of class <code>FoodDrink</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  private Set&lt;IngredientEntity&gt; ingredients;

  @ManyToMany()
  @JoinTable
  public Set&lt;IngredientEntity&gt; getIngredients() {
    return this.ingredients;
  }

  public void setOrders(Set&lt;IngredientEntity&gt; ingredients) {
    this.ingredients = ingredients;
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Information about the relation is stored in a table called <code>BILL_ORDER</code> that has to have two columns, one for referencing the Bill, the other one for referencing the Order. Note that the <code>@JoinTable</code> annotation is not needed in this case because a separate table is the default solution here (same for n:m relations) unless there is a <code>mappedBy</code> element specified.</p>
</div>
<div class="paragraph">
<p>For 1:n relationships this solution has the disadvantage that more joins (in the database system) are needed to get a Bill with all the Orders it refers to. This might have a negative impact on performance so that the solution to store a reference to the Bill row/entity in the Order&#8217;s table is probably the better solution in most cases.</p>
</div>
<div class="paragraph">
<p>Note that bidirectional n:m relationships are not allowed for applications based on devon4j. Instead a third entity has to be introduced, which "represents" the relationship (it has two n:1 relationships).</p>
</div>
</div>
<div class="sect4">
<h5 id="eager-vs-lazy-loading">Eager vs. Lazy Loading</h5>
<div class="paragraph">
<p>Using JPA it is possible to use either lazy or eager loading. Eager loading means that for entities retrieved from the database, other entities that are referenced by these entities are also retrieved, whereas lazy loading means that this is only done when they are actually needed, i.e. when the corresponding getter method is invoked.</p>
</div>
<div class="paragraph">
<p>Application based on devon4j are strongly advised to <strong>always use lazy loading</strong>. The JPA defaults are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@OneToMany</code>: LAZY</p>
</li>
<li>
<p><code>@ManyToMany</code>: LAZY</p>
</li>
<li>
<p><code>@ManyToOne</code>: EAGER</p>
</li>
<li>
<p><code>@OneToOne</code>: EAGER</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So at least for <code>@ManyToOne</code> and <code>@OneToOne</code> you always need to override the default by providing <code>fetch = FetchType.LAZY</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
Please read the <a href="guide-jpa-performance.asciidoc">performance guide</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="cascading-relationships">Cascading Relationships</h5>
<div class="paragraph">
<p>For relations it is also possible to define whether operations are cascaded (like a recursion) to the related entity.
By default, nothing is done in these situations. This can be changed by using the <code>cascade</code> property of the annotation that specifies the relation type (<code>@OneToOne</code>, <code>@ManyToOne</code>, <code>@OneToMany</code>, <code>@ManyToOne</code>). This property accepts a <code>CascadeType</code> that offers the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PERSIST (for <code>EntityManager.persist</code>, relevant to inserted transient entities into DB)</p>
</li>
<li>
<p>REMOVE (for <code>EntityManager.remove</code> to delete entity from DB)</p>
</li>
<li>
<p>MERGE (for <code>EntityManager.merge</code>)</p>
</li>
<li>
<p>REFRESH (for <code>EntityManager.refresh</code>)</p>
</li>
<li>
<p>DETACH (for <code>EntityManager.detach</code>)</p>
</li>
<li>
<p>ALL (cascade all of the above operations)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="http://meri-stuff.blogspot.de/2012/03/jpa-tutorial.html">here</a> for more information.</p>
</div>
</div>
<div class="sect4">
<h5 id="typesafe-foreign-keys-using-idref">Typesafe Foreign Keys using IdRef</h5>
<div class="paragraph">
<p>For simple usage you can use <code>Long</code> for all your foreign keys.
However, as an optional pattern for advanced and type-safe usage, we offer <a href="guide-jpa-idref.asciidoc">IdRef</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="embeddable">3.7.3. Embeddable</h4>
<div class="paragraph">
<p>An embeddable Object is a way to group properties of an <a href="security.html#entity">entity</a> into a separate Java (child) object. Unlike with implement <a href="security.html#relationships">relationships</a> the embeddable is not a separate entity and its properties are stored (embedded) in the same table together with the entity. This is helpful to structure and reuse groups of properties.</p>
</div>
<div class="paragraph">
<p>The following example shows an <code>Address</code> implemented as an embeddable class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Embeddable
public class AddressEmbeddable {

  private String street;
  private String number;
  private Integer zipCode;
  private String city;

  @Column(name="STREETNUMBER")
  public String getNumber() {
    return number;
  }

  public void setNumber(String number) {
    this.number = number;
  }

  ...  // other getter and setter methods, equals, hashCode
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see an embeddable is similar to an entity class, but with an <code>@Embeddable</code> annotation instead of the <code>@Entity</code> annotation and without primary key or modification counter.
An Embeddable does not exist on its own but in the context of an entity.
As a simplification Embeddables do not require a separate interface and <a href="guide-transferobject.asciidoc#ETO">ETO</a> as the <a href="guide-beanmapping.asciidoc">bean-mapper</a> will create a copy automatically when converting the owning entity to an ETO.
However, in this case the embeddable becomes part of your <code>api</code> module that therefore needs a dependency on the <code>JPA</code>.</p>
</div>
<div class="paragraph">
<p>In addition to that the methods <code>equals(Object)</code> and <code>hashCode()</code> need to be implemented as this is required by Hibernate (it is not required for entities because they can be unambiguously identified by their primary key). For some hints on how to implement the <code>hashCode()</code> method please have a look <a href="http://stackoverflow.com/questions/113511/hash-code-implementation">here</a>.</p>
</div>
<div class="paragraph">
<p>Using this <code>AddressEmbeddable</code> inside an entity class can be done like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  private AddressEmbeddable address;

  @Embedded
  public AddressEmbeddable getAddress() {
    return this.address;
  }

  public void setAddress(AddressEmbeddable address) {
    this.address = address;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Embedded</code> annotation needs to be used for embedded attributes. Note that if in all columns of the embeddable (here <code>Address</code>) are <code>null</code>, then the embeddable object itself is also <code>null</code> inside the entity. This has to be considered to avoid NullPointerException&#8217;s. Further this causes some issues with primitive types in embeddable classes that can be avoided by only using object types instead.</p>
</div>
</div>
<div class="sect3">
<h4 id="inheritance">3.7.4. Inheritance</h4>
<div class="paragraph">
<p>Just like normal java classes, <a href="security.html#entity">entity</a> classes can inherit from others. The only difference is that you need to specify how to map a class hierarchy to database tables. Generic abstract super-classes for entities can simply be annotated with <code>@MappedSuperclass</code>.</p>
</div>
<div class="paragraph">
<p>For all other cases the JPA offers the annotation <code>@Inheritance</code> with the property <code>strategy</code> talking an <code>InheritanceType</code> that has the following options:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>SINGLE_TABLE</code>: This strategy uses a single table that contains all columns needed to store all entity-types of the entire inheritance hierarchy. If a column is not needed for an entity because of its type, there is a null value in this column. An additional column is introduced, which denotes the type of the entity (called <code>dtype</code>).</p>
</li>
<li>
<p><code>TABLE_PER_CLASS</code>: For each concrete entity class there is a table in the database that can store such an entity with all its attributes. An entity is only saved in the table corresponding to its most concrete type. To get all entities of a super type, joins are needed.</p>
</li>
<li>
<p><code>JOINED</code>: In this case there is a table for every entity class including abstract classes, which contains only the columns for the persistent properties of that particular class. Additionally there is a primary key column in every table. To get an entity of a class that is a subclass of another one, joins are needed.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>Each of the three approaches has its advantages and drawbacks, which are discussed in detail <a href="http://openjpa.apache.org/builds/1.0.4/apache-openjpa-1.0.4/docs/manual/jpa_overview_mapping_inher.html#jpa_overview_mapping_inher_tpc">here</a>. In most cases, the first one should be used, because it is usually the fastest way to do the mapping, as no joins are needed when retrieving, searching or persisting entities. Moreover it is rather simple and easy to understand.
One major disadvantage is that the first approach could lead to a table with a lot of null values, which might have a negative impact on the database size.</p>
</div>
<div class="paragraph">
<p>The inheritance strategy has to be annotated to the top-most entity of the class hierarchy (where <code>@MappedSuperclass</code> classes are not considered) like in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Entity
@Inheritance(strategy=InheritanceType.SINGLE_TABLE)
public abstract class MyParentEntity extends ApplicationPersistenceEntity implements MyParent {
  ...
}

@Entity
public class MyChildEntity extends MyParentEntity implements MyChild {
  ...
}

@Entity
public class MyOtherEntity extends MyParentEntity implements MyChild {
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a best practice we advise you to avoid entity hierarchies at all where possible and otherwise to keep the hierarchy as small as possible. In order to just ensure reuse or establish a common API you can consider a shared interface, a <code>@MappedSuperclass</code> or an <code>@Embeddable</code> instead of an entity hierarchy.</p>
</div>
</div>
<div class="sect3">
<h4 id="repositories-and-daos">3.7.5. Repositories and DAOs</h4>
<div class="paragraph">
<p>For each entity a code unit is created that groups all database operations for that entity. We recommend to use <a href="guide-repository.asciidoc">spring-data repositories</a> for that as it is most efficient for developers. As an alternative there is still the classic approach using <a href="guide-dao.asciidoc">DAOs</a>.</p>
</div>
<div class="sect4">
<h5 id="concurrency-control">Concurrency Control</h5>
<div class="paragraph">
<p>The concurrency control defines the way concurrent access to the same data of a database is handled. When several users (or threads of application servers) concurrently access a database, anomalies may happen, e.g. a transaction is able to see changes from another transaction although that one did, not yet commit these changes. Most of these anomalies are automatically prevented by the database system, depending on the <a href="http://en.wikipedia.org/wiki/Isolation_(database_systems)"><em>isolation level</em></a> (property <code>hibernate.connection.isolation</code> in the <code>jpa.xml</code>, see <a href="http://docs.jboss.org/hibernate/orm/5.0/manual/en-US/html/ch03.html">here</a>, or <code>quarkus.datasource.jdbc.transaction-isolation-level</code> in the <code>application.properties</code>).</p>
</div>
<div class="paragraph">
<p>Another anomaly is when two stakeholders concurrently access a record, do some changes and write them back to the database. The JPA addresses this with different locking strategies (see <a href="http://www.objectdb.com/java/jpa/persistence/lock">here</a>).</p>
</div>
<div class="paragraph">
<p>As a best practice we are using optimistic locking for regular end-user <a href="guide-service-layer.asciidoc">services</a> (OLTP) and pessimistic locking for <a href="guide-batch-layer.asciidoc">batches</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="optimistic-locking">Optimistic Locking</h5>
<div class="paragraph">
<p>The class <code>com.devonfw.module.jpa.persistence.api.AbstractPersistenceEntity</code> already provides optimistic locking via a <code>modificationCounter</code> with the <code>@Version</code> annotation. Therefore JPA takes care of optimistic locking for you. When entities are transferred to clients, modified and sent back for update you need to ensure the <code>modificationCounter</code> is part of the game. If you follow our guides about <a href="guide-transferobject.asciidoc">transfer-objects</a> and <a href="guide-service-layer.asciidoc">services</a> this will also work out of the box.
You only have to care about two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to deal with optimistic locking in <a href="security.html#relationships">relationships</a>?<br>
Assume an entity <code>A</code> contains a collection of <code>B</code> entities. Should there be a locking conflict if one user modifies an instance of <code>A</code> while another user in parallel modifies an instance of <code>B</code> that is contained in the other instance? To address this , take a look at <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/feature/FeatureForceIncrementModificationCounter.java">FeatureForceIncrementModificationCounter</a>.</p>
</li>
<li>
<p>What should happen in the UI if an <code>OptimisticLockException</code> occurred?<br>
According to KISS our recommendation is that the user gets an error displayed that tells him to do his change again on the recent data. Try to design your system and the work processing in a way to keep such conflicts rare and you are fine.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="pessimistic-locking">Pessimistic Locking</h5>
<div class="paragraph">
<p>For back-end <a href="guide-service-layer.asciidoc">services</a> and especially for <a href="guide-batch-layer.asciidoc">batches</a> optimistic locking is not suitable. A human user shall not cause a large batch process to fail because he was editing the same entity. Therefore such use-cases use pessimistic locking what gives them a kind of priority over the human users.
In your <a href="security.html#data-access-object">DAO</a> implementation you can provide methods that do pessimistic locking via <a href="http://docs.oracle.com/javaee/7/api/javax/persistence/EntityManager.html"><code>EntityManager</code></a> operations that take a <a href="http://docs.oracle.com/javaee/7/api/javax/persistence/LockModeType.html"><code>LockModeType</code></a>. Here is a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  getEntityManager().lock(entity, LockModeType.READ);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the <code>lock(Object, LockModeType)</code> method with <code>LockModeType.READ</code>, Hibernate will issue a <code>SELECT &#8230;&#8203; FOR UPDATE</code>. This means that no one else can update the entity (see <a href="http://docs.oracle.com/cd/B28359_01/server.111/b28286/statements_10002.htm">here</a> for more information on the statement). If <code>LockModeType.WRITE</code> is specified, Hibernate issues a <code>SELECT &#8230;&#8203; FOR UPDATE NOWAIT</code> instead, which has has the same meaning as the statement above, but if there is already a lock, the program will not wait for this lock to be released. Instead, an exception is raised.<br>
Use one of the types if you want to modify the entity later on, for read only access no lock is required.</p>
</div>
<div class="paragraph">
<p>As you might have noticed, the behavior of Hibernate deviates from what one would expect by looking at the <code>LockModeType</code> (especially <code>LockModeType.READ</code> should not cause a <code>SELECT &#8230;&#8203; FOR UPDATE</code> to be issued). The framework actually deviates from what is <a href="http://docs.oracle.com/javaee/7/api/javax/persistence/LockModeType.html">specified</a> in the JPA for unknown reasons.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="database-auditing">3.7.6. Database Auditing</h4>
<div class="paragraph">
<p>See <a href="guide-auditing.asciidoc">auditing guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="testing-data-access">3.7.7. Testing Data-Access</h4>
<div class="paragraph">
<p>For testing of Entities and Repositories or DAOs see <a href="guide-testing.asciidoc#level-2-component-test">testing guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="principles">3.7.8. Principles</h4>
<div class="paragraph">
<p>We strongly recommend these principles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use the JPA where ever possible and use vendor (hibernate) specific features only for situations when JPA does not provide a solution. In the latter case consider first if you really need the feature.</p>
</li>
<li>
<p>Create your entities as simple POJOs and use JPA to annotate the getters in order to define the mapping.</p>
</li>
<li>
<p>Keep your entities simple and avoid putting advanced logic into entity methods.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="database-configuration">3.7.9. Database Configuration</h4>
<div class="paragraph">
<p>For details on the configuration of the database connection and database logging of the individual framework, please refer to the respective configuration guide.</p>
</div>
<div class="paragraph">
<p>For <a href="spring.asciidoc">spring</a> see <a href="spring/guide-spring-configuration.asciidoc#database-configuration">here</a>.</p>
</div>
<div class="paragraph">
<p>For <a href="quarkus.asciidoc">quarkus</a> see <a href="quarkus/guide-quarkus-configuration.asciidoc#database-configuration">here</a>.</p>
</div>
<div class="sect4">
<h5 id="database-migration">Database Migration</h5>
<div class="paragraph">
<p>See <a href="guide-database-migration.asciidoc">database migration</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="pooling">Pooling</h5>
<div class="paragraph">
<p>You typically want to pool JDBC connections to boost performance by recycling previous connections. There are many libraries available to do connection pooling. We recommend to use <a href="https://github.com/brettwooldridge/HikariCP">HikariCP</a>. For Oracle RDBMS see <a href="guide-oracle.asciidoc#pooling">here</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="security-2">3.7.10. Security</h4>
<div class="sect4">
<h5 id="sql-injection">SQL-Injection</h5>
<div class="paragraph">
<p>A common <a href="guide-security.asciidoc">security</a> threat is <a href="http://en.wikipedia.org/wiki/SQL_injection">SQL-injection</a>. Never build queries with string concatenation or your code might be vulnerable as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  String query = "Select op from OrderPosition op where op.comment = " + userInput;
  return getEntityManager().createQuery(query).getResultList();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Via the parameter <code>userInput</code> an attacker can inject SQL (JPQL) and execute arbitrary statements in the database causing extreme damage.</p>
</div>
<div class="paragraph">
<p>In order to prevent such injections you have to strictly follow our rules for <a href="security.html#queries">queries</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use named queries for <a href="guide-jpa-query.asciidoc#static-queries">static queries</a>.</p>
</li>
<li>
<p>Use QueryDSL for <a href="guide-jpa-query.asciidoc#dynamic-queries">dynamic queries</a>.</p>
</li>
<li>
<p>Please also consult the <a href="https://www.owasp.org/index.php/SQL_Injection_Prevention_Cheat_Sheet">SQL Injection Prevention Cheat Sheet</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="limited-permissions-for-application">Limited Permissions for Application</h5>
<div class="paragraph">
<p>We suggest that you operate your application with a database user that has limited permissions so he can not modify the SQL schema (e.g. drop tables). For initializing the schema (DDL) or to do schema migrations use a separate user that is not used by the application itself.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect3">
<h4 id="queries">3.7.11. Queries</h4>
<div class="paragraph">
<p>The <a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html">Java Persistence API (JPA)</a> defines its own query language, the <a href="https://docs.oracle.com/html/E13946_01/ejb3_langref.html"><em>java persistence query language</em> (JPQL)</a> (see also <a href="https://docs.oracle.com/javaee/7/tutorial/persistence-querylanguage.htm">JPQL tutorial</a>), which is similar to SQL but operates on entities and their attributes instead of tables and columns.</p>
</div>
<div class="paragraph">
<p>The simplest CRUD-Queries (e.g. find an entity by its ID) are already build in the devonfw CRUD functionality (via <a href="guide-repository.asciidoc">Repository</a> or <a href="guide-dao.asciidoc">DAO</a>). For other cases you need to write your own query. We distinguish between <em>static</em> and <em>dynamic</em> queries. <a href="security.html#static-queries">Static queries</a> have a fixed JPQL query string that may only use parameters to customize the query at runtime. Instead, <a href="security.html#dynamic-queries">dynamic queries</a> can change their clauses (<code>WHERE</code>, <code>ORDER BY</code>, <code>JOIN</code>, etc.) at runtime depending on the given search criteria.</p>
</div>
<div class="sect4">
<h5 id="static-queries">Static Queries</h5>
<div class="paragraph">
<p>E.g. to find all <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/dishmanagement/dataaccess/api/DishEntity.java">DishEntries</a> (from MTS sample app) that have a price not exceeding a given <code>maxPrice</code> we write the following JPQL query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT dish FROM DishEntity dish WHERE dish.price &lt;= :maxPrice</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>dish</code> is used as alias (variable name) for our selected <code>DishEntity</code> (what refers to the simple name of the Java entity class). With <code>dish.price</code> we are referring to the Java property <code>price</code> (<code>getPrice()</code>/<code>setPrice(&#8230;&#8203;)</code>) in <code>DishEntity</code>. A named variable provided from outside (the search criteria at runtime) is specified with a colon (<code>:</code>) as prefix. Here with <code>:maxPrice</code> we reference to a variable that needs to be set via <code>query.setParameter("maxPrice", maxPriceValue)</code>. JPQL also supports indexed parameters (<code>?</code>) but they are discouraged because they easily cause confusion and mistakes.</p>
</div>
<div class="sect5">
<h6 id="using-queries-to-avoid-bidirectional-relationships">Using Queries to Avoid Bidirectional Relationships</h6>
<div class="paragraph">
<p>With the usage of queries it is possible to avoid exposing relationships or modelling bidirectional relationships, which have some disadvantages (see <a href="guide-jpa.asciidoc#relationships">relationships</a>). This is especially desired for relationships between entities of different business components.
So for example to get all <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/ordermanagement/dataaccess/api/OrderLineEntity.java">OrderLineEntities</a> for a specific <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/ordermanagement/dataaccess/api/OrderEntity.java">OrderEntity</a> without using the <code>orderLines</code> relation from <code>OrderEntity</code> the following query could be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT line FROM OrderLineEntity line WHERE line.order.id = :orderId</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="dynamic-queries">Dynamic Queries</h5>
<div class="paragraph">
<p>For dynamic queries, we use the <a href="http://querydsl.com/static/querydsl/latest/reference/html/ch02.html">JPA</a> module for <a href="http://www.querydsl.com/">Querydsl</a>. Querydsl also supports other modules such as <a href="http://querydsl.com/static/querydsl/latest/reference/html/ch02s07.html">MongoDB</a>, and <a href="http://querydsl.com/static/querydsl/latest/reference/html/ch02s05.html">Apache Lucene</a>. It allows to implement queries in a powerful but readable and type-safe way (unlike Criteria API). If you already know JPQL, you will quickly be able to read and write Querydsl code. It feels like JPQL but implemented in Java instead of plain text.</p>
</div>
<div class="paragraph">
<p>To use Querydsl in your Maven project, add the following dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependencies&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;com.querydsl&lt;/groupId&gt;
        &lt;artifactId&gt;querydsl-apt&lt;/artifactId&gt;
        &lt;version&gt;${querydsl.version}&lt;/version&gt;
        &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;com.querydsl&lt;/groupId&gt;
        &lt;artifactId&gt;querydsl-jpa&lt;/artifactId&gt;
        &lt;version&gt;${querydsl.version}&lt;/version&gt;
    &lt;/dependency&gt;

&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, configure the annotation processing tool (APT) plugin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;project&gt;
  &lt;build&gt;
    &lt;plugins&gt;
      ...
      &lt;plugin&gt;
        &lt;groupId&gt;com.mysema.maven&lt;/groupId&gt;
        &lt;artifactId&gt;apt-maven-plugin&lt;/artifactId&gt;
        &lt;version&gt;1.1.3&lt;/version&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;process&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
              &lt;outputDirectory&gt;target/generated-sources/java&lt;/outputDirectory&gt;
              &lt;processor&gt;com.querydsl.apt.jpa.JPAAnnotationProcessor&lt;/processor&gt;
            &lt;/configuration&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      ...
    &lt;/plugins&gt;
  &lt;/build&gt;
&lt;/project&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example from our sample application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  public List&lt;DishEntity&gt; findDishes(DishSearchCriteriaTo criteria) {
    QDishEntity dish = QDishEntity.dishEntity;
    JPAQuery&lt;DishEntity&gt; query = new JPAQuery&lt;OrderEntity&gt;(getEntityManager());
    query.from(dish);

    Range&lt;BigDecimal&gt; priceRange = criteria.getPriceRange();
    if (priceRange != null) {
      BigDecimal min = priceRange.getMin();
      if (min != null) {
        query.where(dish.price.goe(min));
      }
      BigDecimal max = priceRange.getMax();
      if (max != null) {
        query.where(dish.price.loe(max));
      }
    }
    String name = criteria.getName();
    if ((name != null) &amp;&amp; (!name.isEmpty())) {
      query.where(dish.name.eq(name));
    }
    query.orderBy(dish.price.asc(), dish.name.asc());
    return query.fetch();
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we use the so called Q-types (<code>QDishEntity</code>). These are classes generated at build time by the Querydsl annotation processor from entity classes. The Q-type classes can be used as static types representative of the original entity class.</p>
</div>
<div class="paragraph">
<p>The <code>query.from(dish)</code> method call defines the query source, in this case the <code>dish</code> table. The <code>where</code> method defines a filter. For example, The first call uses the <code>goe</code> operator to filter out any dishes that are not greater or equal to the minimal price. Further operators can be found <a href="https://querydsl.com/static/querydsl/latest/apidocs/com/querydsl/core/types/dsl/ComparableExpression.html">here</a>.</p>
</div>
<div class="paragraph">
<p>The <code>orderBy</code> method is used to sort the query results according to certain criteria. Here, we sort the results first by their price and then by their name, both in ascending order. To sort in descending order, use <code>.desc()</code>. To partition query results into groups of rows, see the <a href="https://querydsl.com/static/querydsl/latest/reference/html_single/#d0e377">groupBy</a> method.</p>
</div>
<div class="paragraph">
<p>For spring, devon4j provides another approach that you can use for your Spring applications to implement Querydsl logic without having to use these metaclasses. An example can be found <a href="spring/guide-querydsl-spring.asciidoc">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="native-queries">Native Queries</h5>
<div class="paragraph">
<p>Spring Data supports the use of <em>native queries</em>. Native queries use simple native SQL syntax that is not parsed in JPQL. This allows you to use all the features that your database supports.
The downside to this is that database portability is lost due to the absence of an abstraction layer. Therefore, the queries may not work with another database because it may use a different syntax.</p>
</div>
<div class="paragraph">
<p>You can implement a native query using <code>@Query</code> annotation with the <code>nativeQuery</code> attribute set to true:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Query(value="...", nativeQuery=true)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This will not work with Quarkus because Quarkus does not support native queries by using the <code>@Query</code> annotation (see <a href="guide-repository.asciidoc#limitations-in-quarkus">here</a>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also implement native queries directly using the <code>EntityManager</code> API and the <code>createNativeQuery</code> method.
<strong>This approach also works with Quarkus</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Query query = entityManager.createNativeQuery("SELECT * FROM Product", ProductEntity.class);
List&lt;ProductEntity&gt; products = query.getResultList();</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Be sure to use the name of the table when using native queries, while you must use the entity name when implementing queries with JPQL.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="using-wildcards">Using Wildcards</h5>
<div class="paragraph">
<p>For flexible queries it is often required to allow wildcards (especially in <a href="#dynamic_queries">dynamic queries</a>). While users intuitively expect glob syntax, the SQL and JPQL standards work differently. Therefore, a mapping is required. devonfw provides this on a lower level with <a href="https://github.com/devonfw/devon4j/blob/develop/modules/basic/src/main/java/com/devonfw/module/basic/common/api/query/LikePatternSyntax.java">LikePatternSyntax</a> and on a higher level with <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryUtil.java#L54">QueryUtil</a> (see <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryHelper.java#L199">QueryHelper.newStringClause(&#8230;&#8203;)</a>).</p>
</div>
</div>
<div class="sect4">
<h5 id="pagination">Pagination</h5>
<div class="paragraph">
<p>When dealing with large amounts of data, an efficient method of retrieving the data is required. Fetching the entire data set each time would be too time consuming. Instead, <em>Paging</em> is used to process only small subsets of the entire data set.</p>
</div>
<div class="paragraph">
<p>If you are using <a href="guide-repository.asciidoc">Spring Data repositories</a> you will get pagination support out of the box by providing the interfaces <a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/Pageable.html">Page</a> and  <a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/Pageable.html">Pageable</a>:</p>
</div>
<div class="listingblock">
<div class="title">Listing 1. <strong>repository</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Page&lt;DishEntity&gt; findAll(Pageable pageable);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can create a Pageable object and pass it to the method call as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">int page = criteria.getPageNumber();
int size = criteria.getPageSize();
Pageable pageable = PageRequest.of(page, size);
Page&lt;DishEntity&gt; dishes = dishRepository.findAll(pageable);</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="paging-with-querydsl">Paging with Querydsl</h6>
<div class="paragraph">
<p>Pagination is also supported for dynamic queries with Querydsl:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  public Page&lt;DishEntity&gt; findDishes(DishSearchCriteriaTo criteria) {
    QDishEntity dish = QDishEntity.dishEntity;
    JPAQuery&lt;DishEntity&gt; query = new JPAQuery&lt;OrderEntity&gt;(getEntityManager());
    query.from(dish);

    // conditions

    int page = criteria.getPageNumber();
    int size = criteria.getPageSize();
    Pageable pageable = PageRequest.of(page, size);
    query.offset(pageable.getOffset());
    query.limit(pageable.getPageSize());

    List&lt;DishEntity&gt; dishes = query.fetch();
    return new PageImpl&lt;&gt;(dishes, pageable, dishes.size());
  }</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="pagination-example">Pagination example</h6>
<div class="paragraph">
<p>For the table entity we can make a search request by accessing the REST endpoint with pagination support like in the following examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">POST mythaistar/services/rest/tablemanagement/v1/table/search
{
  "pagination": {
    "size":2,
    "total":true
  }
}

//Response
{
    "pagination": {
        "size": 2,
        "page": 1,
        "total": 11
    },
    "result": [
        {
            "id": 101,
            "modificationCounter": 1,
            "revision": null,
            "waiterId": null,
            "number": 1,
            "state": "OCCUPIED"
        },
        {
            "id": 102,
            "modificationCounter": 1,
            "revision": null,
            "waiterId": null,
            "number": 2,
            "state": "FREE"
        }
    ]
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
As we are requesting with the <code>total</code> property set to <code>true</code> the server responds with the total count of rows for the query.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For retrieving a concrete page, we provide the <code>page</code> attribute with the desired value. Here we also left out the <code>total</code> property so the server doesn&#8217;t incur on the effort to calculate it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">POST mythaistar/services/rest/tablemanagement/v1/table/search
{
  "pagination": {
    "size":2,
    "page":2
  }
}

//Response

{
    "pagination": {
        "size": 2,
        "page": 2,
        "total": null
    },
    "result": [
        {
            "id": 103,
            "modificationCounter": 1,
            "revision": null,
            "waiterId": null,
            "number": 3,
            "state": "FREE"
        },
        {
            "id": 104,
            "modificationCounter": 1,
            "revision": null,
            "waiterId": null,
            "number": 4,
            "state": "FREE"
        }
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="pagingation-in-devon4j-spring">Pagingation in devon4j-spring</h6>
<div class="paragraph">
<p>For spring applications, devon4j also offers its own solution for pagination. You can find an example of this <a href="spring/guide-querydsl-spring.asciidoc#pagination">here</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="query-meta-parameters">Query Meta-Parameters</h5>
<div class="paragraph">
<p>Queries can have meta-parameters and that are provided via <code>SearchCriteriaTo</code>. Besides paging (see above) we also get <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryHelper.java#L51">timeout support</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="advanced-queries">Advanced Queries</h5>
<div class="paragraph">
<p>Writing queries can sometimes get rather complex. The current examples given above only showed very simple basics. Within this topic a lot of advanced features need to be considered like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.w3schools.com/sql/sql_join.asp">Joins</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/html/E13946_04/ejb3_langref.html#ejb3_langref_constructor">Constructor queries</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_orderby.asp">Order By</a> (Sorting)</p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_groupby.asp">Grouping</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_having.asp">Having</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_union.asp">Unions</a></p>
</li>
<li>
<p><a href="https://docs.oracle.com/cd/E11035_01/kodo41/full/html/ejb3_langref.html#ejb3_langref_subqueries">Sub-Queries</a></p>
</li>
<li>
<p>Aggregation functions like e.g. <a href="https://www.w3schools.com/sql/sql_count_avg_sum.asp">count/avg/sum</a></p>
</li>
<li>
<p><a href="https://www.w3schools.com/sql/sql_distinct.asp">Distinct selections</a></p>
</li>
<li>
<p>SQL Hints (see e.g. <a href="https://docs.oracle.com/cd/B19306_01/server.102/b14211/hintsref.htm#i8327">Oracle hints</a> or <a href="http://sqlhints.com/">SQL-Server hints</a>) - only when required for ultimate performance tuning</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This list is just containing the most important aspects. As we can not cover all these topics here, they are linked to external documentation that can help and guide you.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect3">
<h4 id="spring-data">3.7.12. Spring Data</h4>
<div class="paragraph">
<p><a href="https://projects.spring.io/spring-data-jpa/">Spring Data JPA</a> is supported by both Spring and Quarkus. However, in Quarkus this approach still has some limitations. For detailed information, see the official <a href="https://quarkus.io/guides/spring-data-jpa">Quarkus Spring Data guide</a>.</p>
</div>
<div class="sect4">
<h5 id="motivation">Motivation</h5>
<div class="paragraph">
<p>The benefits of Spring Data are (for examples and explanations see next sections):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All you need is one single repository interface for each entity. No need for a separate implementation or other code artifacts like XML descriptors, <code>NamedQueries</code> class, etc.</p>
</li>
<li>
<p>You have all information together in one place (the repository interface) that actually belong together (where as in the classic approach you have the static <a href="guide-jpa-query.asciidoc">queries</a> in an XML file, constants to them in <code>NamedQueries</code> class and referencing usages in DAO implementation classes).</p>
</li>
<li>
<p>Static <a href="guide-jpa-query.asciidoc">queries</a> are most simple to realize as you do not need to write any method body. This means you can develop faster.</p>
</li>
<li>
<p>Support for paging is already build-in. Again for static <a href="guide-jpa-query.asciidoc">query</a> method the is nothing you have to do except using the paging objects in the signature.</p>
</li>
<li>
<p>Still you have the freedom to write custom implementations via default methods within the repository interface (e.g. for dynamic queries).</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="dependency">Dependency</h5>
<div class="paragraph">
<p>In case you want to switch to or add Spring Data support to your Spring or Quarkus application, all you need is to add the respective maven dependency:</p>
</div>
<div class="listingblock">
<div class="title">Listing 2. <strong>spring</strong></div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 3. <strong>quarkus</strong></div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-spring-data-jpa&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="repository">Repository</h5>
<div class="paragraph">
<p>For each entity <code>«Entity»Entity</code> an interface is created with the name <code>«Entity»Repository</code> extending <a href="https://docs.spring.io/spring-data/jpa/docs/current/api/org/springframework/data/jpa/repository/JpaRepository.html">JpaRepository</a>.
Such repository is the analogy to a <a href="guide-dao.asciidoc">Data-Access-Object (DAO)</a> used in the classic approach or when Spring Data is not an option.</p>
</div>
<div class="listingblock">
<div class="title">Listing 4. <strong>Repository</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ProductRepository extends JpaRepository&lt;ProductEntity, Long&gt; {

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Spring Data repository provides some basic implementations for accessing data, e.g. returning all instances of a type (<code>findAll</code>) or returning an instance by its ID (<code>findById</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="custom-method-implementation">Custom method implementation</h5>
<div class="paragraph">
<p>In addition, repositories can be enriched with additional functionality, e.g. to add QueryDSL functionality or to override the default implementations, by using so called repository fragments:</p>
</div>
<div class="sect5">
<h6 id="example">Example</h6>
<div class="paragraph">
<p>The following example shows how to write such a repository:</p>
</div>
<div class="listingblock">
<div class="title">Listing 5. <strong>Repository</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ProductRepository extends JpaRepository&lt;ProductEntity, Long&gt;, ProductFragment {

  @Query("SELECT product FROM ProductEntity product" //
      + " WHERE product.title = :title")
  List&lt;ProductEntity&gt; findByTitle(@Param("title") String title);

  @Query("SELECT product FROM ProductEntity product" //
      + " WHERE product.title = :title")
  Page&lt;ProductEntity&gt; findByTitlePaginated(@Param("title") String title, Pageable pageable);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 6. <strong>Repository fragment</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ProductFragment {
  Page&lt;ProductEntity&gt; findByCriteria(ProductSearchCriteriaTo criteria);
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 7. <strong>Fragment implementation</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class ProductFragmentImpl implements ProductFragment {
  @Inject
  EntityManager entityManager;

  public Page&lt;ProductEntity&gt; findByCriteria(ProductSearchCriteriaTo criteria) {
    QProductEntity product = QProductEntity.productEntity;
    JPAQuery&lt;ProductEntity&gt; query = new JPAQuery&lt;ProductEntity&gt;(this.entityManager);
    query.from(product);

    String title = criteria.getTitle();
    if ((title != null) &amp;&amp; !title.isEmpty()) {
      query.where(product.title.eq(title));
    }

    List&lt;ProductEntity&gt; products = query.fetch();
    return new PageImpl&lt;&gt;(products, PageRequest.of(criteria.getPageNumber(), criteria.getPageSize()), products.size());
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>ProductRepository</code> has the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CRUD support from Spring Data (see <a href="https://docs.spring.io/spring-data/data-jpa/docs/current/api/org/springframework/data/jpa/repository/JpaRepository.html">JavaDoc</a> for details).</p>
</li>
<li>
<p>Support for <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-spring-data/src/main/java/com/devonfw/module/jpa/dataaccess/api/data/QueryDslSupport.java">QueryDSL integration</a>, <a href="https://github.com/devonfw/devon4j/blob/develop/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/QueryUtil.java">paging and more</a>.</p>
</li>
<li>
<p>A static <a href="guide-jpa-query.asciidoc">query</a> method <code>findByTitle</code> to find all <code>ProductEntity</code> instances from DB that have the given title. Please note the <code>@Param</code> annotation that links the method parameter with the variable inside the query (<code>:title</code>).</p>
</li>
<li>
<p>The same with pagination support via findByTitlePaginated method.</p>
</li>
<li>
<p>A dynamic <a href="guide-jpa-query.asciidoc">query</a> method <code>findByCriteria</code> showing the QueryDSL and paging integration into Spring via a fragment implementation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can find an implementation of this <code>ProductRepository</code> in our <a href="https://github.com/devonfw-sample/devon4quarkus-reference/tree/master/src/main/java/com/devonfw/quarkus/productmanagement/domain/repo">Quarkus reference application</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In Quarkus, native and named queries via the <code>@Query</code> annotation are currently not supported
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="integration-of-spring-data-in-devon4j-spring">Integration of Spring Data in devon4j-spring</h6>
<div class="paragraph">
<p>For Spring applications, devon4j offers a proprietary solution that integrates seamlessly with QueryDSL and uses default methods instead of the fragment approach. A separate guide for this can be found <a href="spring/guide-devon4j-spring-repository.asciidoc">here</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="custom-methods-without-fragment-approach">Custom methods without fragment approach</h6>
<div class="paragraph">
<p>The fragment approach is a bit laborious, as three types (repository interface, fragment interface and fragment implementation) are always needed to implement custom methods.
We cannot simply use default methods within the repository because we cannot inject the <code>EntityManager</code> directly into the repository interface.</p>
</div>
<div class="paragraph">
<p>As a workaround, you can create a <code>GenericRepository</code> interface, as is done in the <a href="https://github.com/devonfw/devon4j/tree/master/modules/jpa-spring-data/src/main/java/com/devonfw/module/jpa/dataaccess/impl/data">devon4j jpa-spring-data module</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface GenericRepository&lt;E&gt; {

  EntityManager getEntityManager();

  ...
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class GenericRepositoryImpl&lt;E&gt; implements GenericRepository&lt;E&gt; {

  @Inject
  EntityManager entityManager;

  @Override
  public EntityManager getEntityManager() {

    return this.entityManager;
  }

  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, all your repository interfaces can extend the <code>GenericRepository</code> and you can implement queries directly in the repository interface using default methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface ProductRepository extends JpaRepository&lt;ProductEntity, Long&gt;, GenericRepository&lt;ProductEntity&gt; {

  default Page&lt;ProductEntity&gt; findByTitle(Title title) {

    EntityManager entityManager = getEntityManager();
    Query query = entityManager.createNativeQuery("select * from Product where title = :title", ProductEntity.class);
    query.setParameter("title", title);
    List&lt;ProductEntity&gt; products = query.getResultList();
    return new PageImpl&lt;&gt;(products);
  }

  ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="drawbacks">Drawbacks</h5>
<div class="paragraph">
<p>Spring Data also has some drawbacks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some kind of magic behind the scenes that are not so easy to understand. So in case you want to extend all your repositories without providing the implementation via a default method in a parent repository interface you need to deep-dive into Spring Data. We assume that you do not need that and hope what Spring Data and devon already provides out-of-the-box is already sufficient.</p>
</li>
<li>
<p>The Spring Data magic also includes guessing the query from the method name. This is not easy to understand and especially to debug. Our suggestion is not to use this feature at all and either provide a <code>@Query</code> annotation or an implementation via default method.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="limitations-in-quarkus">Limitations in Quarkus</h5>
<div class="ulist">
<ul>
<li>
<p>Native and named queries are not supported using <code>@Query</code> annotation. You will receive something like: <em>Build step io.quarkus.spring.data.deployment.SpringDataJPAProcessor#build threw an exception: java.lang.IllegalArgumentException: Attribute nativeQuery of @Query is currently not supported</em></p>
</li>
<li>
<p>Customizing the base repository for all repository interfaces in the code base, which is done in Spring Data by registering a class the extends <code>SimpleJpaRepository</code></p>
</li>
</ul>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect3">
<h4 id="data-access-object">3.7.13. Data Access Object</h4>
<div class="paragraph">
<p>The <em>Data Access Objects</em> (DAOs) are part of the persistence layer.
They are responsible for a specific <a href="security.html#entity">entity</a> and should be named <code>«Entity»Dao</code> and <code>«Entity»DaoImpl</code>.
The DAO offers the so called CRUD-functionalities (create, retrieve, update, delete) for the corresponding entity.
Additionally a DAO may offer advanced operations such as <a href="guide-jpa-query.asciidoc">query</a> or locking methods.</p>
</div>
<div class="sect4">
<h5 id="dao-interface">DAO Interface</h5>
<div class="paragraph">
<p>For each DAO there is an interface named <code>«Entity»Dao</code> that defines the API. For CRUD support and common naming we derive it from the <code>ApplicationDao</code> interface that comes with the devon application template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public interface MyEntityDao extends ApplicationDao&lt;MyEntity&gt; {
  List&lt;MyEntity&gt; findByCriteria(MyEntitySearchCriteria criteria);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All CRUD operations are inherited from <code>ApplicationDao</code> so you only have to declare the additional methods.</p>
</div>
</div>
<div class="sect4">
<h5 id="dao-implementation">DAO Implementation</h5>
<div class="paragraph">
<p>Implementing a DAO is quite simple. We create a class named <code>«Entity»DaoImpl</code> that extends <code>ApplicationDaoImpl</code> and implements your <code>«Entity»Dao</code> interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MyEntityDaoImpl extends ApplicationDaoImpl&lt;MyEntity&gt; implements MyEntityDao {

  public List&lt;MyEntity&gt; findByCriteria(MyEntitySearchCriteria criteria) {
    TypedQuery&lt;MyEntity&gt; query = createQuery(criteria, getEntityManager());
    return query.getResultList();
  }
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again you only need to implement the additional non-CRUD methods that you have declared in your <code>«Entity»Dao</code> interface.
In the DAO implementation you can use the method <code>getEntityManager()</code> to access the <code>EntityManager</code> from the JPA. You will need the <code>EntityManager</code> to create and execute <a href="guide-jpa-query.asciidoc">queries</a>.</p>
</div>
<div class="sect5">
<h6 id="static-queries-for-dao-implementation">Static queries for DAO Implementation</h6>
<div class="paragraph">
<p>All static <a href="guide-jpa-query.asciidoc">queries</a> are declared in the file <code>src\main\resources\META-INF\orm.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;entity-mappings version="1.0" xmlns="http://java.sun.com/xml/ns/persistence/orm" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://java.sun.com/xml/ns/persistence/orm http://java.sun.com/xml/ns/persistence/orm_1_0.xsd"&gt;
  &lt;named-query name="find.dish.with.max.price"&gt;
    &lt;query&gt;&lt;![SELECT dish FROM DishEntity dish WHERE dish.price &lt;= :maxPrice]]&gt;&lt;/query&gt;
  &lt;/named-query&gt;
  ...
&lt;/hibernate-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When your application is started, all these static queries will be created as prepared statements. This allows better performance and also ensures that you get errors for invalid JPQL queries when you start your app rather than later when the query is used.</p>
</div>
<div class="paragraph">
<p>To avoid redundant occurrences of the query name (<code>get.open.order.positions.for.order</code>) we define a constant for each named query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class NamedQueries {
  public static final String FIND_DISH_WITH_MAX_PRICE = "find.dish.with.max.price";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that changing the name of the java constant (<code>FIND_DISH_WITH_MAX_PRICE</code>) can be done easily with refactoring. Further you can trace where the query is used by searching the references of the constant.</p>
</div>
<div class="paragraph">
<p>The following listing shows how to use this query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public List&lt;DishEntity&gt; findDishByMaxPrice(BigDecimal maxPrice) {
  Query query = getEntityManager().createNamedQuery(NamedQueries.FIND_DISH_WITH_MAX_PRICE);
  query.setParameter("maxPrice", maxPrice);
  return query.getResultList();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Via <code>EntityManager.createNamedQuery(String)</code> we create an instance of <code>Query</code> for our predefined static query.
Next we use <code>setParameter(String, Object)</code> to provide a parameter (<code>maxPrice</code>) to the query. This has to be done for all parameters of the query.</p>
</div>
<div class="paragraph">
<p>Note that using the <code>createQuery(String)</code> method, which takes the entire query as string (that may already contain the parameter) is not allowed to avoid SQL injection vulnerabilities.
When the method <code>getResultList()</code> is invoked, the query is executed and the result is delivered as <code>List</code>. As an alternative, there is a method called <code>getSingleResult()</code>, which returns the entity if the query returned exactly one and throws an exception otherwise.</p>
</div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect3">
<h4 id="jpa-performance">3.7.14. JPA Performance</h4>
<div class="paragraph">
<p>When using JPA the developer sometimes does not see or understand where and when statements to the database are triggered.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Establishing expectations Developers shouldn’t expect to sprinkle magic pixie dust on POJOs in hopes they will become persistent.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Dan Allen<br>
<cite>https://epdf.tips/seam-in-action.html</cite>
</div>
</div>
<div class="paragraph">
<p>So in case you do not understand what is going on under the hood of JPA, you will easily run into performance issues due to lazy loading and other effects.</p>
</div>
<div class="sect4">
<h5 id="n-plus-1-problem">N plus 1 Problem</h5>
<div class="paragraph">
<p>The most prominent phenomena is call the <code>N+1 Problem</code>.
We use entities from our <a href="https://github.com/devonfw/my-thai-star">MTS</a> demo app as an example to explain the problem.
There is a <a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/dishmanagement/dataaccess/api/DishEntity.java">DishEntity</a> that has a <code>@ManyToMany</code> relation to
<a href="https://github.com/devonfw/my-thai-star/blob/develop/java/mtsj/core/src/main/java/com/devonfw/application/mtsj/dishmanagement/dataaccess/api/IngredientEntity.java">IngredientEntity</a>.
Now we assume that we want to iterate all ingredients for a dish like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">DishEntity dish = dao.findDishById(dishId);
BigDecimal priceWithAllExtras = dish.getPrice();
for (IngredientEntity ingredient : dish.getExtras()) {
  priceWithAllExtras = priceWithAllExtras.add(ingredient.getPrice());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now <code>dish.getExtras()</code> is loaded lazy. Therefore the JPA vendor will provide a list with lazy initialized instances of <code>IngredientEntity</code> that only contain the ID of that entity. Now with every call of <code>ingredient.getPrice()</code> we technically trigger an SQL query statement to load the specific <code>IngredientEntity</code> by its ID from the database.
Now <code>findDishById</code> caused 1 initial query statement and for any number <code>N</code> of ingredients we are causing an additional query statement. This makes a total of <code>N+1</code> statements. As causing statements to the database is an expensive operation with a lot of overhead (creating connection, etc.) this ends in bad performance and is therefore a problem (the N+1 Problem).</p>
</div>
</div>
<div class="sect4">
<h5 id="solving-n-plus-1-problem">Solving N plus 1 Problem</h5>
<div class="paragraph">
<p>To solve the N+1 Problem you need to change your code to only trigger a single statement instead. This can be archived in various ways. The most universal solution is to use <code>FETCH JOIN</code> in order to pre-load the nested <code>N</code> child entities into the first level cache of the JPA vendor implementation. This will behave very similar as if the <code>@ManyToMany</code> relation to <code>IngredientEntity</code> was having <code>FetchType.EAGER</code> but only for the specific query and not in general. Because changing <code>@ManyToMany</code> to <code>FetchType.EAGER</code> would cause bad performance for other usecases where only the dish but not its extra ingredients are needed. For this reason all relations, including <code>@OneToOne</code> should always be <code>FetchType.LAZY</code>. Back to our example we simply replace <code>dao.findDishById(dishId)</code> with <code>dao.findDishWithExtrasById(dishId)</code> that we implement by the following JPQL query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT dish FROM DishEntity dish
  LEFT JOIN FETCH dish.extras
  WHERE dish.id = :dishId</code></pre>
</div>
</div>
<div class="paragraph">
<p>The rest of the code does not have to be changed but now <code>dish.getExtras()</code> will get the <code>IngredientEntity</code> from the first level cache where is was fetched by the initial query above.</p>
</div>
<div class="paragraph">
<p>Please note that if you only need the sum of the prices from the extras you can also create a query using an aggregator function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT sum(dish.extras.price) FROM DishEntity dish</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see you need to understand the concepts in order to get good performance.</p>
</div>
<div class="paragraph">
<p>There are many advanced topics such as creating database indexes or calculating statistics for the query optimizer to get the best performance. For such advanced topics we recommend to have a database expert in your team that cares about such things. However, understanding the <em>N+1 Problem</em> and its solutions is something that every Java developer in the team needs to understand.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect3">
<h4 id="idref">3.7.15. IdRef</h4>
<div class="paragraph">
<p>IdRef can be used to reference other entities in TOs in order to make them type-safe and semantically more expressive.
It is an optional concept in devon4j for more complex applications that make intensive use of relations and foreign keys.</p>
</div>
<div class="sect4">
<h5 id="motivation-2">Motivation</h5>
<div class="paragraph">
<p>Assuming you have a method signature like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Long approve(Long cId, Long cuId);</code></pre>
</div>
</div>
<div class="paragraph">
<p>So what are the paremeters? What is returned?</p>
</div>
<div class="paragraph">
<p><code>IdRef</code> is just a wrapper for a Long used as foreign key. This makes our signature much more expressive and self-explanatory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">IdRef&lt;Contract&gt; approve(IdRef&lt;Contract&gt; cId, IdRef&lt;Customer&gt; cuId);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can easily see, that the result and the parameters are foreign-keys and which entity they are referring to via their generic type.
We can read the javadoc of these entities from the generic type and understand the context.
Finally, when passing <code>IdRef</code> objects to such methods, we get compile errors in case we accidentally place parameters in the wrong order.</p>
</div>
</div>
<div class="sect4">
<h5 id="idref-and-mapping">IdRef and Mapping</h5>
<div class="paragraph">
<p>In order to easily map relations from entities to <a href="guide-transferobject.asciidoc">transfer-objects</a> and back, we can easily also put according getters and setters into our entities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class ContractEntity extends ApplicationPersistenceEntity implements Contract {

  private CustomerEntity customer;

  ...

  @ManyToOne(fetch = FetchType.LAZY)
  @JoinColumn(name = "CUSTOMER_ID")
  public CustomerEntity getCustomer() {
    return this.customer;
  }

  public void setCustomer(CustomerEntity customer) {
    this.customer = customer;
  }

  @Transient
  public IdRef&lt;Customer&gt; getCustomerId() {
    return IdRef.of(this.customer);
  }

  public void setCustomerId(IdRef&lt;Customer&gt; customerId) {
    this.customer = JpaHelper.asEntity(customerId, CustomerEntity.class);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, ensure that you have the same getters and setters for <code>customerId</code> in your <code>Eto</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class ContractEto extends AbstractEto implements Contract {

  private IdRef&lt;Customer&gt; customerId;

  ...

  public IdRef&lt;Customer&gt; getCustomerId() {
    return this.customerId;
  }

  public void setCustomerId(IdRef&lt;Customer&gt; customerId) {
    this.customerId = customerId;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way the bean-mapper can automatically map from your entity (<code>ContractEntity</code>) to your Eto (<code>ContractEto</code>) and vice-versa.</p>
</div>
</div>
<div class="sect4">
<h5 id="jpahelper-and-entitymanager-access">JpaHelper and EntityManager access</h5>
<div class="paragraph">
<p>In the above example we used <code>JpaHelper.asEntity</code> to convert the foreign key (<code>IdRef&lt;Customer&gt;</code>) to the according entity (<code>CustomerEntity</code>).
This will internally use <code>EntityManager.getReference</code> to properly create a JPA entity.
The alternative "solution" that may be used with <code>Long</code> instead of <code>IdRef</code> is typically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  public void setCustomerId(IdRef&lt;Customer&gt; customerId) {
    Long id = null;
    if (customerId != null) {
      id = customerId.getId();
    }
    if (id == null) {
      this.customer = null;
    } else {
      this.customer = new CustomerEntity();
      this.customer.setId(id);
    }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>While this "solution" works is most cases, we discovered some more complex cases, where it fails with very strange hibernate exceptions.
When cleanly creating the entity via <code>EntityManager.getReference</code> instead it is working in all cases.
So how can <code>JpaHelper.asEntity</code> as a static method access the <code>EntityManager</code>?
Therefore we need to initialize this as otherwise you may see this exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>java.lang.IllegalStateException: EntityManager has not yet been initialized!
	at com.devonfw.module.jpa.dataaccess.api.JpaEntityManagerAccess.getEntityManager(JpaEntityManagerAccess.java:38)
	at com.devonfw.module.jpa.dataaccess.api.JpaHelper.asEntity(JpaHelper.java:49)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For main usage in your application we assume that there is only one instance of <code>EntityManager</code>.
Therefore we can initialize this instance during the spring boot setup.
This is what we provide for you in <a href="https://github.com/devonfw/devon4j/blob/master/modules/jpa-basic/src/main/java/com/devonfw/module/jpa/dataaccess/api/JpaInitializer.java">JpaInitializer</a> for you
when <a href="tutorial-newapp.asciidoc">creating a devon4j app</a>.</p>
</div>
<div class="sect5">
<h6 id="jpahelper-and-spring-test">JpaHelper and spring-test</h6>
<div class="paragraph">
<p>Further, you also want your code to work in integration tests.
Spring-test provides a lot of magic under the hood to make integration testing easy for you.
To boost the performance when running multiple tests, spring is smart and avoids creating the same spring-context multiple times.
Therefore it stores these contexts so that if a test-case is executed with a specific spring-configuration that has already been setup before,
the same spring-context can be reused instead of creating it again.
However, your tests may have multiple spring configurations leading to multiple spring-contexts.
Even worse these tests can run in any order leading to switching between spring-contexts forth and back.
Therefore, a static initializer during the spring boot setup can lead to strange errors as you can get the wrong <code>EntityManager</code> instance.
In order to fix such problems, we provide a solution pattern via <a href="https://github.com/devonfw/devon4j/blob/master/modules/test-jpa/src/main/java/com/devonfw/module/test/common/base/DbTest.java#L32">DbTest</a> ensuring for every test,
that the proper instance of <code>EntityManager</code> is initialized.
Therefore you should derive directly or indirectly (e.g. via <code>ComponentDbTest</code> and <code>SubsystemDbTest</code>) from <code>DbTesT</code> or adopt your own way to apply this pattern to your tests, when using <code>JpaHelper</code>.
This already happens if you are extending <code>ApplicationComponentTest</code> or <code>ApplicationSubsystemTest</code>.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect3">
<h4 id="transaction-handling">3.7.16. Transaction Handling</h4>
<div class="paragraph">
<p>For transaction handling we <a href="guide-aop.asciidoc">AOP</a> to add transaction control via annotations as aspect.
This is done by annotating your code with the <code>@Transactional</code> annotation.
You can either annotate your <a href="guide-dependency-injection.asciidoc#key-principles">container bean</a> at class level to make all methods transactional or your can annotate individual methods to make them transactional:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @Transactional
  public Output getData(Input input) {
    ...
  }</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="jta-imports">JTA Imports</h5>
<div class="paragraph">
<p>Here are the import statements for transaction support:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import javax.transaction.Transactional;</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
Use the above import statement to follow JEE and avoid using <code>org.springframework.transaction.annotation.Transactional</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="jta-dependencies">JTA Dependencies</h5>
<div class="paragraph">
<p>Please note that with <a href="https://jakarta.ee/">Jakarta EE</a> the dependencies have changed.
When you want to start with Jakarta EE you should use these dependencies to get the annoations for dependency injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- Java Transaction API (JTA) --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;jakarta.transaction&lt;/groupId&gt;
  &lt;artifactId&gt;jakarta.transaction-api&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that with <a href="quarkus.asciidoc">quarkus</a> you will get them as transitive dependencies out of the box.
The above Jakarate EE dependencies replace these JEE depdencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- Java Transaction API (JTA) --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;javax.transaction&lt;/groupId&gt;
  &lt;artifactId&gt;javax.transaction-api&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="handling-constraint-violations">Handling constraint violations</h5>
<div class="paragraph">
<p>Using <code>@Transactional</code> magically wraps transaction handling around your code.
As constraints are checked by the database at the end when the transaction gets committed, a constraint violation will be thrown by this aspect outside your code.
In case you have to handle constraint violations manually, you have to do that in code outside the logic that is annotated with <code>@Transactional</code>.
This may be done in a <a href="guide-service-layer.asciidoc">service operation</a> by catching a <code>ConstraintViolationException</code> (<code>org.hibernate.exception.ConstraintViolationException</code> for hibernate).
As a generic approach you can solve this via <a href="guide-rest.asciidoc#rest-exception-handling">REST execption handling</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="batches">Batches</h5>
<div class="paragraph">
<p>Transaction control for batches is a lot more complicated and is described in the <a href="guide-batch-layer.asciidoc">batch layer</a>.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="sql">3.8. SQL</h3>
<div class="paragraph">
<p>For general guides on dealing or avoiding SQL, preventing SQL-injection, etc. you should study <a href="guide-domain-layer.asciidoc">domain layer</a>.</p>
</div>
<div class="sect3">
<h4 id="naming-conventions">3.8.1. Naming Conventions</h4>
<div class="paragraph">
<p>Here we define naming conventions that you should follow whenever you write SQL files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All SQL-Keywords in UPPER CASE</p>
</li>
<li>
<p>Indentation should be 2 spaces as suggested by devonfw for every format.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="ddl">DDL</h5>
<div class="paragraph">
<p>The naming conventions for database constructs (tables, columns, triggers, constraints, etc.) should be aligned with your database product and their operators.
However, when you have the freedom of choice and a modern case-sensitive database, you can simply use your code conventions also for database constructs to avoid explicitly mapping each and every property (e.g. <code>RestaurantTable</code> vs. <code>RESTAURANT_TABLE</code>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define columns and constraints inline in the statement to create the table</p>
</li>
<li>
<p>Indent column types so they all start in the same text column</p>
</li>
<li>
<p>Constraints should be named explicitly (to get a reasonable hint error messages) with:</p>
<div class="ulist">
<ul>
<li>
<p><code>PK_«table»</code> for primary key (name optional here as PK constraint are fundamental)</p>
</li>
<li>
<p><code>FK_«table»_«property»</code> for foreign keys (<code>«table»</code> and <code>«property»</code> are both on the source where the foreign key is defined)</p>
</li>
<li>
<p><code>UC_«table»_«property»[_«propertyN»]*</code> for unique constraints</p>
</li>
<li>
<p><code>CK_«table»_«check»</code> for check constraints (<code>«check»</code> describes the check, if it is defined on a single property it should start with the property).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Old RDBMS had hard limitations for names (e.g. 30 characters). Please note that recent databases have overcome this very low length limitations. However, keep your names short but precise and try to define common abbreviations in your project for according (business) terms. Especially do not just truncate the names at the limit.</p>
</li>
<li>
<p>If possible add comments on table and columns to help DBAs understanding your schema. This is also honored by many tools (not only DBA-tools).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is a brief example of a DDL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE SEQUENCE HIBERNATE_SEQUENCE START WITH 1000000;

-- *** Table ***
CREATE TABLE RESTAURANT_TABLE (
  ID                   NUMBER(19) NOT NULL,
  MODIFICATION_COUNTER INTEGER NOT NULL,
  SEATS                INTEGER NOT NULL,
  CONSTRAINT PK_TABLE PRIMARY KEY(ID)
);
COMMENT ON TABLE RESTAURANT_TABLE IS 'The physical tables inside the restaurant.';
-- *** Order ***
CREATE TABLE RESTAURANT_ORDER (
  ID                   NUMBER(19) NOT NULL,
  MODIFICATION_COUNTER INTEGER NOT NULL,
  TABLE_ID             NUMBER(19) NOT NULL,
  TOTAL                DECIMAL(5, 2) NOT NULL,
  CREATION_DATE        TIMESTAMP NOT NULL,
  PAYMENT_DATE         TIMESTAMP,
  STATUS               VARCHAR2(10 CHAR) NOT NULL,
  CONSTRAINT PK_ORDER PRIMARY KEY(ID),
  CONSTRAINT FK_ORDER_TABLE_ID FOREIGN KEY(TABLE_ID) REFERENCES RESTAURANT_TABLE(ID)
);
COMMENT ON TABLE RESTAURANT_ORDER IS 'An order and bill at the restaurant.';
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>ATTENTION: Please note that <code>TABLE</code> and <code>ORDER</code> are reserved keywords in SQL and you should avoid using such keywords to prevent problems.</p>
</div>
</div>
<div class="sect4">
<h5 id="data">Data</h5>
<div class="paragraph">
<p>For insert, update, delete, etc. of data SQL scripts should additionally follow these guidelines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inserts always with the same order of columns in blocks for each table.</p>
</li>
<li>
<p>Insert column values always starting with ID, MODIFICATION_COUNTER, [DTYPE, ] &#8230;&#8203;</p>
</li>
<li>
<p>List columns with fixed length values (boolean, number, enums, etc.) before columns with free text to support alignment of multiple insert statements</p>
</li>
<li>
<p>Pro Tip: Get familiar with column mode of advanced editors such as <code>notepad++</code> when editing large blocks of similar insert statements.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">INSERT INTO RESTAURANT_TABLE(ID, MODIFICATION_COUNTER, SEATS) VALUES (0, 1, 4);
INSERT INTO RESTAURANT_TABLE(ID, MODIFICATION_COUNTER, SEATS) VALUES (1, 1, 4);
INSERT INTO RESTAURANT_TABLE(ID, MODIFICATION_COUNTER, SEATS) VALUES (2, 1, 4);
INSERT INTO RESTAURANT_TABLE(ID, MODIFICATION_COUNTER, SEATS) VALUES (3, 1, 4);
INSERT INTO RESTAURANT_TABLE(ID, MODIFICATION_COUNTER, SEATS) VALUES (4, 1, 6);
INSERT INTO RESTAURANT_TABLE(ID, MODIFICATION_COUNTER, SEATS) VALUES (5, 1, 6);
INSERT INTO RESTAURANT_TABLE(ID, MODIFICATION_COUNTER, SEATS) VALUES (6, 1, 6);
INSERT INTO RESTAURANT_TABLE(ID, MODIFICATION_COUNTER, SEATS) VALUES (7, 1, 8);
INSERT INTO RESTAURANT_TABLE(ID, MODIFICATION_COUNTER, SEATS) VALUES (8, 1, 8);
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>See also <a href="guide-database-migration.asciidoc">Database Migrations</a>.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="database-migration-2">3.9. Database Migration</h3>
<div class="paragraph">
<p>When you have a schema-based <a href="https://github.com/devonfw/devonfw-guide/blob/master/general/db/guide-database.asciidoc">database</a>,
you need a solution for schema versioning and migration for your database.
A specific release of your app requires a corresponding version of the schema in the database to run.
As you want simple and continuous deployment you should automate the schema versiong and database migration.</p>
</div>
<div class="paragraph">
<p>The general idea is that your software product contains "scripts" to migrate the database from schema version <code>X</code> to verion <code>X+1</code>.
When you begin your project you start with version <code>1</code> and with every increment of your app that needs a change to the database schema (e.g. a new table, a new column to an existing table, a new index, etc.) you add another "script" that migrates from the current to the next version.
For simplicity these versions are just sequential numbers or timestamps.
Now, the solution you choose will automatically manage the schema version in a separate metadata table in your database that stores the current schema version.
When your app is started, it will check the current version inside the database from that metadata table.
As long as there are "scripts" that migrate from there to a higher version, they will be automatically applied to the database and this process is protocolled to the metadata table in your database what also updates the current schema version there.
Using this approach, you can start with an empty database what will result in all "scripts" being applied sequentially.
Also any version of your database schema can be present and you will always end up in a controlled migration to the latest schema version.</p>
</div>
<div class="sect3">
<h4 id="options-for-database-migration">3.9.1. Options for database migration</h4>
<div class="paragraph">
<p>For database migration you can choose between the following options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="guide-flyway.asciidoc">flyway</a> (KISS based approach with migrations as SQL)</p>
</li>
<li>
<p><a href="guide-liquibase.asciidoc">liquibase</a> (more complex approach with database abstraction)</p>
</li>
</ul>
</div>
<!-- toc disabled -->
</div>
<div class="sect3">
<h4 id="flyway">3.9.2. Flyway</h4>
<div class="paragraph">
<p><a href="http://flywaydb.org/">Flyway</a> is a tool for <a href="guide-database-migration.asciidoc">database migration and schema versioning</a>.
See <a href="https://flywaydb.org/getstarted/why">why</a> for a motivation why using flyway.</p>
</div>
<div class="paragraph">
<p>Flyway can be used standalone e.g. via <a href="https://flywaydb.org/documentation/getstarted/firststeps/maven">flyway-maven-plugin</a> or can be integrated directly into your app to make sure the database migration takes place on startup.
For simplicity we recommend to integrate flyway into your app.
However, you need to be aware that therefore your app needs database access with full schema owner permissions.</p>
</div>
<div class="sect4">
<h5 id="organizational-advice">Organizational Advice</h5>
<div class="paragraph">
<p>A few considerations with respect to project organization will help to implement maintainable Flyway migrations.</p>
</div>
<div class="paragraph">
<p>At first, testing and production environments must be clearly and consistently distinguished. Use the following directory structure to achieve this distinction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">  src/main/resources/db
  src/test/resources/db</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although this structure introduces redundancies, the benefit outweighs this disadvantage.
An even more fine-grained production directory structure which contains one sub folder per release should be implemented:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">  src/main/resources/db/migration/releases/X.Y/x.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Emphasizing that migration scripts below the current version must never be changed will aid the second advantage of migrations: it will always be clearly reproducible in which state the database currently is.
Here, it is important to mention that, if test data is required, it must be managed separately from the migration data in the following directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">  src/test/resources/db/migration/</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>migration</code> directory is added to aid easy usage of Flyway defaults.
Of course, test data should also be managed per release as like production data.</p>
</div>
<div class="paragraph">
<p>With regard to content, separation of concerns (SoC) is an important goal. SoC can be achieved by distinguishing and writing multiple scripts with respect to business components/use cases (or database tables in case of large volumes of master data <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>. Comprehensible file names aid this separation.</p>
</div>
<div class="paragraph">
<p>It is important to have clear responsibilities regarding the database, the persistence layer (JPA), and migrations. Therefore a dedicated database expert should be in charge of any migrations performed or she should at least be informed before any change to any of the mentioned parts is applied.</p>
</div>
</div>
<div class="sect4">
<h5 id="technical-configuration">Technical Configuration</h5>
<div class="paragraph">
<p>Database migrations can be <a href="https://flywaydb.org/documentation/concepts/migrations#sql-based-migrations">SQL</a> based or <a href="https://flywaydb.org/documentation/concepts/migrations#java-based-migrations">Java</a> based.</p>
</div>
<div class="paragraph">
<p>To enable auto migration on startup (not recommended for productive environment) set the following property in the <code>application.properties</code> file for an environment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">flyway.enabled=true
flyway.clean-on-validation-error=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>For development environment it is helpful to set both properties to <code>true</code> in order to simplify development. For regular environments <code>flyway.clean-on-validation-error</code> should be <code>false</code>.</p>
</div>
<div class="paragraph">
<p>If you want to use Flyway set the following property in any case to prevent Hibernate from doing changes on the database (pre-configured by default in devonfw):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">spring.jpa.hibernate.ddl-auto=validate</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setting must be communicated to and coordinated with the customer and their needs.
In acceptance testing the same configuration as for the production environment should be enabled.</p>
</div>
<div class="paragraph">
<p>Since migration scripts will also be versioned the end-of-line (EOL) style must be fixated according to <a href="https://github.com/flyway/flyway/issues/253">this issue</a>. This is however solved in flyway 4.0+ and the latest devonfw release.
Also, the version numbers of migration scripts should not consist of simple ascending integer numbers like V0001<em>&#8230;&#8203;, V0002</em>&#8230;&#8203;, &#8230;&#8203; This naming may lead to problems when merging branches. Instead the usage of timestamps as version numbers will help to avoid such problems.</p>
</div>
</div>
<div class="sect4">
<h5 id="naming-conventions-2">Naming Conventions</h5>
<div class="paragraph">
<p>Database migrations should follow this naming convention:
V&lt;version&gt;__&lt;description&gt; (e.g.: V12345__Add_new_table.sql).</p>
</div>
<div class="paragraph">
<p>It is also possible to use Flyway for test data. To do so place your test data migrations in src/main/resources/db/testdata/ and set property</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">flyway.locations=classpath:db/migration/releases,classpath:db/migration/testdata</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then Flyway scans the additional location for migrations and applies all in the order specified by their version. If migrations V0001__... and V0002__... exist and a test data migration should be applied in between you can name it V0001_1__....</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect3">
<h4 id="liquibase">3.9.3. Liquibase</h4>
<div class="paragraph">
<p><a href="https://www.liquibase.org/">Liquibase</a> is a tool for <a href="guide-database-migration.asciidoc">database migration and schema versioning</a>.</p>
</div>
<div class="paragraph">
<p>See <a href="https://github.com/devonfw/devon4j/issues/303">devon4j#303</a> for details and status.</p>
</div>
<div class="sect4">
<h5 id="spring-boot-usage">Spring-boot usage</h5>
<div class="paragraph">
<p>For using liquibase in <a href="spring.asciidoc">spring</a> see <a href="https://docs.liquibase.com/tools-integrations/springboot/springboot.html">Using Liquibase with Spring Boot</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="quarkus-usage">Quarkus usage</h5>
<div class="paragraph">
<p>For uisng liquibase in <a href="quarkus.asciidoc">quarkus</a> see <a href="https://quarkus.io/guides/liquibase">Using Liquibase</a>.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="rest">3.10. REST</h3>
<div class="paragraph">
<p>REST (<a href="https://en.wikipedia.org/wiki/Representational_state_transfer">REpresentational State Transfer</a>) is an inter-operable protocol for <a href="guide-service-layer.asciidoc">services</a> that is more lightweight than <a href="guide-soap.asciidoc">SOAP</a>.
However, it is no real standard and can cause confusion (see <a href="https://github.com/devonfw/devon4j/blob/master/documentation/guide-rest-philosophy.asciidoc">REST philosophy</a>).
Therefore we define best practices here to guide you.</p>
</div>
<div class="sect3">
<h4 id="urls">3.10.1. URLs</h4>
<div class="paragraph">
<p>URLs are not case sensitive. Hence, we follow the best practice to use only lower-case-letters-with-hyphen-to-separate-words.
For operations in REST we distinguish the following types of URLs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <em>collection URL</em> is build from the rest service URL by appending the name of a collection. This is typically the name of an entity. Such URL identifies the entire collection of all elements of this type. Example: <code>https://mydomain.com/myapp/services/rest/mycomponent/v1/myentity</code></p>
</li>
<li>
<p>An <em>element URL</em> is build from a collection URL by appending an element ID. It identifies a single element (entity) within the collection. Example: <code>https://mydomain.com/myapp/services/rest/mycomponent/v1/myentity/42</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To follow KISS avoid using plural forms (<code>&#8230;&#8203;/productmanagement/v1/products</code> vs. <code>&#8230;&#8203;/productmanagement/v1/product/42</code>). Always use singular forms and avoid confusions (except for the rare cases where no singular exists).</p>
</div>
<div class="paragraph">
<p>The REST URL scheme fits perfect for <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> operations.
For business operations (processing, calculation, advanced search, etc.) we simply append a collection URL with the name of the business operation.
Then we can <code>POST</code> the input for the business operation and get the result back. Example: <code>https://mydomain.com/myapp/services/rest/mycomponent/v1/myentity/search</code></p>
</div>
</div>
<div class="sect3">
<h4 id="http-methods">3.10.2. HTTP Methods</h4>
<div class="paragraph">
<p>The following table defines the HTTP methods (verbs) and their meaning:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Usage of HTTP methods</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>HTTP Method</strong></th>
<th class="tableblock halign-left valign-top"><strong>Meaning</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GET</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read data (stateless).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PUT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create or update data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Process data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DELETE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete an entity.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Please also note that for (large) bulk deletions you may be forced to used <code>POST</code> instead of <code>DELETE</code> as according to the HTTP standard <code>DELETE</code> must not have payload and URLs are limited in length.</p>
</div>
<div class="paragraph">
<p>For general recommendations on HTTP methods for collection and element URLs see <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer#Applied_to_web_services">REST@wikipedia</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="http-status-codes">3.10.3. HTTP Status Codes</h4>
<div class="paragraph">
<p>Further we define how to use the HTTP status codes for REST services properly. In general the 4xx codes correspond to an error on the client side and the 5xx codes to an error on the server side.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Usage of HTTP status codes</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>HTTP Code</strong></th>
<th class="tableblock halign-left valign-top"><strong>Meaning</strong></th>
<th class="tableblock halign-left valign-top"><strong>Response</strong></th>
<th class="tableblock halign-left valign-top"><strong>Comment</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">requested result</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result of successful GET</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">204</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No Content</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>none</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Result of successful POST, DELETE, or PUT with empty result (void return)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">400</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bad Request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error details</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The HTTP request is invalid (parse error, validation failed)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unauthorized</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>none</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentication failed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">403</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forbidden</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>none</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authorization failed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">404</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not found</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>none</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either the service URL is wrong or the requested resource does not exist</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server Error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">error code, UUID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Internal server error occurred, in case of an exception, see <a href="security.html#rest-exception-handling">REST exception handling</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="jax-rs">3.10.4. JAX-RS</h4>
<div class="paragraph">
<p>For implementing REST services we use the <a href="https://jax-rs-spec.java.net/">JAX-RS</a> standard.
As payload encoding we recommend <a href="guide-json.asciidoc">JSON</a> bindings using <a href="http://wiki.fasterxml.com/JacksonHome">Jackson</a>.
To implement a REST service you simply add JAX-RS annotations.
Here is a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ApplicationScoped
@Path("/imagemanagement/v1")
@Consumes(MediaType.APPLICATION_JSON)
@Produces(MediaType.APPLICATION_JSON)
public class ImagemanagementRestService {

  @Inject
  private Imagemanagement imagemanagement;

  @GET
  @Path("/image/{id}/")
  public ImageDto getImage(@PathParam("id") long id) {

    return this.imagemanagement.findImage(id);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we can see a REST service for the <a href="architecture.asciidoc#business-architecture">business component</a> <code>imagemanagement</code>. The method <code>getImage</code> can be accessed via HTTP GET (see <code>@GET</code>) under the URL path <code>imagemanagement/image/{id}</code> (see <code>@Path</code> annotations) where <code>{id}</code> is the ID of the requested table and will be extracted from the URL and provided as parameter <code>id</code> to the method <code>getImage</code>. It will return its result (<code>ImageDto</code>) as <a href="guide-json.asciidoc">JSON</a> (see <code>@Produces</code> annotation - you can also extend <code>RestService</code> marker interface that defines these annotations for JSON). As you can see it delegates to the <a href="guide-logic-layer.asciidoc">logic</a> component <code>imagemanagement</code> that contains the actual business logic while the service itself only exposes this logic via HTTP. The REST service implementation is a regular CDI bean that can use <a href="guide-dependency-injection.asciidoc">dependency injection</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
With JAX-RS it is important to make sure that each service method is annotated with the proper HTTP method (<code>@GET</code>,<code>@POST</code>,etc.) to avoid unnecessary debugging. So you should take care not to forget to specify one of these annotations.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="service-interface">Service-Interface</h5>
<div class="paragraph">
<p>You may also separate API and implementation in case you want to reuse the API for <a href="guide-service-client.asciidoc">service-client</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Path("/imagemanagement/v1")
@Consumes(MediaType.APPLICATION_JSON)
@Produces(MediaType.APPLICATION_JSON)
public interface ImagemanagementRestService {

  @GET
  @Path("/image/{id}/")
  ImageEto getImage(@PathParam("id") long id);

}

@Named("ImagemanagementRestService")
public class ImagemanagementRestServiceImpl implements ImagemanagementRestService {

  @Override
  public ImageEto getImage(long id) {

    return this.imagemanagement.findImage(id);
  }

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="jax-rs-configuration">JAX-RS Configuration</h5>
<div class="paragraph">
<p>Starting from CXF 3.0.0 it is possible to enable the auto-discovery of JAX-RS roots.</p>
</div>
<div class="paragraph">
<p>When the JAX-RS server is instantiated, all the scanned root and provider beans (beans annotated with <code>javax.ws.rs.Path</code> and <code>javax.ws.rs.ext.Provider</code>) are configured.</p>
</div>
</div>
<div class="sect4">
<h5 id="rest-exception-handling">REST Exception Handling</h5>
<div class="paragraph">
<p>For exceptions, a service needs to have an exception facade that catches all exceptions and handles them by writing proper log messages and mapping them to a HTTP response with an corresponding <a href="security.html#http-status-codes">HTTP status code</a>.
For this, devon4j provides a generic solution via <code>RestServiceExceptionFacade</code> that you can use within your Spring applications. You need to follow the <a href="guide-exceptions.asciidoc">exception guide</a> in order for it to work out of the box because the facade needs to be able to distinguish between business and technical exceptions.
To implement a generic exception facade in Quarkus, follow the <a href="quarkus/guide-exception-handling.asciidoc">Quarkus exception guide</a>.</p>
</div>
<div class="paragraph">
<p>Now your service may throw exceptions, but the facade will automatically handle them for you.</p>
</div>
<div class="paragraph">
<p>The general format for returning an error to the client is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
  "message": "A human-readable message describing the error",
  "code": "A code identifying the concrete error",
  "uuid": "An identifier (generally the correlation id) to help identify corresponding requests in logs"
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="pagination-details">Pagination details</h5>
<div class="paragraph">
<p>We recommend to use <a href="guide-repository.asciidoc">spring-data repositories</a> for database access that already comes with pagination support.
Therefore, when performing a search, you can include a <a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/Pageable.html">Pageable</a> object.
Here is a JSON example for it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{ "pageSize": 20, "pageNumber": 0, "sort": [] }</code></pre>
</div>
</div>
<div class="paragraph">
<p>By increasing the <code>pageNumber</code> the client can browse and page through the hits.</p>
</div>
<div class="paragraph">
<p>As a result you will receive a <a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/domain/Page.html">Page</a>.
It is a container for your search results just like a <code>Collection</code> but additionally contains pagination information for the client.
Here is a JSON example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{ "totalElements": 1022,
  pageable: { "pageSize": 20, "pageNumber": 0 },
  content: [ ... ] }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>totalElements</code> property contains the total number of hits.
This can be used by the client to compute the total number of pages and render the pagination links accordingly.
Via the <code>pageable</code> property the client gets back the <code>Pageable</code> properties from the search request.
The actual hits for the current page are returned as array in the <code>content</code> property.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rest-testing">3.10.5. REST Testing</h4>
<div class="paragraph">
<p>For testing REST services in general consult the <a href="guide-testing.asciidoc">testing guide</a>.</p>
</div>
<div class="paragraph">
<p>For manual testing REST services there are browser plugins:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Firefox: <a href="https://addons.mozilla.org/de/firefox/addon/rested/">rested</a></p>
</li>
<li>
<p>Chrome: <a href="http://www.getpostman.com/">postman</a> (<a href="https://chrome.google.com/webstore/detail/advanced-rest-client/hgmloofddffdnphfgcellkdfbfbjeloo">advanced-rest-client</a>)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="security-3">3.10.6. Security</h4>
<div class="paragraph">
<p>Your services are the major entry point to your application. Hence security considerations are important here.</p>
</div>
<div class="sect4">
<h5 id="csrf">CSRF</h5>
<div class="paragraph">
<p>A common security threat is <a href="https://www.owasp.org/index.php/Top_10_2013-A8-Cross-Site_Request_Forgery_(CSRF)">CSRF</a> for REST services. Therefore all REST operations that are performing modifications (PUT, POST, DELETE, etc. - all except GET) have to be secured against CSRF attacks. See <a href="guide-csrf.asciidoc">CSRF</a> how to do this.</p>
</div>
</div>
<div class="sect4">
<h5 id="json-top-level-arrays">JSON top-level arrays</h5>
<div class="paragraph">
<p>OWASP earlier suggested to never return JSON arrays at the top-level, to prevent attacks without rationale.
We digged deep and found <a href="https://haacked.com/archive/2008/11/20/anatomy-of-a-subtle-json-vulnerability.aspx/">anatomy-of-a-subtle-json-vulnerability</a>.
To sum it up the attack is many years old and does not work in any recent or relevant browser.
Hence it is fine to use arrays as top-level result in a JSON REST service (means you can return <code>List&lt;Foo&gt;</code> in a Java JAX-RS service).</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="json">3.11. JSON</h3>
<div class="paragraph">
<p><a href="http://en.wikipedia.org/wiki/JSON">JSON</a> (JavaScript Object Notation) is a popular format to represent and exchange data especially for modern web-clients. For mapping Java objects to JSON and vice-versa there is no official standard API. We use the established and powerful open-source solution <a href="http://wiki.fasterxml.com/JacksonHome">Jackson</a>.
Due to problems with the wiki of fasterxml you should try this alternative link: <a href="https://github.com/FasterXML/jackson#jackson-project-home-github">Jackson/AltLink</a>.</p>
</div>
<div class="sect3">
<h4 id="configure-json-mapping">3.11.1. Configure JSON Mapping</h4>
<div class="paragraph">
<p>In order to avoid polluting business objects with proprietary Jackson annotations (e.g. <code>@JsonTypeInfo</code>, <code>@JsonSubTypes</code>, <code>@JsonProperty</code>) we propose to create a separate configuration class. Every devonfw application (sample or any app created from our <a href="tutorial-newapp.asciidoc">app-template</a>) therefore has a class called <code>ApplicationObjectMapperFactory</code> that extends ObjectMapperFactory from the devon4j-rest module. It looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named("ApplicationObjectMapperFactory")
public class ApplicationObjectMapperFactory extends ObjectMapperFactory {

  public RestaurantObjectMapperFactory() {
    super();
    // JSON configuration code goes here
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="json-and-inheritance">3.11.2. JSON and Inheritance</h4>
<div class="paragraph">
<p>If you are using inheritance for your objects mapped to JSON then polymorphism can not be supported out-of-the box. So in general avoid polymorphic objects in JSON mapping. However, this is not always possible.
Have a look at the following example from our sample application:</p>
</div>
<div id="img-rest-inheritance" class="imageblock text-center">
<div class="content">
<img src="images/REST-Inheritance.png" alt="inheritance class diagram">
</div>
<div class="title">Figure 1. Transfer-Objects using Inheritance</div>
</div>
<div class="paragraph">
<p>Now assume you have a <a href="guide-service-layer.asciidoc#rest">REST service operation</a> as Java method that takes a ProductEto as argument. As this is an abstract class the server needs to know the actual sub-class to instantiate.
We typically do not want to specify the classname in the JSON as this should be an implementation detail and not part of the public JSON format (e.g. in case of a service interface). Therefore we use a symbolic name for each polymorphic subtype that is provided as virtual attribute @type within the JSON data of the object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{ "@type": "Drink", ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore you add configuration code to the constructor of <a href="security.html#configure-json-mapping">ApplicationObjectMapperFactory</a>. Here you can see an example from the sample application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">setBaseClasses(ProductEto.class);
addSubtypes(new NamedType(MealEto.class, "Meal"), new NamedType(DrinkEto.class, "Drink"),
  new NamedType(SideDishEto.class, "SideDish"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use <code>setBaseClasses</code> to register all top-level classes of polymorphic objects. Further we declare all concrete polymorphic sub-classes together with their symbolic name for the JSON format via <code>addSubtypes</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="custom-mapping">3.11.3. Custom Mapping</h4>
<div class="paragraph">
<p>In order to map custom <a href="guide-datatype.asciidoc">datatypes</a> or other types that do not follow the Java bean conventions, you need to define a custom mapping. If you create objects dedicated for the JSON mapping you can easily avoid such situations. When this is not suitable follow these instructions to define the mapping:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>As an example, the use of JSR354 (<code>javax.money</code>) is appreciated in order to process monetary amounts properly. However, without custom mapping, the default mapping of Jackson will produce the following JSON for a <code>MonetaryAmount</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"currency": {"defaultFractionDigits":2, "numericCode":978, "currencyCode":"EUR"},
"monetaryContext": {...},
"number":6.99,
"factory": {...}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As clearly can be seen, the JSON contains too much information and reveals implementation secrets that do not belong here. Instead the JSON output expected and desired would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">"currency":"EUR","amount":"6.99"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even worse, when we send the JSON data to the server, Jackson will see that <code>MonetaryAmount</code> is an interface and does not know how to instantiate it so the request will fail.
Therefore we need a customized <a href="https://github.com/FasterXML/jackson-docs/wiki/JacksonHowToCustomSerializers">Serializer</a>.</p>
</div>
</li>
<li>
<p>We implement <code>MonetaryAmountJsonSerializer</code> to define how a <code>MonetaryAmount</code> is serialized to JSON:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public final class MonetaryAmountJsonSerializer extends JsonSerializer&lt;MonetaryAmount&gt; {

  public static final String NUMBER = "amount";
  public static final String CURRENCY = "currency";

  public void serialize(MonetaryAmount value, JsonGenerator jgen, SerializerProvider provider) throws ... {
    if (value != null) {
      jgen.writeStartObject();
      jgen.writeFieldName(MonetaryAmountJsonSerializer.CURRENCY);
      jgen.writeString(value.getCurrency().getCurrencyCode());
      jgen.writeFieldName(MonetaryAmountJsonSerializer.NUMBER);
      jgen.writeString(value.getNumber().toString());
      jgen.writeEndObject();
    }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>For composite datatypes it is important to wrap the info as an object (<code>writeStartObject()</code> and <code>writeEndObject()</code>). <code>MonetaryAmount</code> provides the information we need by the <code>getCurrency()</code> and <code>getNumber()</code>. So that we can easily write them into the JSON data.</p>
</div>
</li>
<li>
<p>Next, we implement <code>MonetaryAmountJsonDeserializer</code> to define how a <code>MonetaryAmount</code> is deserialized back as Java object from JSON:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public final class MonetaryAmountJsonDeserializer extends AbstractJsonDeserializer&lt;MonetaryAmount&gt; {
  protected MonetaryAmount deserializeNode(JsonNode node) {
    BigDecimal number = getRequiredValue(node, MonetaryAmountJsonSerializer.NUMBER, BigDecimal.class);
    String currencyCode = getRequiredValue(node, MonetaryAmountJsonSerializer.CURRENCY, String.class);
    MonetaryAmount monetaryAmount =
        MonetaryAmounts.getAmountFactory().setNumber(number).setCurrency(currencyCode).create();
    return monetaryAmount;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For composite datatypes we extend from <a href="https://github.com/devonfw/devon4j/blob/develop/modules/rest/src/main/java/com/devonfw/module/rest/service/impl/json/AbstractJsonDeserializer.java"><code>AbstractJsonDeserializer</code></a> as this makes our task easier. So we already get a <code>JsonNode</code> with the parsed payload of our datatype. Based on this API it is easy to retrieve individual fields from the payload without taking care of their order, etc.
<code>AbstractJsonDeserializer</code> also provides methods such as <code>getRequiredValue</code> to read required fields and get them converted to the desired basis datatype. So we can easily read the amount and currency and construct an instance of <code>MonetaryAmount</code> via the official factory API.</p>
</div>
</li>
<li>
<p>Finally we need to register our custom (de)serializers with the following configuration code in the constructor of <a href="security.html#configure-json-mapping">ApplicationObjectMapperFactory</a>:+</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>  SimpleModule module = getExtensionModule();
  module.addDeserializer(MonetaryAmount.class, new MonetaryAmountJsonDeserializer());
  module.addSerializer(MonetaryAmount.class, new MonetaryAmountJsonSerializer());</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can read and write <code>MonetaryAmount</code> from and to JSON as expected.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="xml">3.12. XML</h3>
<div class="paragraph">
<p><a href="http://en.wikipedia.org/wiki/XML">XML</a> (Extensible Markup Language) is a W3C standard format for structured information. It has a large eco-system of additional standards and tools.</p>
</div>
<div class="paragraph">
<p>In Java there are many different APIs and frameworks for accessing, producing and processing XML. For the devonfw we recommend to use <a href="security.html#jaxb">JAXB</a> for mapping Java objects to XML and vice-versa. Further there is the popular <a href="http://docs.oracle.com/javase/7/docs/api/org/w3c/dom/package-summary.html">DOM API</a> for reading and writing smaller XML documents directly. When processing large XML documents <a href="http://en.wikipedia.org/wiki/StAX">StAX</a> is the right choice.</p>
</div>
<div class="sect3">
<h4 id="jaxb">3.12.1. JAXB</h4>
<div class="paragraph">
<p>We use <a href="http://en.wikipedia.org/wiki/Java_Architecture_for_XML_Binding">JAXB</a> to serialize Java objects to XML or vice-versa.</p>
</div>
<div class="sect4">
<h5 id="jaxb-and-inheritance">JAXB and Inheritance</h5>
<div class="paragraph">
<p>Use <code>@XmlSeeAlso</code> annotation to provide sub-classes.
See section "Collective Polymorphism" described <a href="https://dzone.com/articles/java-and-xml-part-3-jaxb">here</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="jaxb-custom-mapping">JAXB Custom Mapping</h5>
<div class="paragraph">
<p>In order to map custom <a href="guide-datatype.asciidoc">datatypes</a> or other types that do not follow the Java bean conventions, you need to define a custom mapping. If you create dedicated objects for the XML mapping you can easily avoid such situations. When this is not suitable use <code>@XmlJavaTypeAdapter</code> and provide an <code>XmlAdapter</code> implementation that handles the mapping.
For details see <a href="https://www.eclipse.org/eclipselink/documentation/2.6/moxy/advanced_concepts006.htm">here</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="security-4">3.12.2. Security</h4>
<div class="paragraph">
<p>To prevent XML External Entity attacks, follow <a href="https://docs.oracle.com/en/java/javase/11/security/java-api-xml-processing-jaxp-security-guide.html">JAXP Security Guide</a> and enable <a href="https://docs.oracle.com/en/java/javase/11/security/java-api-xml-processing-jaxp-security-guide.html#GUID-88B04BE2-35EF-4F61-B4FA-57A0E9102342">FSP</a>.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="soap">3.13. SOAP</h3>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/SOAP">SOAP</a> is a common protocol for <a href="guide-service-layer.asciidoc">services</a> that is rather complex and heavy. It allows to build inter-operable and well specified services (see WSDL). SOAP is transport neutral what is not only an advantage. We strongly recommend to use HTTPS transport and ignore additional complex standards like WS-Security and use established HTTP-Standards such as RFC2617 (and RFC5280).</p>
</div>
<div class="sect3">
<h4 id="jax-ws">3.13.1. JAX-WS</h4>
<div class="paragraph">
<p>For building web-services with Java we use the <a href="https://jcp.org/en/jsr/detail?id=224">JAX-WS</a> standard.
There are two approaches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>code first</p>
</li>
<li>
<p>contract first</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example in case you define a code-first service.</p>
</div>
<div class="sect4">
<h5 id="web-service-interface">Web-Service Interface</h5>
<div class="paragraph">
<p>We define a regular interface to define the API of the service and annotate it with JAX-WS annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@WebService
public interface TablemanagmentWebService {

  @WebMethod
  @WebResult(name = "message")
  TableEto getTable(@WebParam(name = "id") String id);

}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="web-service-implementation">Web-Service Implementation</h5>
<div class="paragraph">
<p>And here is a simple implementation of the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named
@WebService(endpointInterface = "com.devonfw.application.mtsj.tablemanagement.service.api.ws.TablemanagmentWebService")
public class TablemanagementWebServiceImpl implements TablemanagmentWebService {

  private Tablemanagement tableManagement;

  @Override
  public TableEto getTable(String id) {

    return this.tableManagement.findTable(id);
  }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="soap-custom-mapping">3.13.2. SOAP Custom Mapping</h4>
<div class="paragraph">
<p>In order to map custom <a href="guide-datatype.asciidoc">datatypes</a> or other types that do not follow the Java bean conventions, you need to write adapters for JAXB (see <a href="guide-xml.asciidoc">XML</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="soap-testing">3.13.3. SOAP Testing</h4>
<div class="paragraph">
<p>For testing SOAP services in general consult the <a href="guide-testing.asciidoc">testing guide</a>.</p>
</div>
<div class="paragraph">
<p>For testing SOAP services manually we strongly recommend <a href="http://www.soapui.org/">SoapUI</a>.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="logging">3.14. Logging</h3>
<div class="paragraph">
<p>We recommend to use <a href="http://www.slf4j.org/">SLF4J</a> as API for logging, that has become a de facto standard in Java as it has a much better design than <code>java.util.logging</code> offered by the JDK.
There are serveral implementations for SLF4J. For Spring applications our recommended implementation is <a href="http://logback.qos.ch/">Logback</a>. Quarkus uses JBoss Logging which provides a JBoss Log Manager implementation for SLF4J. For more information on logging in Quarkus, see the <a href="https://quarkus.io/guides/logging">Quarkus logging guide</a>.</p>
</div>
<div class="sect3">
<h4 id="logging-dependencies">3.14.1. Logging Dependencies</h4>
<div class="paragraph">
<p>To use Logback in your Spring application, you need to include the following dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;!-- SLF4J as logging API --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
  &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!-- Logback as logging implementation  --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
  &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!-- JSON logging for cloud-native log monitoring --&gt;
&lt;dependency&gt;
  &lt;groupId&gt;net.logstash.logback&lt;/groupId&gt;
  &lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In devon4j these dependencies are provided by the <a href="https://github.com/devonfw/devon4j/tree/master/modules/logging">devon4j-logging module</a>.</p>
</div>
<div class="paragraph">
<p>In Quarkus, SLF4J and the <a href="https://github.com/jboss-logging/slf4j-jboss-logmanager"><code>slf4j-jboss-logmanager</code></a> are directly included in the Quarkus core runtime and can be used out of the box.</p>
</div>
</div>
<div class="sect3">
<h4 id="logger-access">3.14.2. Logger Access</h4>
<div class="paragraph">
<p>The general pattern for accessing loggers from your code is a static logger instance per class using the following pattern:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class MyClass {
  private static final Logger LOG = LoggerFactory.getLogger(MyClass.class);
  ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For detailed documentation how to use the logger API check the <a href="http://www.slf4j.org/manual.html">SLF4j manual</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In case you are using <a href="https://github.com/devonfw/ide">devonfw-ide</a> and Eclipse you can just type <code>LOG</code> and hit <code>[ctrl][space]</code> to insert the code pattern including the imports into your class.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="lombok">Lombok</h5>
<div class="paragraph">
<p>In case you are using <a href="guide-lombok.asciidoc">Lombok</a>, you can simply use the <a href="https://projectlombok.org/api/lombok/extern/slf4j/Slf4j.html"><code>@Slf4j</code></a> annotation in your class. This causes Lombok to generate the logger instance for you.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="log-levels">3.14.3. Log-Levels</h4>
<div class="paragraph">
<p>We use a common understanding of the log-levels as illustrated by the following table.
This helps for better maintenance and operation of the systems.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. Log-levels</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Log-level</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
<th class="tableblock halign-left valign-top"><strong>Impact</strong></th>
<th class="tableblock halign-left valign-top"><strong>Active Environments</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FATAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only used for fatal errors that prevent the application to work at all (e.g. startup fails or shutdown/restart required)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator has to react immediately</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ERROR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An abnormal error indicating that the processing failed due to technical problems.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operator should check for known issue and otherwise inform development</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WARNING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A situation where something worked not as expected. E.g. a business exception or user validation failure occurred.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No direct reaction required. Used for problem analysis.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INFO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Important information such as context, duration, success/failure of request or process</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No direct reaction required. Used for analysis.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">all</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DEBUG</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Development information that provides additional context for debugging problems.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No direct reaction required. Used for analysis.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">development and testing</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRACE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Like DEBUG but exhaustive information and for code that is run very frequently. Will typically cause large log-files.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No direct reaction required. Used for problem analysis.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none (turned off by default)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Exceptions (with their stack trace) should only be logged on <code>FATAL</code> or <code>ERROR</code> level. For business exceptions typically a <code>WARNING</code> including the message of the exception is sufficient.</p>
</div>
<div class="sect4">
<h5 id="configuration-of-logback">Configuration of Logback</h5>
<div class="paragraph">
<p>The configuration of logback happens via the <code>logback.xml</code> file that you should place into <code>src/main/resources</code> of your app.
For details consult the <a href="http://logback.qos.ch/manual/configuration.html">logback configuration manual</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Logback also allows to overrule the configuration with a <code>logback-test.xml</code> file that you may put into <code>src/test/resources</code> or into a test-dependency.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="configuration-in-quarkus">Configuration in Quarkus</h5>
<div class="paragraph">
<p>The are several options you can set in the <code>application.properties</code> file to configure the behaviour of the logger in Quarkus. For a detailed overview, see the corresponding part of the <a href="https://quarkus.io/guides/logging#runtime-configuration">Quarkus guide</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="json-logging">3.14.4. JSON-logging</h4>
<div class="paragraph">
<p>For easy integration with <a href="guide-log-monitoring.asciidoc">log-monitoring</a>, we recommend that your app logs to <code>standard out</code> in JSON following <a href="https://jsonlines.org/">JSON Lines</a>.</p>
</div>
<div class="paragraph">
<p>In Spring applications, this can be achieved via <a href="https://github.com/logstash/logstash-logback-encoder">logstash-logback-encoder</a> (see <a href="security.html#dependencies">dependencies</a>). In Quarkus, it can be easily achieved using the <a href="https://github.com/quarkusio/quarkus/tree/main/extensions/logging-json">quarkus-logging-json</a> extension (see <a href="https://quarkus.io/guides/logging#json-logging">here</a> for more details).</p>
</div>
<div class="paragraph">
<p>This will produce log-lines with the following format (example formatted for readability):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">{
  "timestamp":"2000-12-31T23:59:59.999+00:00",
  "@version":"1",
  "message":"Processing 4 order(s) for shipment",
  "logger_name":"com.myapp.order.logic.UcManageOrder",
  "thread_name":"http-nio-8081-exec-6",
  "level":"INFO",
  "level_value":20000,
  "appname":"myapp",
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="adding-custom-values-to-json-log-with-logstash">Adding custom values to JSON log with Logstash</h5>
<div class="paragraph">
<p>The JSON encoder even supports logging custom properties for your <a href="guide-log-monitoring.asciidoc">log-monitoring</a>.
The <em>trick</em> is to use the class <code>net.logstash.logback.argument.StructuredArguments</code> for adding the arguments to you log message, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">import static net.logstash.logback.argument.StructuredArguments.v;

...
    LOG.info("Request with {} and {} took {} ms.", v("url", url), v("status", statusCode), v("duration", millis));
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will produce the a JSON log-line with the following properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">...
  "message":"Request with url=https://api/service/v1/ordermanagement/order and status=200 took duration=251 ms",
  "url":"https://api/service/v1/ordermanagement/order",
  "status":"200",
  "duration":"251",
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can quickly see besides the human readable <code>message</code> you also have the structured properties <code>url</code>, <code>status</code> and <code>duration</code> that can be extremly valuable to configure dashboards in your <a href="guide-log-monitoring.asciidoc">log-monitoring</a> that visualize success/failure ratio as well as performance of your requests.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="classic-log-files">3.14.5. Classic log-files</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<strong>In devon4j, we strongly recommend using JSON logging instead of classic log files. The following section refers only to devon4j Spring applications that use Logback.</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Even though we do not recommend anymore to write classical log-files to the local disc, here you can still find our approach for it.</p>
</div>
<div class="sect4">
<h5 id="maven-integration">Maven-Integration</h5>
<div class="paragraph">
<p>In the <code>pom.xml</code> of your application add this dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;com.devonfw.java&lt;/groupId&gt;
  &lt;artifactId&gt;devon4j-logging&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above dependency already adds transitive dependencies to SLF4J and logback.
Also it comes with <a href="https://github.com/devonfw/devon4j/tree/master/modules/logging/src/main/resources/com/devonfw/logging/logback">configration snipplets</a> that can be included from your <code>logback.xml</code> file (see <a href="configuration.html">configuration</a>).</p>
</div>
<div class="paragraph">
<p>The <code>logback.xml</code> to write regular log-files can look as following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;configuration scan="true" scanPeriod="60 seconds"&gt;
  &lt;property resource="com/devonfw/logging/logback/application-logging.properties" /&gt;
  &lt;property name="appname" value="MyApp"/&gt;
  &lt;property name="logPath" value="../logs"/&gt;
  &lt;include resource="com/devonfw/logging/logback/appenders-file-all.xml" /&gt;
  &lt;include resource="com/devonfw/logging/logback/appender-console.xml" /&gt;

  &lt;root level="DEBUG"&gt;
    &lt;appender-ref ref="ERROR_APPENDER"/&gt;
    &lt;appender-ref ref="INFO_APPENDER"/&gt;
    &lt;appender-ref ref="DEBUG_APPENDER"/&gt;
    &lt;appender-ref ref="CONSOLE_APPENDER"/&gt;
  &lt;/root&gt;

  &lt;logger name="org.springframework" level="INFO"/&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The provided <code>logback.xml</code> is configured to use variables defined on the <code>config/application.properties</code> file.
On our example, the log files path point to <code>../logs/</code> in order to log to tomcat log directory when starting tomcat on the bin folder.
Change it according to your custom needs.</p>
</div>
<div class="listingblock">
<div class="title">Listing 8. config/application.properties</div>
<div class="content">
<pre class="highlight"><code class="language-properties" data-lang="properties">log.dir=../logs/</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="log-files">Log Files</h5>
<div class="paragraph">
<p>The classical approach uses the following log files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Error Log</strong>: Includes log entries to detect errors.</p>
</li>
<li>
<p><strong>Info Log</strong>: Used to analyze system status and to detect bottlenecks.</p>
</li>
<li>
<p><strong>Debug Log</strong>: Detailed information for error detection.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The log file name pattern is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>«LOGTYPE»_log_«HOST»_«APPLICATION»_«TIMESTAMP».log</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. Segments of Logfilename</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Element</strong></th>
<th class="tableblock halign-left valign-top"><strong>Value</strong></th>
<th class="tableblock halign-left valign-top"><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">«LOGTYPE»</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">info, error, debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of log file</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">«HOST»</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e.g. mywebserver01</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of server, where logs are generated</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">«APPLICATION»</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e.g. myapp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of application, which causes logs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">«TIMESTAMP»</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">YYYY-MM-DD_HH00</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">date of log file</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Example:
error_log_mywebserver01_myapp_2013-09-16_0900.log</p>
</div>
<div class="paragraph">
<p>Error log from mywebserver01 at application myapp at 16th September 2013 9pm.</p>
</div>
</div>
<div class="sect4">
<h5 id="output-format">Output format</h5>
<div class="paragraph">
<p>We use the following output format for all log entries to ensure that searching and filtering of log entries work consistent for all logfiles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[D: «timestamp»] [P: «priority»] [C: «NDC»][T: «thread»][L: «logger»]-[M: «message»]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>D</strong>: Date (Timestamp in ISO8601 format e.g. 2013-09-05 16:40:36,464)</p>
</li>
<li>
<p><strong>P</strong>: Priority (the log level)</p>
</li>
<li>
<p><strong>C</strong>: <a href="security.html#correlation-id">Correlation ID</a> (ID to identify users across multiple systems, needed when application is distributed)</p>
</li>
<li>
<p><strong>T</strong>: Thread (Name of thread)</p>
</li>
<li>
<p><strong>L</strong>: Logger name (use class name)</p>
</li>
<li>
<p><strong>M</strong>: Message (log message)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[D: 2013-09-05 16:40:36,464] [P: DEBUG] [C: 12345] [T: main] [L: my.package.MyClass]-[M: My message...]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When using devon4j-logging, this format is used by default. To achieve this format in Quarkus, set <code>quarkus.log.console.format=[D: %d] [P: %p] [C: %X] [T: %t] [L: %c] [M: %m]%n</code> in your properties.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="correlation-id">Correlation ID</h5>
<div class="paragraph">
<p>In order to correlate separate HTTP requests to services belonging to the same user / session, we provide a servlet filter called <code>DiagnosticContextFilter</code>.
This filter takes a provided correlation ID from the HTTP header <code>X-Correlation-Id</code>.
If none was found, it will generate a new correlation id as <code>UUID</code>.
This correlation ID is added as MDC to the logger.
Therefore, it will then be included to any log message of the current request (thread).
Further concepts such as <a href="guide-service-client.asciidoc">service invocations</a> will pass this correlation ID to subsequent calls in the application landscape. Hence you can find all log messages related to an initial request simply via the correlation ID even in highly distributed systems.</p>
</div>
</div>
<div class="sect4">
<h5 id="security-5">Security</h5>
<div class="paragraph">
<p>In order to prevent <a href="https://owasp.org/www-community/attacks/Log_Injection">log forging</a> attacks you can simply use the suggested <a href="security.html#json-logging">JSON logging</a> format.
Otherwise you can use <code>com.devonfw.module.logging.common.impl.SingleLinePatternLayout</code> as demonstrated  <a href="https://github.com/devonfw/devon4j/blob/master/modules/logging/src/main/resources/com/devonfw/logging/logback/appender-file-warn.xml">here</a> in order to prevent such attacks.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="monitoring">3.15. Monitoring</h3>
<div class="paragraph">
<p>For monitoring a complex application landscape it is crucial to have an exact overview which applications are up and running and which are not and why.
In devonfw we only focus on topics which are most important when developing production-ready applications.
On a high level view we strongly suggest to separate the application to be monitored from the <code>monitoring system</code> itself.
Therefore, your application should concentrate on providing app specific data for the monitoring.
Aspects such as aggregation, visualization, search, alerting, etc. should be addressed outside of your app by a monitoring system product.
There are many products providing such a monitoring system like <a href="https://checkmk.com">checkmk</a>, <a href="https://icinga.com/">icinga</a>, <a href="https://skywalking.apache.org/">SkyWalking</a>, etc.
Please note that there is a huge list of such products and devonfw is not biased or aims to make a choice for you.
Instead please search and find the products that fit best for your requirements and infrastructure.</p>
</div>
<div class="sect3">
<h4 id="types-of-monitoring">3.15.1. Types of monitoring</h4>
<div class="paragraph">
<p>As monitoring coveres a lot of different aspects we separate the following types of monitoring and according data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><a href="guide-log-monitoring.asciidoc">Log-monitoring</a></strong><br>
is about collecting and monitoring the logs of all apps and containers in your IT landscape. It is suitable for events such as an HTTP request with its URL, resulting status code and duration in milliseconds. Your monitoring may not react to such data in realtime. Instead it may take a delay of one or a few seconds.</p>
</li>
<li>
<p><strong>Infrastructure monitoring</strong><br>
is about monitoring the (hardware) infrastructure with measures like usage of CPU, memory, disc-space, etc. This is a pure operational task and your app should have nothing to do with this. In other words it is a waste if your app tries to monitor these aspects as existing products can do this much better and your app will only see virtual machines and is unable to see the physical infrastructure.</p>
</li>
<li>
<p><strong><a href="security.html#health-check">Health check</a></strong><br>
is about providing internal data about the current health of your app. Typically you provide sensors with health status per component or interface to neighbour service (database connectivity, etc.).</p>
</li>
<li>
<p><strong><a href="guide-apm.asciidoc">Application Performance Monitoring</a></strong><br>
is about measuring performance and tracing down performance issues.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="health-check">3.15.2. Health-Check</h4>
<div class="paragraph">
<p>The idea of a health check is to prodvide monitoring data about the current health status of your application.
This allows to integrate this specific data into the monitoring system used for your IT landscape.
In order to keep the monitoring simple and easy to integreate consider using the following best practices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use simple and established protocols such as <a href="guide-rest.asciidoc">REST</a> instead of <a href="guide-jmx.asciidoc">JMX via RMI</a>.</p>
</li>
<li>
<p>Considuer using recent standards such as <a href="https://github.com/eclipse/microprofile-health">microprofile-health</a>.</p>
</li>
<li>
<p>Consider to drop <a href="guide-access-control.asciidoc">access-control</a> for your monitoring interfaces and for security prevent external access to it in your infrastructure (loadbalancers or gateways). Monitoring is only for usage within an IT landscape internally. It does not make sense for externals and end-users to access your app for reading monitoring data from a random node decided by a loadbalancer. Furhter, external access can easily lead to <a href="https://owasp.org/www-project-top-ten/2017/A3_2017-Sensitive_Data_Exposure">sensitive data exposure</a>.</p>
</li>
<li>
<p>Consider to define different end-points per usage-scenario. So if you want the loadbalancer to ask your app monitoring for availability of each node then create a separate service URL that only provides <code>OK</code> or anything else for failure (<code>NOK</code>, 404, 500, timeout). Do not mix this with a health-check that needs more detailed information.</p>
</li>
<li>
<p>Also do not forget about basic features such as prodiving the name and the release version of your application.</p>
</li>
<li>
<p>Be careful to automate decisions based on monitoring and health checks. It easily turns out to be stupid if you automatically restart your pod or container because of some monitoring indicator. In the worst case a failure of a central component will cause your health-check to report down for all apps and as a result all your containers will be restarted frequently. Indead of curing problems such decisions will cause much more harm and trouble.</p>
</li>
<li>
<p>Avoid causing reasonable load with your monitoring and health-check itself. In many cases it is better to use <a href="guide-log-monitoring.asciidoc">log-monitoring</a> or to collect monitoring data from use-cases that happen in your app anyway. If you create dummy read and write requests in your monitoring implementation you will easily turn it into a DOS-attack.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For <a href="spring.asciidoc">spring</a> you can simply integrate app monitoring and health check via <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html">spring-boot-actuator</a>.</p>
</div>
<div class="paragraph">
<p>For <a href="quarkus.asciidoc">quarkus</a> you can simply integrate app monitoring via <a href="https://quarkus.io/guides/micrometer">micrometer</a> or <a href="https://quarkus.io/guides/smallrye-metrics">smallrye-metrics</a> and health check via <a href="https://quarkus.io/guides/smallrye-health">smallrye-health</a>.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="log-monitoring">3.16. Log-Monitoring</h3>
<div class="paragraph">
<p>Log-monitoring is an aspect of <a href="guide-monitoring.asciidoc">monitoring</a> with a strict focus on <a href="guide-logging.asciidoc">logging</a>.
With trends towards IT landscapes with many but much smaller apps the classicial approach to write log-files to the disc and let operators read those via SSH became entirely obsolete.
Nowadays we have up to hundreds or even thousands of apps that themselves are clustered into multiple nodes.
Therefore you should establish a centralized log monitoring system in the environment and let all your nodes log directly into that system.
This approach gives the following benefits:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>all log information available in one place</p>
</li>
<li>
<p>full-text search accross all logfiles</p>
</li>
<li>
<p>ability to automatically trigger alerts from specific log patterns</p>
</li>
<li>
<p>ability to do data-mining on logs and visualize in dashboards</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="options-for-log-monitoring">3.16.1. Options for log-monitoring</h4>
<div class="paragraph">
<p>Typical products for such a log monitoring system are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.elastic.co/de/what-is/elk-stack">ELK-Stack</a></p>
</li>
<li>
<p><a href="https://www.graylog.org/">Graylog</a></p>
</li>
<li>
<p><a href="https://www.splunk.com/">Splunk</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In devonfw we are not biased for any of these products. Therefore, feel free to make your choice according to the requirements of your project.</p>
</div>
<div class="paragraph">
<p>For Quarkus applications, you can get an insight into the topic by reading the guide about <a href="https://quarkus.io/guides/centralized-log-management">centralized log management</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="api-for-log-monitoring">3.16.2. API for log-monitoring</h4>
<div class="paragraph">
<p>The "API" for logging to a log-monitoring system for your app is pretty simple:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Write your logs to standard out.</p>
</li>
<li>
<p>Use <a href="guide-logging.asciidoc#json-logging">JSON logging</a> as format.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then the container infrastructure can automatically collect your logs from standard out and directly feed those into the log monitoring system.
As a result, your app does not need to know anything about your log monitoring system and logging becomes most simple.
Further, if you do not write log-files anymore, you might not need to write any other files and therefore may not even need write permissions on the filesystem of your container.
In such case an attacker who may find a vulnerability in your app will have less attack surface in case he can not write any file.</p>
</div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="application-performance-management">3.17. Application Performance Management</h3>
<div class="paragraph">
<p>This guide gives hints how to manage, monitor and analyse performance of Java applications.</p>
</div>
<div class="sect3">
<h4 id="temporary-analysis">3.17.1. Temporary Analysis</h4>
<div class="paragraph">
<p>If you are facing performance issues and want to do a punctual analysis we recommend you to use <a href="https://glowroot.org/">glowroot</a>. It is ideal in cases where monitoring in your local development environment is suitable. However, it is also possible to use it in your test environment. It is entirely free and open-source. Still it is very powerful and helps to trace down bottlenecks. To get a first impression of the tool take a look at the <a href="https://demo.glowroot.org">demo</a>.</p>
</div>
<div class="sect4">
<h5 id="jeewtp">JEE/WTP</h5>
<div class="paragraph">
<p>In case you are forced to use an <a href="guide-jee.asciidoc">JEE application server</a> and want to do a temporary analysis you can double click your server instance from the servers view in Eclipse and click on the link <code>Open launch configuration</code> in order to add the <code>-javaagent</code> JVM option.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="regular-analysis">3.17.2. Regular Analysis</h4>
<div class="paragraph">
<p>In case you want to manage application performance regularly we recommend to use <a href="https://github.com/javamelody/javamelody#javamelody">JavaMelody</a> that can be integrated into your application. More information on javamelody is available on the <a href="https://github.com/javamelody/javamelody/wiki">JavaMelody Wiki</a></p>
</div>
</div>
<div class="sect3">
<h4 id="alternatives">3.17.3. Alternatives</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/naver/pinpoint">PinPoint</a></p>
</li>
<li>
<p><a href="https://openapm.io/">OpenAPM</a></p>
</li>
<li>
<p><a href="https://www.appdynamics.com/java/">AppDynamics</a></p>
</li>
<li>
<p><a href="https://www.zabbix.com/features">Zabbix</a></p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="security-6">3.18. Security</h3>
<div class="paragraph">
<p>Security is todays most important cross-cutting concern of an application and an enterprise IT-landscape. We seriously care about security and give you detailed guides to prevent pitfalls, vulnerabilities, and other disasters. While many mistakes can be avoided by following our guidelines you still have to consider security and think about it in your design and implementation. The security guide will not only automatically prevent you from any harm, but will provide you hints and best practices already used in different software products.</p>
</div>
<div class="paragraph">
<p>An important aspect of security is proper authentication and authorization as described in <a href="guide-access-control.asciidoc">access-control</a>. In the following we discuss about potential vulnerabilities and protection to prevent them.</p>
</div>
<div class="sect3">
<h4 id="vulnerabilities-and-protection">3.18.1. Vulnerabilities and Protection</h4>
<div class="paragraph">
<p>Independent from classical authentication and authorization mechanisms there are many common pitfalls that can lead to vulnerabilities and security issues in your application such as XSS, CSRF, SQL-injection, log-forging, etc. A good source of information about this is the <a href="https://www.owasp.org">OWASP</a>.
We address these common threats individually in <em>security</em> sections of our technological guides as a concrete solution to prevent an attack typically depends on the according technology. The following table illustrates common threats and contains links to the solutions and protection-mechanisms provided by the devonfw:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. Security threats and protection-mechanisms</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Threat</strong></th>
<th class="tableblock halign-left valign-top"><strong>Protection</strong></th>
<th class="tableblock halign-left valign-top"><strong>Link to details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A1-Injection.html">A1 Injection</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">validate input, escape output, use proper frameworks</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-jpa.asciidoc#security">SQL Injection</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A2-Broken_Authentication.html">A2 Broken Authentication</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encrypt all channels, use a central identity management with strong password-policy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-access-control.asciidoc#authentication">Authentication</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A3-Sensitive_Data_Exposure.html">A3 Sensitive Data Exposure</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use secured exception facade, design your data model accordingly</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-service-layer.asciidoc#rest-exception-handling">REST exception handling</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A4-XML_External_Entities_(XXE).html">A4 XML External Entities</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prefer JSON over XML, ensure <a href="https://docs.oracle.com/en/java/javase/11/security/java-api-xml-processing-jaxp-security-guide.html">FSP</a> when parsing (external) XML</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-xml.asciidoc">XML guide</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A5-Broken_Access_Control.html">A5 Broken Access Control</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ensure proper authorization for all use-cases, use <code>@DenyAll</code> as default to enforce</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-access-control.asciidoc">Access-control guide</a> especially <a href="guide-access-control.asciidoc#configuration-on-java-method-level">method authorization</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A6-Security_Misconfiguration.html">A6 Security Misconfiguration</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use devon4j application template and guides to avoid</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tutorial-newapp.asciidoc">tutorial-newapp</a> and <a href="guide-configuration.asciidoc#security">sensitive configuration</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A7-Cross-Site_Scripting_(XSS).html">A7 Cross-Site Scripting</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">prevent injection (see A1) for HTML, JavaScript and CSS and understand same-origin-policy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-client-layer.asciidoc">client-layer</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A8-Insecure_Deserialization.html">A8 Insecure Deserialization</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use simple and established serialization formats such as JSON, prevent generic deserialization (for polymorphic types)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-json.asciidoc">JSON guide</a> especially <a href="guide-json.asciidoc#json-and-inheritance">inheritence</a>, <a href="guide-xml.asciidoc">XML guide</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A9-Using_Components_with_Known_Vulnerabilities.html">A9 Using Components with Known Vulnerabilities</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">subscribe to security newsletters, recheck products and their versions continuously, use devonfw dependency management</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://cve.mitre.org/news/newsletter.html">CVE newsletter</a> and <a href="security.html#dependency-check">dependency check</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A10-Insufficient_Logging%252526Monitoring.html">A10 Insufficient_Logging &amp; Monitoring</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ensure to log all security related events (login, logout, errors), establish effective monitoring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-logging.asciidoc">Logging guide</a> and <a href="guide-monitoring.asciidoc">monitoring guide</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-chapter-ghana/assets/slides/IDOR.pdf">Insecure Direct Object References</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Using direct object references (IDs) only with appropriate authorization</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-logic-layer.asciidoc#direct-object-references">logic-layer</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-community/attacks/csrf">Cross-Site Request Forgery (CSRF)</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">secure mutable service operations with an explicit CSRF security token sent in HTTP header and verified on the server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-csrf.asciidoc">CSRF guide</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-community/attacks/Log_Injection">Log-Forging</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Escape newlines in log messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="guide-logging.asciidoc#security">logging security</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://owasp.org/www-pdf-archive//OWASP_LA_New_OWASP_Top_10_David_Caissy_2017_07.pdf">Unvalidated Redirects and Forwards</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Avoid using redirects and forwards, in case you need them do a security audit on the solution.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">devonfw proposes to use rich-clients (SPA/RIA). We only use redirects for login in a safe way.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="advanced-security">3.18.2. Advanced Security</h4>
<div class="paragraph">
<p>While OWASP Top 10 covers the basic aspects of application security, there are advanced standards such as <code>AVS</code>.
In devonfw we address this in the <a href="https://github.com/devonfw/security/wiki">
Application Security Quick Solution Guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="tools">3.18.3. Tools</h4>
<div class="sect4">
<h5 id="dependency-check">Dependency Check</h5>
<div class="paragraph">
<p>To address the thread <code>Using Components with Known Vulnerabilities</code> we recomment to use <a href="https://www.owasp.org/index.php/OWASP_Dependency_Check">OWASP dependency check</a> that ships with a maven plugin and can analyze your dependencies for known <a href="https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures">CVE</a>s.
In order to run this check, you can simply call this command on any maven project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn org.owasp:dependency-check-maven:6.1.5:aggregate</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The version is just for completeness. You should check yourself for using a recent version of the plugin.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you build an devon4j spring application from our <a href="tutorial-newapp.asciidoc">app-template</a> you can activate the dependency check even easier with the <code>security</code> profile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mvn clean install -P security</code></pre>
</div>
</div>
<div class="paragraph">
<p>This does not run by default as it causes some overhead for the build performance. However, consider to build this in your CI at least nightly.
After the dependency check is performed, you will find the results in <code>target/dependency-check-report.html</code> of each module. The report will also be generated when the site is build (<code>mvn site</code>) even without the profile.</p>
</div>
</div>
<div class="sect4">
<h5 id="penetration-testing">Penetration Testing</h5>
<div class="paragraph">
<p>For penetration testing (testing for vulnerabilities) of your web application, we recommend the following tools:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project">ZAP</a> (OWASP Zed Attack Proxy Project)</p>
</li>
<li>
<p><a href="http://sqlmap.org/">sqlmap</a> (or <a href="https://github.com/PaulSec/HQLmap">HQLmap</a>)</p>
</li>
<li>
<p><a href="https://nmap.org/">nmap</a></p>
</li>
<li>
<p>See the marvelous presentation <a href="https://jaxenter.com/security-open-source-toolbox-video-151314.html">Toolbox of a security professional</a> from <a href="https://www.Christian-Schneider.net">Christian Schneider</a>.</p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
</div>
<div class="sect2">
<h3 id="cors-support">3.19. CORS support</h3>
<div class="paragraph">
<p>When you are developing Javascript client and server application separately, you have to deal with cross domain issues. We have to request from a origin domain distinct to target domain and browser does not allow this.</p>
</div>
<div class="paragraph">
<p>So , we need to prepare server side to accept request from other domains. We need to cover the following points:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Accept request from other domains.</p>
</li>
<li>
<p>Accept devonfw used headers like <code>X-CSRF-TOKEN</code> or <code>correlationId.</code></p>
</li>
<li>
<p>Be prepared to receive secured request (cookies).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is important to note that if you are using security in your request (sending cookies) you have to set  <code>withCredentials</code> flag to <code>true</code> in your client side request and deal with special IE8 characteristics.</p>
</div>
<div class="paragraph">
<p>For more information about CORS see <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">here</a>. Information about the CORS headers can be found <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers#cors">here</a>.</p>
</div>
<div class="sect3">
<h4 id="configuring-cors-support">3.19.1. Configuring CORS support</h4>
<div class="paragraph">
<p>To enable CORS support for your application, see the advanced guides. For Spring applications see <a href="spring/guide-cors-spring.asciidoc">here</a>. For Quarkus follow the <a href="https://quarkus.io/guides/http-reference#cors-filter">official Quarkus guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuration-with-service-mesh">3.19.2. Configuration with service mesh</h4>
<div class="paragraph">
<p>If you are using a service mesh, you can also define your CORS policy directly there. Here is an example from <a href="https://istio.io/latest/docs/reference/config/networking/virtual-service/#CorsPolicy">Istio</a>.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="java-development-kit">3.20. Java Development Kit</h3>
<div class="paragraph">
<p>The <a href="https://en.wikipedia.org/wiki/Java_Development_Kit">Java Development Kit</a> is an implementation of the Java platform. It provides the <a href="https://en.wikipedia.org/wiki/Java_virtual_machine">Java Virtual Machine</a> (JVM) and the Java Runtime Environment (JRE).</p>
</div>
<div class="sect3">
<h4 id="editions">3.20.1. Editions</h4>
<div class="paragraph">
<p>The JDK exists in different editions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://openjdk.java.net/">OpenJDK</a> is a free and open-source edition of the JDK.</p>
</li>
<li>
<p><a href="https://www.oracle.com/technetwork/java/javase/overview/index.html">OracleJDK</a> is a commercial edition of the JDK.</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/List_of_Java_virtual_machines">Various alternative JDK editions</a> either commercial (e.g. IBM&#8217;s JVM) or open-source.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As Java is evolving and also complex maintaining a JVM requires a lot of energy.
Therefore many alternative JDK editions are unable to cope with this and support latest Java versions and according compatibility.
Unfortunately OpenJDK only maintains a specific version of Java for a relative short period of time before moving to the next major version.
In the end, this technically means that OpenJDK is continuous beta and can not be used in production for reasonable software projects.
As OracleJDK changed its licensing model and can not be used for commercial usage even during development, things can get tricky.
You may want to use OpenJDK for development and OracleJDK only in production.
However, e.g. OpenJDK 11 never released a version that is stable enough for reasonable development (e.g. javadoc tool is <a href="https://bugs.openjdk.java.net/browse/JDK-8212233">broken</a> and fixes are not available of OpenJDK 11 - fixed in 11.0.3 what is only available as OracleJDK 11 or you need to go to OpenJDK 12+, what has other bugs) so in the end there is no working release of OpenJDK 11.
This more or less forces you to use OracleJDK what requires you to buy a subscription so you can use it for commercial development.
However, there is <a href="https://github.com/AdoptOpenJDK">AdoptOpenJDK</a> that provides forked releases of OpenJDK with bug-fixes what might be an option.
Anyhow, as you want to have your development environment close to production, the productively used JDK (most likely OracleJDK) should be preferred also for development.</p>
</div>
</div>
<div class="sect3">
<h4 id="upgrading">3.20.2. Upgrading</h4>
<div class="paragraph">
<p>Until Java 8 compatibility was one of the key aspects for Java version updates (after the mess on the Swing updates with Java2 many years ago).
However, Java 9 introduced a lot of breaking changes.
This documentation wants to share the experience we collected in devonfw when upgrading from Java 8 to newer versions.
First of all we separate runtime changes that you need if you want to build your software with JDK 8 but such that it can also run on newer versions (e.g. JRE 11)
from changes required to also build your software with more recent JDKs (e.g. JDK 11 or 12).</p>
</div>
<div class="sect4">
<h5 id="runtime-changes">Runtime Changes</h5>
<div class="paragraph">
<p>This section describes required changes to your software in order to make it run also with versions newer than Java 8.</p>
</div>
<div class="sect5">
<h6 id="classes-removed-from-jdk">Classes removed from JDK</h6>
<div class="paragraph">
<p>The first thing that most users hit when running their software with newer Java versions is a <code>ClassNotFoundException</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Caused by: java.lang.ClassNotFoundException: javax.xml.bind.JAXBException</code></pre>
</div>
</div>
<div class="paragraph">
<p>As Java 9 introduced a module system with <a href="https://www.baeldung.com/project-jigsaw-java-modularity">Jigsaw</a>, the JDK that has been a monolithic mess is now a well-defined set of structured modules.
Some of the classes that used to come with the JDK moved to modules that where not available by default in Java 9 and have even been removed entirely in later versions of Java.
Therefore you should simply treat such code just like any other 3rd party component that you can add as a (maven) dependency.
The following table gives you the required hints to make your software work even with such classes / modules removed from the JDK (please note that the specified version is just a suggestion that worked, feel free to pick a more recent or more appropriate version):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 7. Dependencies for classes removed from Java 8 since 9+</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Class</strong></th>
<th class="tableblock halign-left valign-top"><strong>GroupId</strong></th>
<th class="tableblock halign-left valign-top"><strong>ArtifactId</strong></th>
<th class="tableblock halign-left valign-top"><strong>Version</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.xml.bind.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.xml.bind</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jaxb-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.3.1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.sun.xml.bind.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.glassfish.jaxb</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jaxb-runtime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.3.1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.activation.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.activation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.activation-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.2.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.transaction.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.transaction</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.transaction-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.2</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.xml.ws.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.xml.ws</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jaxws-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.3.1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.jws.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.jws</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.jws-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.annotation.*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.annotation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javax.annotation-api</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1.3.2</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="3rd-party-updates">3rd Party Updates</h6>
<div class="paragraph">
<p>Further, internal and inofficial APIs (e.g. <code>sun.misc.Unsafe</code>) have been removed.
These are typically not used by your software directly but by low-level 3rd party libraries like <code>asm</code> that need to be updated.
Also simple things like the Java version have changed (from <code>1.8.x</code> to <code>9.x</code>, <code>10.x</code>, <code>11.x</code>, <code>12.x</code>, etc.).
Some 3rd party libraries were parsing the Java version in a very naive way making them unable to be used with Java 9+:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Caused by: java.lang.NullPointerException
   at org.apache.maven.surefire.shade.org.apache.commons.lang3.SystemUtils.isJavaVersionAtLeast (SystemUtils.java:1626)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore the following table gives an overview of common 3rd party libraries that have been affected by such breaking changes and need to be updated to at least the specified version:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 8. Minimum recommended versions of common 3rd party for Java 9+</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>GroupId</strong></th>
<th class="tableblock halign-left valign-top"><strong>ArtifactId</strong></th>
<th class="tableblock halign-left valign-top"><strong>Version</strong></th>
<th class="tableblock halign-left valign-top"><strong>Issue</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.commons</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>commons-lang3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.7</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://issues.apache.org/jira/browse/LANG-1365">LANG-1365</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cglib</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cglib</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.2.9</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/cglib/cglib/issues/102">102</a>, <a href="https://github.com/cglib/cglib/issues/93">93</a>, <a href="https://github.com/cglib/cglib/issues/133">133</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.ow2.asm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>asm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>7.1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/eclipse/jetty.project/issues/2941">2941</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.javassist</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>javassist</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.25.0-GA</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/jboss-javassist/javassist/issues/194">194</a>, <a href="https://github.com/jboss-javassist/javassist/issues/228">228</a>, <a href="https://github.com/jboss-javassist/javassist/issues/246">246</a>, <a href="https://github.com/jboss-javassist/javassist/issues/171">171</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="resourcebundles">ResourceBundles</h6>
<div class="paragraph">
<p>For internationalization (i18n) and localization (l10n) <code>ResourceBundle</code> is used for language and country specific texts and configurations as properties (e.g. <code>MyResourceBundle_de.properties</code>). With Java modules there are changes and impacts you need to know to get things working. The most important change is documented in the <a href="https://docs.oracle.com/javase/9/docs/api/java/util/ResourceBundle.html#bundleprovider">JavaDoc of ResourceBundle</a>. However, instead of using <a href="https://docs.oracle.com/javase/9/docs/api/java/util/spi/ResourceBundleProvider.html">ResourceBundleProvider</a> and refactoring your entire code causing incompatibilities, you can simply put the resource bundles in a regular JAR on the classpath rather than a named module (or into the lauching app).
If you want to implement (new) Java modules with i18n support, you can have a look at <a href="https://github.com/m-m-m/nls#mmm-nls">mmm-nls</a>.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="buildtime-changes">Buildtime Changes</h5>
<div class="paragraph">
<p>If you also want to change your build to work with a recent JDK you also need to ensure that test frameworks and maven plugins properly support this.</p>
</div>
<div class="sect5">
<h6 id="findbugs">Findbugs</h6>
<div class="paragraph">
<p>Findbugs does not work with Java 9+ and is actually a dead project.
The new findbugs is <a href="https://spotbugs.github.io/">SpotBugs</a>.
For maven the new solution is <a href="https://spotbugs.github.io/spotbugs-maven-plugin/">spotbugs-maven-plugin</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;plugin&gt;
  &lt;groupId&gt;com.github.spotbugs&lt;/groupId&gt;
  &lt;artifactId&gt;spotbugs-maven-plugin&lt;/artifactId&gt;
  &lt;version&gt;3.1.11&lt;/version&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="test-frameworks">Test Frameworks</h6>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 9. Minimum recommended versions of common 3rd party test frameworks for Java 9+</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>GroupId</strong></th>
<th class="tableblock halign-left valign-top"><strong>ArtifactId</strong></th>
<th class="tableblock halign-left valign-top"><strong>Version</strong></th>
<th class="tableblock halign-left valign-top"><strong>Issue</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.mockito</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>mockito-core</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.23.4</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/mockito/mockito/issues/1419">1419</a>, <a href="https://github.com/mockito/mockito/issues/1696">1696</a>, <a href="https://github.com/mockito/mockito/issues/1607">1607</a>, <a href="https://github.com/mockito/mockito/issues/1594">1594</a>, <a href="https://github.com/mockito/mockito/issues/1577">1577</a>, <a href="https://github.com/mockito/mockito/issues/1482">1482</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="maven-plugins">Maven Plugins</h6>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 10. Minimum recommended versions of common maven plugins for Java 9+</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>GroupId</strong></th>
<th class="tableblock halign-left valign-top"><strong>ArtifactId</strong></th>
<th class="tableblock halign-left valign-top"><strong>(min.) Version</strong></th>
<th class="tableblock halign-left valign-top"><strong>Issue</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.maven.plugins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maven-compiler-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.8.1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.maven.plugins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maven-surefire-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.22.2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://issues.apache.org/jira/browse/SUREFIRE-1439">SUREFIRE-1439</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.maven.plugins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maven-surefire-report-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2.22.2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://issues.apache.org/jira/browse/SUREFIRE-1439">SUREFIRE-1439</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.maven.plugins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maven-archetype-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.1.0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.maven.plugins</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>maven-javadoc-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>3.1.0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.jacoco</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jacoco-maven-plugin</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0.8.3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/jacoco/jacoco/issues/663">663</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="maven-usage">Maven Usage</h6>
<div class="paragraph">
<p>With Java modules you can not run Javadoc standalone anymore or you will get this error when running <code>mvn javadoc:javadoc</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>[ERROR] Failed to execute goal org.apache.maven.plugins:maven-javadoc-plugin:3.1.1:javadoc (default-cli) on project mmm-base: An error has occurred in Javadoc report generation:
[ERROR] Exit code: 1 - error: module not found: io.github.mmm.base
[ERROR]
[ERROR] Command line was: /projects/mmm/software/java/bin/javadoc @options @packages @argfile</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a solution or workaround you need to include the <code>compile</code> goal into your build lifecycle so the module-path is properly configured:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>mvn compile javadoc:javadoc</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sources-and-links">3.20.3. Sources and Links</h4>
<div class="paragraph">
<p>We want to give credits and say thanks to the following articles that have been there before and helped us on our way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://blog.codefx.org/java/java-9-migration-guide/">Java 9 Migration Guide: The Seven Most Common Challenges</a></p>
</li>
<li>
<p><a href="https://medium.com/criciumadev/its-time-migrating-to-java-11-5eb3868354f9">It’s time! Migrating to Java 11</a></p>
</li>
<li>
<p><a href="https://winterbe.com/posts/2018/08/29/migrate-maven-projects-to-java-11-jigsaw/">Migrate Maven Projects to Java 11</a></p>
</li>
<li>
<p><a href="https://www.jesperdj.com/2018/09/30/jaxb-on-java-9-10-11-and-beyond/">JAXB on Java 9, 10, 11 and beyond</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/26413431/which-artifacts-should-i-use-for-jaxb-ri-in-my-maven-project">JAXB Artifacts</a></p>
</li>
</ul>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="jee">3.21. JEE</h3>
<div class="paragraph">
<p>This section is about Java Enterprise Edition (JEE).
Regarding to our <a href="architecture#key-principles.asciidoc">key principles</a> we focus on open standards.
For Java this means that we consider official standards from Java Standard and Enterprise Edition as first choice for considerations.
Therefore we also decided to recommend <a href="guide-rest.asciidoc#jax-rs">JAX-RS</a> over <a href="https://spring.io/guides/gs/rest-service/">SpringMVC</a> as the latter is proprietary.
Only if an existing Java standard is <strong>not</strong> suitable for current demands such as Java Server Faces (JSF), we do not officially recommend it (while you are still free to use it if you have good reasons to do so).
In all other cases we officially suggest the according standard and use it in our guides, code-samples, sample application, modules, templates, etc.
Examples for such standards are <a href="guide-jpa.asciidoc">JPA</a>, <a href="guide-rest.asciidoc#jax-rs">JAX-RS</a>, <a href="guide-soap.asciidoc#jax-ws">JAX-WS</a>, <a href="guide-dependency-injection.asciidoc">JSR330</a>, <a href="guide-access-control.asciidoc">JSR250</a>, <a href="guide-xml.asciidoc#jaxb">JAX-B</a>, etc.</p>
</div>
<div class="sect3">
<h4 id="application-server">3.21.1. Application-Server</h4>
<div class="paragraph">
<p>We designed everything based on standards to work with different technology stacks and servlet containers.
However, we strongly encourage to use modern and leightweight frameworks such as <a href="spring.asciidoc">spring</a> or <a href="quarkus.asciidoc">quarkus</a>.
You are free to decide for a JEE application server but here is a list of good reasons for our decision:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Up-to-date</strong></p>
<div class="paragraph">
<p>With spring or quarkus you easily keep up to date with evolving technologies (microservices, reactive, NoSQL, etc.).
Most application servers put you in a jail with old legacy technology.
In many cases you are even forced to use a totally outdated version of java (JVM/JDK).
This may even cause severe IT-Security vulnerabilities but with expensive support you might get updates.
Also with leightweight open-source frameworks you need to be aware that for IT-security you need to update recently what can cost quite a lot of additional maintenance effort.</p>
</div>
</li>
<li>
<p><strong>Development speed</strong></p>
<div class="paragraph">
<p>With spring-boot you can implement and especially test your individual logic very fast. Starting the app in your IDE is very easy, fast, and realistic (close to production). You can easily write JUnit tests that startup your server application to e.g. test calls to your remote services via HTTP fast and easy. For application servers you need to bundle and deploy your app what takes more time and limits you in various ways. We are aware that this has improved in the past but also spring continuously improves and is always way ahead in this area. Further, with spring you have your configurations bundled together with the code in version control (still with ability to handle different environments) while with application servers these are configured externally and can not be easily tested during development.</p>
</div>
</li>
<li>
<p><strong>Documentation</strong></p>
<div class="paragraph">
<p>Spring and also quarkus have an extremely open and active community.
There is documentation for everything available for free on the web.
You will find solutions to almost any problem on platforms like stackoverflow.
If you have a problem you are only a google search away from your solution.
This is very much different for proprietary application server products.</p>
</div>
</li>
<li>
<p><strong>Helpful Exception Messages</strong></p>
<div class="paragraph">
<p>Especially spring is really great for developers on exception messages.
If you do something wrong you get detailed and helpful messages that guide you to the problem or even the solution.
This is not as great in application servers.</p>
</div>
</li>
<li>
<p><strong>Future-proof</strong></p>
<div class="paragraph">
<p>Spring has evolved really awesome over time.
Since its 1.0 release in 2004 spring has continuously been improved and always caught up with important trends and innovations.
Even in critical situations, when the company behind it (interface21) was sold, spring went on perfectly.
Quarkus on the other hand is relatively new.
It does not have to carry a large legacy history and is therefore most state-of-the-art for modern projects esp. in cloud environments.
JEE went through a lot of trouble and crisis.
Just look at the EJB pain stories.
This happened often in the past and also recent.
See <a href="https://dzone.com/articles/java-ee-8-in-crisis">JEE 8 in crisis</a>.</p>
</div>
</li>
<li>
<p><strong>Free</strong></p>
<div class="paragraph">
<p>Spring and quarkus including their ecosystems are free and open-source.
It still perfectly integrates with commercial solutions for specific needs.
Most application servers are commercial and cost a lot of money.
As of today the ROI for this is of question.</p>
</div>
</li>
<li>
<p><strong>Cloud-native</strong></p>
<div class="paragraph">
<p>Quarkus is designed for cloud-native projects from the start.
With spring this is also available via <a href="spring.asciidoc#spring-native">spring-native</a>.
Using an application server will effectively prevent you from going to the cloud smoothly.</p>
</div>
</li>
<li>
<p><strong>Fun</strong></p>
<div class="paragraph">
<p>If you go to conferences or ask developers you will see that spring or quarkus is popular and fun.
If new developers are forced to use an old application server product they will be less motivated or even get frustrated.
Especially in today&#8217;s agile projects this is a very important aspect.
In the end you will get into trouble with maintenance on the long run if you rely on a proprietary application server.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Of course the vendors of application servers will tell you a different story.
This is simply because they still make a lot of money from their products.
We do not get paid from application servers nor from spring, quarkus or any other IT product company.
We are just developers who love to build great systems.
A good reason for application servers is that they combine a set of solutions to particular aspects to one product that helps to standardize your IT.
However, <a href="http://www.devonfw.com/">devonfw</a> fills exactly this gap for the spring and quarkus ecosystems in a very open and flexible way.
However, there is one important aspect that you need to understand and be aware of:</p>
</div>
<div class="paragraph">
<p>Some big companies decided for a specific application server as their IT strategy.
They may have hundreds of apps running with this application server.
All their operators and developers have learned a lot of specific skills for this product and are familiar with it.
If you are implementing yet another (small) app in this context it could make sense to stick with this application server.
However, also they have to be aware that with every additional app they increase their technical debt.
So actively help your customer and consult him to make the right choices for the future.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="validation">3.22. Validation</h3>
<div class="paragraph">
<p>Validation is about checking syntax and semantics of input data. Invalid data is rejected by the application.
Therefore validation is required in multiple places of an application. E.g. the <a href="guide-client-layer.asciidoc">GUI</a> will do validation for usability reasons to assist the user, early feedback and to prevent unnecessary server requests.
On the server-side validation has to be done for consistency and <a href="guide-security.asciidoc">security</a>.</p>
</div>
<div class="paragraph">
<p>In general we distinguish these forms of validation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>stateless validation</em> will produce the same result for given input at any time (for the same code/release).</p>
</li>
<li>
<p><em>stateful validation</em> is dependent on other states and can consider the same input data as valid in once case and as invalid in another.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="stateless-validation">3.22.1. Stateless Validation</h4>
<div class="paragraph">
<p>For regular, stateless validation we use the JSR303 standard that is also called bean validation (BV).
Details can be found in the <a href="http://beanvalidation.org/1.1/spec/">specification</a>.
As implementation we recommend <a href="http://hibernate.org/validator/">hibernate-validator</a>.</p>
</div>
<div class="sect4">
<h5 id="example-2">Example</h5>
<div class="paragraph">
<p>A description of how to enable BV for spring applications can be found in the relevant <a href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/htmlsingle/#validation-beanvalidation">Spring documentation</a>. A guide you can use to integrate validation in Quarkus applications can be found <a href="https://quarkus.io/guides/validation">here</a>. For a quick summary follow these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Make sure that hibernate-validator is located in the classpath by adding a dependency to the pom.xml.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Listing 9. <strong>spring</strong></div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;org.hibernate&lt;/groupId&gt;
      &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 10. <strong>quarkus</strong></div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
      &lt;artifactId&gt;quarkus-hibernate-validator&lt;/artifactId&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>For methods to validate go to their declaration and add constraint annotations to the method parameters.</p>
<div class="paragraph">
<p><em>In spring applications you can add the <code>@Validated</code> annotation to the implementation (spring bean) to be validated (this is an annotation of the spring framework, so it`s not available in the Quarkus context). The standard use case is to annotate the logic layer implementation, i.e. the use case implementation or component facade in case of simple logic layer pattern. Thus, the validation will be executed for service requests as well as batch processing.</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>@Valid annotation to the arguments to validate (if that class itself is annotated with constraints to check).</p>
</li>
<li>
<p>@NotNull for required arguments.</p>
</li>
<li>
<p>Other constraints (e.g. @Size) for generic arguments (e.g. of type String or Integer). However, consider to create <a href="guide-datatype.asciidoc">custom datatypes</a> and avoid adding too much validation logic (especially redundant in multiple places).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Listing 11. <strong>BookingmanagementRestServiceImpl.java</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Validated
public class BookingmanagementRestServiceImpl implements BookingmanagementRestService {
  ...
  public BookingEto saveBooking(@Valid BookingCto booking) {
  ...</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Finally add appropriate validation constraint annotations to the fields of the ETO class.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Listing 12. <strong>BookingCto.java</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @Valid
  private BookingEto booking;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 13. <strong>BookingEto.java</strong></div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @NotNull
  @Future
  private Timestamp bookingDate;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A list with all bean validation constraint annotations available for hibernate-validator can be found <a href="http://docs.jboss.org/hibernate/stable/validator/reference/en-US/html_single/#table-spec-constraints">here</a>. In addition it is possible to configure custom constraints. Therefore it is necessary to implement a annotation and a corresponding validator. A description can also be found in the <a href="http://docs.spring.io/spring-framework/docs/current/spring-framework-reference/htmlsingle/#validation-beanvalidation-spring-constraints">Spring documentation</a> or with more details in the <a href="http://docs.jboss.org/hibernate/validator/4.3/reference/en-US/html/validator-customconstraints.html">hibernate documentation</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<strong>Bean Validation in Wildfly &gt;v8:</strong> Wildfly v8 is the first version of Wildfly implementing the JEE7 specification. It comes with bean validation based on <a href="https://samaxes.com/2014/04/jaxrs-beanvalidation-javaee7-wildfly/">hibernate-validator out of the box</a>. In case someone is running Spring in Wildfly for whatever reasons, the spring based annotation @Validated would duplicate bean validation at runtime and thus should be omitted.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="gui-integration">GUI-Integration</h5>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect4">
<h5 id="cross-field-validation">Cross-Field Validation</h5>
<div class="paragraph">
<p>BV has poor support for this. Best practice is to create and use beans for ranges, etc. that solve this. A bean for a range could look like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class Range&lt;V extends Comparable&lt;V&gt;&gt; {

  private V min;
  private V max;

  public Range(V min, V max) {

    super();
    if ((min != null) &amp;&amp; (max != null)) {
      int delta = min.compareTo(max);
      if (delta &gt; 0) {
        throw new ValueOutOfRangeException(null, min, min, max);
      }
    }
    this.min = min;
    this.max = max;
  }

  public V getMin() ...
  public V getMax() ...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="stateful-validation">3.22.2. Stateful Validation</h4>
<div class="paragraph">
<p>For complex and stateful business validations we do not use BV (possible with groups and context, etc.) but follow KISS and just implement this on the server in a straight forward manner.
An example is the deletion of a table in the example application. Here the state of the table must be checked first:</p>
</div>
<div class="paragraph">
<p><strong>BookingmanagementImpl.java</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  private void sendConfirmationEmails(BookingEntity booking) {

    if (!booking.getInvitedGuests().isEmpty()) {
      for (InvitedGuestEntity guest : booking.getInvitedGuests()) {
        sendInviteEmailToGuest(guest, booking);
      }
    }

    sendConfirmationEmailToHost(booking);
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementing this small check with BV would be a lot more effort.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="bean-mapping">3.23. Bean-Mapping</h3>
<div class="paragraph">
<p>For decoupling, you sometimes need to create separate objects (beans) for a different view. E.g. for an external service, you will use a <a href="guide-transferobject.asciidoc">transfer-object</a> instead of the <a href="guide-jpa.asciidoc#entity">persistence entity</a> so internal changes to the entity do not implicitly change or break the service.</p>
</div>
<div class="paragraph">
<p>Therefore you have the need to map similar objects what creates a copy. This also has the benefit that modifications to the copy have no side-effect on the original source object. However, to implement such mapping code by hand is very tedious and error-prone (if new properties are added to beans but not to mapping code):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public UserEto mapUser(UserEntity source) {
  UserEto target = new UserEto();
  target.setUsername(source.getUsername());
  target.setEmail(source.getEmail());
  ...
  return target;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore we are using a <code>BeanMapper</code> for this purpose that makes our lives a lot easier.
There are several bean mapping frameworks with different approaches.</p>
</div>
<div class="paragraph">
<p>For a <a href="spring.asciidoc">devon4j-spring</a> application we recommend Orika, follow <a href="spring/guide-beanmapping-spring.asciidoc">Spring Bean-Mapping</a> for an introduction to Orika and Dozer in a devon4j-spring context application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
devon4j started with <a href="http://dozer.sourceforge.net/">Dozer</a> as framework for Spring applications and still supports it. However, we now recommend Orika (for new projects) as it is much faster (see <a href="https://www.baeldung.com/java-performance-mapping-frameworks#2-orika">Performance of Java Mapping Frameworks</a>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For a <a href="quarkus.asciidoc">Quarkus</a> application we recommend Mapstruct, follow <a href="quarkus/guide-beanmapping-quarkus.asciidoc">Quarkus Bean-Mapping</a> for an introduction to Mapstruct in a quarkus context application.</p>
</div>
<!-- toc disabled -->
</div>
<div class="sect2">
<h3 id="lombok-2">3.24. Lombok</h3>
<div class="paragraph">
<p><a href="https://projectlombok.org/">Lombok</a> is a library that works with an annotation processor and will generate code for you to save you some time and reduce the amount of boilerplate code in your project. Lombok can generate getter and setter, equals methods, automate your logging variables for your classes, and more. Follow the <a href="https://projectlombok.org/features/all">list of all the features</a> provided by Lombok to get an overview.</p>
</div>
<div class="sect3">
<h4 id="lombok-dependency">3.24.1. Lombok Dependency</h4>
<div class="paragraph">
<p>To get access to the Lombok library just add the following dependency to the POM.xml.</p>
</div>
<div class="paragraph">
<p>The Lombok dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
	&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
	&lt;artifactId&gt;lombok&lt;/artifactId&gt;
	&lt;version&gt;1.18.20&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To get Lombok working with your current IDE you should also install the Lombok addon. Follow the <a href="https://projectlombok.org/setup/eclipse">Eclipse installation guide</a>, there are also guides for other supported IDEs.</p>
</div>
</div>
<div class="sect3">
<h4 id="lombok-with-mapstruct">3.24.2. Lombok with Mapstruct</h4>
<div class="paragraph">
<p>MapStruct takes advantage of generated getters, setters, and constructors from Lombok and uses them to
generate the mapper implementations. Lombok is also an annotation processor and since version 1.18.14 both frameworks are working together. Just add the <code>lombok-mapstruct-binding</code> to your POM.xml.</p>
</div>
<div class="paragraph">
<p>The Lombok annotation processor and the <code>lombok-mapstruct-binding</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
	&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
	&lt;artifactId&gt;lombok-mapstruct-binding&lt;/artifactId&gt;
	&lt;version&gt;0.2.0&lt;/version&gt;
&lt;/dependency&gt;

&lt;plugin&gt;
	&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
	&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
	&lt;version&gt;3.8.1&lt;/version&gt;
	&lt;configuration&gt;
		&lt;source&gt;1.8&lt;/source&gt;
		&lt;target&gt;1.8&lt;/target&gt;
		&lt;annotationProcessorPaths&gt;
			&lt;path&gt;
				&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
				&lt;artifactId&gt;lombok&lt;/artifactId&gt;
				&lt;version&gt;1.18.4&lt;/version&gt;
			&lt;/path&gt;
			&lt;path&gt;
				&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
				&lt;artifactId&gt;lombok-mapstruct-binding&lt;/artifactId&gt;
				&lt;version&gt;0.2.0&lt;/version&gt;
			&lt;/path&gt;
		&lt;/annotationProcessorPaths&gt;
	&lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In our <a href="https://github.com/devonfw-sample/devon4quarkus-reference">quarkus reference project</a> you can get a look into the usage of both frameworks.</p>
</div>
</div>
<div class="sect3">
<h4 id="lombok-usage">3.24.3. Lombok Usage</h4>
<div class="paragraph">
<p>Lombok can be used like any other annotation processor and will be shown in the simple example below to generate getter and setter for a <em>Product</em> Entity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Getter
@Setter
public class Product{

    private String title;
    private String description;
    private BigDecimal price;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For advanced Lombok usage follow the <a href="https://www.baeldung.com/intro-to-project-lombok">Baeldung Lombok guide</a> or just read the <a href="https://projectlombok.org/api/">Lombok javadoc</a></p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
<div class="sect2">
<h3 id="openapi">3.25. OpenAPI</h3>
<div class="paragraph">
<p>The <a href="https://spec.openapis.org/oas/latest.html">OpenAPI Specification (OAS)</a> defines a standard for describing RESTful web services in a machine- and human-readable format. OpenAPI allows REST APIs to be defined in a uniform manner.
Technically, an OpenAPI document is written in YAML or JSON format. The specification defines the structure of a REST API by describing attributes such as path information, response codes, and return types. Some examples can be found <a href="https://github.com/OAI/OpenAPI-Specification/tree/main/examples/v3.0">here</a>.
Apart from documenting the API, this schema then also acts as a contract between provider and consumers, guaranteeing interoperability between various technologies.</p>
</div>
<div class="paragraph">
<p>OpenAPI is often used in combination with <a href="https://swagger.io/">Swagger</a>. Swagger is a set of tools build around OpenAPI, that help developers to design and document their REST APIs.
The most common tool is the <a href="https://swagger.io/tools/swagger-ui/">Swagger UI</a>, which uses the OpenAPI specification to create a graphical interface of the REST API that you can also interact with. Check out the <a href="https://editor.swagger.io/">Swagger online editor</a> to get a feeling for it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Swagger and OpenAPI: Swagger is a former specification, based on which the OpenAPI was created. Swagger 2.0 is still commonly used for describing APIs. OpenAPI is an open-source collaboration and it started from version 3.0.0(semver)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are many tools that work with OpenAPI: code generators, documentation tools, validators etc.</p>
</div>
<div class="sect3">
<h4 id="openapi-generation">3.25.1. OpenAPI generation</h4>
<div class="paragraph">
<p>There are several extensions you can use in your project to automatically generate the OpenAPI specifications and Swagger UI from your REST API (code-first approach). devon4j recommends the following two extensions/plugins to use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Smallrye OpenAPI extension</p>
</li>
<li>
<p>ServicedocGen maven plugin</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="smallrye-openapi">Smallrye OpenAPI</h5>
<div class="paragraph">
<p>Quarkus provides OpenAPI support through Smallrye OpenAPI extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
  &lt;artifactId&gt;quarkus-smallrye-openapi&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After adding the extension to your project, you can access the Swagger UI by navigating to <code>/q/swagger-ui</code>.</p>
</div>
<div class="paragraph">
<p>The OpenAPI specification can be accessed by requesting <code>/q/openapi</code>.</p>
</div>
<div class="paragraph">
<p>Smallrye OpenAPI is compliant with <a href="https://github.com/eclipse/microprofile-open-api">MicroProfile OpenAPI</a>. You can add MicroProfile annotations to further describe your REST endpoints and extend the OpenAPI documentation.
More information for this can be found <a href="https://quarkus.io/blog/openapi-for-everyone/#openapi">here</a> or <a href="https://download.eclipse.org/microprofile/microprofile-open-api-1.0/microprofile-openapi-spec.html#_documentation_mechanisms">here</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Quarkus recommends using this extension and you can document your APIs in great detail by using the MicroProfile annotations. The downside to this is that using these annotations will blow up your code and you will have some duplicate information in it.
If you don&#8217;t want to specify the REST API again with all this annotation based information, we also recommend taking a look at the ServicedocGen Maven plugin for your Quarkus applications when implementing JAX-RS APIs.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="servicedocgen-maven-plugin">ServicedocGen Maven Plugin</h5>
<div class="paragraph">
<p>The <a href="https://github.com/mojohaus/servicedocgen-maven-plugin">ServicedocGen maven plugin</a> can be used within both Spring and Quarkus applications.
It works a bit different then the Smallrye extensions mentioned above. The plugin analysis the REST API and it&#8217;s JavaDoc and then generate the OpenAPI specification and the Swagger UI as static files. So no Swagger or MicroProfile annotations have to be added.</p>
</div>
<div class="paragraph">
<p>The plugin can be configured in the pom.xml file of your application as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
      &lt;artifactId&gt;servicedocgen-maven-plugin&lt;/artifactId&gt;
      &lt;version&gt;1.0.0&lt;/version&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;goals&gt;
            &lt;goal&gt;generate&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
      &lt;configuration&gt;
        &lt;descriptor&gt;
          &lt;info&gt;
            &lt;title&gt;...&lt;/title&gt;
            &lt;description&gt;...&lt;/description&gt;
          &lt;/info&gt;
          &lt;host&gt;...&lt;/host&gt;
          &lt;port&gt;...&lt;/port&gt;
          &lt;basePath&gt;...&lt;/basePath&gt;
          &lt;schemes&gt;
            &lt;scheme&gt;...&lt;/scheme&gt;
          &lt;/schemes&gt;
        &lt;/descriptor&gt;
      &lt;/configuration&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the configuration section you have to define additional information to generate the OpenAPI specification correctly. An example can be found in our <a href="https://github.com/devonfw-sample/devon4quarkus-reference/blob/master/pom.xml">Quarkus reference application</a>.
When building the application, an OpenApi.yaml and a SwaggerUI.html file are created in the <code>/target/site</code> folder. To make the Swagger UI available in the browser, the file must be served by some servlet.</p>
</div>
<div style="page-break-after: always;"></div>
<!-- toc disabled -->
</div>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>← Previous: <a href="externalized-configuration.html">Externalized Configuration</a> | ↑ Up: <a href="configuration.html">Configuration</a> | ⌂ Home: <a href="devon4j.html">Java</a> | Next: <a href="spring.html">Spring</a> →</p>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. "Stammdaten" in German.
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-03-16 13:33:41 +0100
</div>
</div>
</body>
</html>